// https://github.com/arose/ngl/ LICENSE
'use strict';"function"===typeof importScripts||HTMLCanvasElement.prototype.toBlob||(HTMLCanvasElement.prototype.toBlob=function(){return function(a,b,c){b=this.toDataURL(b,c);if(-1===b.indexOf(";base64,"))c=b.split(","),b=c[0].split(":")[1],c=decodeURIComponent(c[1]),b=new Blob([c],{type:b});else{c=b.split(";base64,");b=c[0].split(":")[1];c=window.atob(c[1]);for(var d=c.length,e=new Uint8Array(d),f=0;f<d;++f)e[f]=c.charCodeAt(f);b=new Blob([e],{type:b})}a(b)}}());
Number.isInteger||(Number.isInteger=function(a){return"number"===typeof a&&isFinite(a)&&-9007199254740992<a&&9007199254740992>a&&Math.floor(a)===a});
Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(a,b){if(void 0===a||null===a)throw new TypeError("Cannot convert first argument to object");for(var c=Object(a),d=!1,e,f=1;f<arguments.length;f++){var g=arguments[f];if(void 0!==g&&null!==g){for(var h=Object.keys(Object(g)),k=0,l=h.length;k<l;k++){var n=h[k];try{var m=Object.getOwnPropertyDescriptor(g,n);void 0!==m&&m.enumerable&&(c[n]=g[n])}catch(q){d||(d=!0,e=q)}}if(d)throw e;}}return c}});
Object.values=function(a){var b=[],c;for(c in a)a.hasOwnProperty(c)&&b.push(a[c]);return b};var NGL={REVISION:"1dev",EPS:1E-7,disableImpostor:!1,indexUint16:!1,LeftMouseButton:1,MiddleMouseButton:2,RightMouseButton:3,SideTypes:{}};NGL.SideTypes[THREE.FrontSide]="front";NGL.SideTypes[THREE.BackSide]="back";NGL.SideTypes[THREE.DoubleSide]="double";NGL.GET=function(a){if(a=(new RegExp(a+"=([^&#=]*)")).exec(window.location.search))return decodeURIComponent(a[1])};
NGL.createObject=function(a,b){var c=Object.create(a),d;for(d in b)b.hasOwnProperty(d)&&(c[d]=b[d]);return c};NGL.download=function(a,b){if(a){b=b||"download";var c=document.createElement("a");c.style.display="hidden";document.body.appendChild(c);c.href=a instanceof Blob?URL.createObjectURL(a):a;c.download=b;c.target="_blank";c.click();document.body.removeChild(c);a instanceof Blob&&URL.revokeObjectURL(a)}else console.warn("NGL.download: no data given")};
NGL.unicodeHelper=function(){var a={"{alpha}":"\u03b1","{beta}":"\u03b2","{gamma}":"\u03b3","{dot}":"\u00b7","{bullet}":"\u2022"},b=Object.keys(a).join("|"),c=new RegExp("("+b+")","gi");return function(b){return b.replace(c,function(b,c,d,h,k){return a[String(b)]})}}();NGL.getFileInfo=function(a){a=a instanceof File?a.name:a;return{path:a,name:a.replace(/^.*[\\\/]/,""),ext:a.split(".").pop().toLowerCase()}};
NGL.makeObjectSignals=function(a){var b={};Object.keys(a.signals).forEach(function(a){b[a]=new signals.Signal});return b};NGL.ObjectMetadata=function(){};NGL.ObjectMetadata.test=function(a,b,c){a=a||{};return b&&a.repr&&(Array.isArray(a.repr)&&-1===a.repr.indexOf(b.name)||!Array.isArray(a.repr)&&a.repr!==b.name)||a.tag&&(Array.isArray(a.tag)&&-1===a.tag.indexOf(b.name)||!Array.isArray(a.tag)&&a.tag!==b.name)||c&&a.comp&&a.comp!==c.name&&a.comp!==c.id?!1:!0};
NGL.ObjectMetadata.prototype={apply:function(a){a.setName=NGL.ObjectMetadata.prototype.setName;a.addTag=NGL.ObjectMetadata.prototype.addTag;a.removeTag=NGL.ObjectMetadata.prototype.removeTag;a.setTags=NGL.ObjectMetadata.prototype.setTags;a.tags=[];a.signals.nameChanged=null},setName:function(a){this.name=a;this.signals.nameChanged.dispatch(a)},addTag:function(a){},removeTag:function(a){},setTags:function(a){this.tags=arguments||[]}};
NGL.Spline=function(a){this.fiber=a;this.size=a.residueCount-2;this.traceAtomname=a.traceAtomname;this.directionAtomname1=a.directionAtomname1;this.directionAtomname2=a.directionAtomname2;this.tension=(this.isNucleic=this.fiber.residues[0].isNucleic())?.5:.9};
NGL.Spline.prototype={interpolate:function(a,b,c,d,e,f){a=(c-a)*f;d=(d-b)*f;f=e*e;return(2*b-2*c+a+d)*e*f+(-3*b+3*c-2*a-d)*f+a*e+b},getSubdividedColor:function(a,b){var c=this.size-1,d=this.traceAtomname,e=new Float32Array(c*a*3+3),f=new Float32Array(c*a*3+3),g=new NGL.ColorFactory(b,this.fiber.structure),h=0,k,l,n,m,q,s,p,r,u;this.fiber.eachResidueN(4,function(b,c,y,w){n=Math.ceil(a/2);m=c.getAtomByName(d);q=g.atomColor(m);s=m.globalindex+1;for(k=0;k<n;++k)l=h+3*k,e[l+0]=(q>>16&255)/255,e[l+1]=(q>>
8&255)/255,e[l+2]=(q&255)/255,f[l+0]=(s>>16&255)/255,f[l+1]=(s>>8&255)/255,f[l+2]=(s&255)/255;p=y.getAtomByName(d);r=g.atomColor(p);u=p.globalindex+1;for(k=n;k<a;++k)l=h+3*k,e[l+0]=(r>>16&255)/255,e[l+1]=(r>>8&255)/255,e[l+2]=(r&255)/255,f[l+0]=(u>>16&255)/255,f[l+1]=(u>>8&255)/255,f[l+2]=(u&255)/255;h+=3*a});e[c*a*3+0]=e[c*a*3-3];e[c*a*3+1]=e[c*a*3-2];e[c*a*3+2]=e[c*a*3-1];f[c*a*3+0]=f[c*a*3-3];f[c*a*3+1]=f[c*a*3-2];f[c*a*3+2]=f[c*a*3-1];return{color:e,pickingColor:f}},getSubdividedPosition:function(a,
b){isNaN(b)&&(b=this.tension);return{position:this.getPosition(a,b)}},getSubdividedOrientation:function(a,b){isNaN(b)&&(b=this.tension);var c=this.getTangent(a,b),d=this.getNormals(a,b,c);return{tangent:c,normal:d.normal,binormal:d.binormal}},getSubdividedSize:function(a,b,c){var d=this.traceAtomname,e=new Float32Array((this.size-1)*a+1),f=new NGL.RadiusFactory(b,c),g=0,h,k,l,n,m,q;this.fiber.eachResidueN(4,function(b,c,r,u){k=c.getAtomByName(d);l=r.getAtomByName(d);n=f.atomRadius(k);m=f.atomRadius(l);
for(h=0;h<a;++h)q=h/a,e[g+h]=(1-q)*n+q*m;g+=a});e[g]=e[g-1];return{size:e}},getPosition:function(a,b,c){isNaN(b)&&(b=this.tension);c||(c=this.traceAtomname);var d=this.interpolate,e=new Float32Array((this.size-1)*a*3+3),f=0,g=1/a,h,k,l,n,m,q,s;this.fiber.eachResidueN(4,function(p,r,u,x){n=p.getAtomByName(c);m=r.getAtomByName(c);q=u.getAtomByName(c);s=x.getAtomByName(c);for(h=0;h<a;++h)l=g*h,k=f+3*h,e[k+0]=d(n.x,m.x,q.x,s.x,l,b),e[k+1]=d(n.y,m.y,q.y,s.y,l,b),e[k+2]=d(n.z,m.z,q.z,s.z,l,b);f+=3*a});
q.positionToArray(e,f);return e},getTangent:function(a,b,c){isNaN(b)&&(b=this.tension);c||(c=this.traceAtomname);var d=this.interpolate,e=new THREE.Vector3,f=new THREE.Vector3,g=new Float32Array((this.size-1)*a*3+3),h=0,k=1/a,l,n,m,q,s,p,r,u,x;this.fiber.eachResidueN(4,function(t,y,w,A){p=t.getAtomByName(c);r=y.getAtomByName(c);u=w.getAtomByName(c);x=A.getAtomByName(c);for(l=0;l<a;++l)m=k*l,q=m-1E-4,s=m+1E-4,n=h+3*l,0>q&&(q=0),1<s&&(s=1),e.x=d(p.x,r.x,u.x,x.x,q,b),e.y=d(p.y,r.y,u.y,x.y,q,b),e.z=d(p.z,
r.z,u.z,x.z,q,b),f.x=d(p.x,r.x,u.x,x.x,s,b),f.y=d(p.y,r.y,u.y,x.y,s,b),f.z=d(p.z,r.z,u.z,x.z,s,b),f.sub(e).normalize(),f.toArray(g,n);h+=3*a});f.toArray(g,h);return g},getNormals:function(a,b,c){var d=this.interpolate,e=this.traceAtomname,f=this.directionAtomname1,g=this.directionAtomname2,h=this.isNucleic,k=this.size-1,l=new Float32Array(k*a*3+3),n=new Float32Array(k*a*3+3),m=new THREE.Vector3,q=new THREE.Vector3,s=new THREE.Vector3,p=new THREE.Vector3,r=new THREE.Vector3,u=new THREE.Vector3,x=new THREE.Vector3,
t=new THREE.Vector3,y=new THREE.Vector3,w=new THREE.Vector3;new THREE.Vector3;var A=new THREE.Vector3,z=new THREE.Vector3,v=new THREE.Vector3,B=new THREE.Vector3,D=new THREE.Vector3,G=new THREE.Vector3,C=new THREE.Vector3,F=new THREE.Vector3,H=0,O=1/a,K=!0,M=Math.ceil(a/2),E,N,I;this.fiber.eachResidueN(4,function(k,S,Q,P){K?(K=!1,y.set(0,0,1),A.copy(k.getAtomByName(f)),z.copy(S.getAtomByName(f)),v.copy(Q.getAtomByName(f)),D.copy(k.getAtomByName(g)),G.copy(S.getAtomByName(g)),C.copy(Q.getAtomByName(g)),
s.subVectors(D,A),p.subVectors(G,z),0>s.dot(p)&&(p.multiplyScalar(-1),G.addVectors(z,p)),r.subVectors(C,v),0>p.dot(r)&&(r.multiplyScalar(-1),C.addVectors(v,r))):(A.copy(z),z.copy(v),v.copy(B),D.copy(G),G.copy(C),C.copy(F),r.copy(u));B.copy(P.getAtomByName(f));F.copy(P.getAtomByName(g));u.subVectors(F,B);0>r.dot(u)&&(u.multiplyScalar(-1),F.addVectors(B,u));for(E=0;E<a;++E)N=H+3*E,e===f?x.copy(y):(h||(N+=3*M),I=O*E,m.x=d(A.x,z.x,v.x,B.x,I,b),m.y=d(A.y,z.y,v.y,B.y,I,b),m.z=d(A.z,z.z,v.z,B.z,I,b),q.x=
d(D.x,G.x,C.x,F.x,I,b),q.y=d(D.y,G.y,C.y,F.y,I,b),q.z=d(D.z,G.z,C.z,F.z,I,b),x.subVectors(q,m).normalize()),t.fromArray(c,N),w.crossVectors(x,t).normalize(),w.toArray(n,N),y.crossVectors(t,w).normalize(),y.toArray(l,N);H+=3*a});if(e===f||h)w.toArray(n,H),y.toArray(l,H);else for(w.fromArray(n,3*M),y.fromArray(l,3*M),E=0;E<M;++E)w.toArray(n,3*E),y.toArray(l,3*E);return{normal:l,binormal:n}}};NGL.Helixorient=function(a){this.fiber=a;this.traceAtomname=a.traceAtomname;this.size=a.residueCount};
NGL.Helixorient.prototype={getFiber:function(a,b){var c=this.getPosition().center,d,e,f,g,h,k=[],l=c.length/3;for(d=0;d<l;++d){e=this.fiber.residues[d];h=e.getAtomByName(this.traceAtomname);g=new NGL.Residue;f=new NGL.Atom(g,h.globalindex);g.addAtom(f);g.resname=e.resname;g.index=e.index;g.chain=e.chain;e=3*d;f.positionFromArray(c,e);if(a){var n,m,q,s=Math.min(a,d,l-d-1);for(m=1;m<=s;++m)n=3*m,q=(s+1-m)/(s+1),f.x+=q*c[e-n+0]+q*c[e+n+0],f.y+=q*c[e-n+1]+q*c[e+n+1],f.z+=q*c[e-n+2]+q*c[e+n+2];f.x/=s+
1;f.y/=s+1;f.z/=s+1}f.atomname=h.atomname;f.index=h.index;f.resname=h.resname;f.chainname=h.chainname;f.bfactor=h.bfactor;f.ss=h.ss;k.push(g);!b||0!==d&&d!==l-1||k.push(g)}return new NGL.Fiber(k,this.fiber.structure)},getColor:function(a){var b=this.size,c=this.traceAtomname,d=new Float32Array(3*b),e=new Float32Array(3*b),f=new NGL.ColorFactory(a),g=0,h,k;this.fiber.eachResidue(function(a){h=a.getAtomByName(c);f.atomColor(h);f.atomColorToArray(h,d,g);k=h.globalindex+1;e[g+0]=(k>>16&255)/255;e[g+1]=
(k>>8&255)/255;e[g+2]=(k&255)/255;g+=3});return{color:d,pickingColor:e}},getSize:function(a,b){var c=this.traceAtomname,d=new Float32Array(this.size),e=new NGL.RadiusFactory(a,b),f=0,g;this.fiber.eachResidue(function(a){g=a.getAtomByName(c);d[f]=e.atomRadius(g);f+=1});return{size:d}},getPosition:function(){var a=this.traceAtomname,b=0,c=this.size,d=new Float32Array(3*c),e=new Float32Array(3*c),f=new Float32Array(c),g=new Float32Array(c),h=new Float32Array(c),k=new Float32Array(c),l=new Float32Array(3*
c),n,m,q,s,p,r,u,x,t=new THREE.Vector3,y=new THREE.Vector3,w=new THREE.Vector3,A=new THREE.Vector3,z=new THREE.Vector3,v=new THREE.Vector3,B=new THREE.Vector3,D=new THREE.Vector3,G=new THREE.Vector3,C=new THREE.Vector3;new THREE.Vector3;var F=new THREE.Vector3(0,0,0);this.fiber.eachResidueN(4,function(c,E,H,K){m=3*b;q=c.getAtomByName(a);s=E.getAtomByName(a);p=H.getAtomByName(a);r=K.getAtomByName(a);t.subVectors(s,q);y.subVectors(p,s);w.subVectors(r,p);A.subVectors(t,y);z.subVectors(y,w);D.crossVectors(A,
z).normalize();D.toArray(e,m);0<b&&(f[b]=D.angleTo(G));n=Math.cos(A.angleTo(z));k[b]=180/Math.PI*Math.acos(n);u=A.length();x=z.length();g[b]=Math.sqrt(x*u)/(2*(1-n));h[b]=Math.abs(y.dot(D));v.copy(A).multiplyScalar(g[b]/u);B.copy(z).multiplyScalar(g[b]/x);v.subVectors(s,v);B.subVectors(p,B);v.toArray(d,m+3);B.toArray(d,m+6);C.subVectors(q,F);C.toArray(l,m);b+=1;G.copy(D);F.copy(v)});var H=this.fiber.residues;D.fromArray(e,0);F.copy(H[0].getAtomByName(a));v.fromArray(d,3);v=NGL.Utils.pointVectorIntersection(F,
v,D);v.toArray(d,0);C.subVectors(F,v);C.toArray(l,0);v.fromArray(d,3*c-6);B.fromArray(d,3*c-9);D.subVectors(v,B).normalize();F.copy(H[c-1].getAtomByName(a));v=NGL.Utils.pointVectorIntersection(F,v,D);v.toArray(d,3*c-3);for(b=c-3;b<c;++b)v.fromArray(d,3*b),F.copy(H[b].getAtomByName(a)),C.subVectors(F,v),C.toArray(l,3*b);var H=new Float32Array(c),O=new Float32Array(c),K=new Float32Array(c),M=new Float32Array(c);H[1]=g[0];O[1]=k[0];K[1]=g[0];for(b=2;b<c-2;b++)H[b]=.5*(g[b-2]+g[b-1]),O[b]=.5*(k[b-2]+
k[b-1]),K[b]=.5*(h[b-2]+h[b-1]),v.fromArray(e,3*(b-2)),B.fromArray(e,3*(b-1)),M[b]=180/Math.PI*Math.acos(Math.cos(v.angleTo(B)));H[c-2]=g[c-4];O[c-2]=k[c-4];K[c-2]=h[c-4];var E=new Float32Array(3*c);NGL.Utils.copyArray(e,E,0,0,3);NGL.Utils.copyArray(e,E,0,3,3);for(b=2;b<c-2;b++)v.fromArray(e,3*(b-2)),B.fromArray(e,3*(b-1)),D.addVectors(B,v).multiplyScalar(.5).normalize(),D.toArray(E,3*b);NGL.Utils.copyArray(e,E,3*c-12,3*c-6,3);NGL.Utils.copyArray(e,E,3*c-12,3*c-3,3);return{center:d,axis:E,bending:M,
radius:H,rise:K,twist:O,resdir:l}}};NGL.Helix=function(){this.begin=new THREE.Vector3;this.end=new THREE.Vector3;this.axis=new THREE.Vector3;this.center=new THREE.Vector3;this.length=0;this.residues=[];this.size=0};
NGL.Helix.prototype={fromHelixbundleAxis:function(){var a=new THREE.Vector3;return function(b,c){this.begin.fromArray(b.begin,3*c);this.end.fromArray(b.end,3*c);this.axis.fromArray(b.axis,3*c);this.center.fromArray(b.center,3*c);this.length=a.subVectors(this.begin,this.end).length();this.residues=b.residue[c];this.size=this.residues.length;return this}}(),angleTo:function(){var a=new THREE.Vector3;return function(b){var c=a.crossVectors(this.axis,b.axis).length();b=this.axis.dot(b.axis);c=Math.atan2(c,
b);return 0>b?-c:c}}(),distanceTo:function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3;return function(d){this.crossingPoints(d,a,b);c.subVectors(b,a);return c.length()}}(),crossingPoints:function(){var a=new THREE.Vector3,b=new THREE.Vector3,c=new THREE.Vector3,d=new THREE.Vector3;return function(e,f,g){f||(f=new THREE.Vector3);g||(g=new THREE.Vector3);a.crossVectors(this.axis,e.axis);b.subVectors(e.begin,this.begin);var h=a.dot(a),k=c.crossVectors(b,e.axis).dot(a),l=d.crossVectors(b,
this.axis).dot(a);f.copy(this.axis).multiplyScalar(k/h).add(this.begin);g.copy(e.axis).multiplyScalar(l/h).add(e.begin);return[f,g]}}(),crossing:function(a){var b={},c=this.angleTo(a)/(Math.PI/180),d=this.crossingPoints(a),e=NGL.Utils.isPointOnSegment(d[0],this.begin,this.end)&&NGL.Utils.isPointOnSegment(d[1],a.begin,a.end),f=NGL.Utils.pointVectorIntersection(this.begin,a.begin,a.axis),g=NGL.Utils.pointVectorIntersection(this.end,a.begin,a.axis),h=NGL.Utils.pointVectorIntersection(a.begin,this.begin,
this.axis),k=NGL.Utils.pointVectorIntersection(a.end,this.begin,this.axis),l=NGL.Utils.isPointOnSegment(f,a.begin,a.end),n=NGL.Utils.isPointOnSegment(g,a.begin,a.end),m=NGL.Utils.isPointOnSegment(h,this.begin,this.end),q=NGL.Utils.isPointOnSegment(k,this.begin,this.end),s=[0,0,0,0];l&&n&&(s[0]=f.distanceTo(g));m&&q&&(s[1]=h.distanceTo(k));l&&!n&&(g.distanceTo(a.begin)<g.distanceTo(a.end)?s[2]=f.distanceTo(a.begin):s[2]=f.distanceTo(a.end));!l&&n&&(f.distanceTo(a.begin)<f.distanceTo(a.end)?s[2]=g.distanceTo(a.begin):
s[2]=g.distanceTo(a.end));m&&!q&&(k.distanceTo(this.begin)<k.distanceTo(this.end)?s[3]=h.distanceTo(this.begin):s[3]=h.distanceTo(this.end));!m&&q&&(h.distanceTo(this.begin)<h.distanceTo(this.end)?s[3]=k.distanceTo(this.begin):s[3]=k.distanceTo(this.end));var p=Math.max.apply(null,s),r=[l,n,m,q];if(e)b={distance:this.distanceTo(a),contact:!0,p1:d[0],p2:d[1]};else{d=[];if(120<c||60>c)d.push({distance:this.begin.distanceTo(f),contact:l,p1:this.begin,p2:f}),d.push({distance:this.end.distanceTo(g),contact:n,
p1:this.end,p2:g}),d.push({distance:a.begin.distanceTo(h),contact:m,p1:a.begin,p2:h}),d.push({distance:a.end.distanceTo(k),contact:q,p1:a.end,p2:k});0<p&&(120<c||60>c)&&(d.push({distance:this.begin.distanceTo(a.begin),contact:!0,p1:this.begin,p2:a.begin}),d.push({distance:this.begin.distanceTo(a.end),contact:!0,p1:this.begin,p2:a.end}),d.push({distance:this.end.distanceTo(a.begin),contact:!0,p1:this.end,p2:a.begin}),d.push({distance:this.end.distanceTo(a.end),contact:!0,p1:this.end,p2:a.end}));b.distance=
Infinity;d.forEach(function(a){a.contact&&a.distance<b.distance&&(b=a)})}return Object.assign({distance:Infinity,contact:!1,angle:c,onSegment:r,overlap:s,maxOverlap:p,lineContact:e},b)}};NGL.Helixbundle=function(a){this.fiber=a;this.traceAtomname=a.traceAtomname;this.helixorient=new NGL.Helixorient(a);this.position=this.helixorient.getPosition();this.size=a.residueCount};
NGL.Helixbundle.prototype={getFiber:function(a){},getColor:function(a){},getSize:function(a,b){},getAxis:function(a,b,c,d,e,f){a=a||30;b=b||2.5;c=void 0===c?!1:c;var g=this.position;d=new NGL.ColorFactory(d,this.fiber.structure);e=new NGL.RadiusFactory(e,f);var h,k,l=0,n=0,m=this.size,q=this.traceAtomname,s=this.fiber.residues,p=[],r=[],u=[],x=[],t=[],y=[],w=[],A=[],z=[];k=[];var v,B=new THREE.Vector3,D=new THREE.Vector3,G=new THREE.Vector3,C=new THREE.Vector3,z=!1;for(f=0;f<m;++f)h=s[f],G.fromArray(g.center,
3*f),f===m-1?z=!0:(k=s[f+1],C.fromArray(g.center,3*f+3),c&&h.ss!==k.ss?z=!0:G.distanceTo(C)>b?z=!0:g.bending[f]>a&&(z=!0)),z&&(4>f-l||(h=h.getAtomByName(q),z=g.axis.subarray(3*l+3,3*f),k=g.center.subarray(3*l,3*f+3),z=NGL.Utils.calculateMeanVector3(z).normalize(),v=NGL.Utils.calculateMeanVector3(k),B.fromArray(k),B=NGL.Utils.pointVectorIntersection(B,v,z),D.fromArray(k,k.length-3),D=NGL.Utils.pointVectorIntersection(D,v,z),z.subVectors(D,B),z.toArray(p,n),v.toArray(r,n),B.toArray(u,n),D.toArray(x,
n),d.atomColorToArray(h,t,n),k=h.globalindex+1,y[n+0]=(k>>16&255)/255,y[n+1]=(k>>8&255)/255,y[n+2]=(k&255)/255,w.push(e.atomRadius(h)),A.push(s.slice(l,f+1)),n+=3),l=f,z=!1);return{axis:new Float32Array(p),center:new Float32Array(r),begin:new Float32Array(u),end:new Float32Array(x),color:new Float32Array(t),pickingColor:new Float32Array(y),size:new Float32Array(w),residue:A}},getPosition:function(){}};NGL.HelixCrossing=function(a){this.helices=a};
NGL.HelixCrossing.prototype={getCrossing:function(a){a=a||12;for(var b=this.helices,c=[],d=[],e=[],f=[],g=[],h=0,k=0;k<b.length;++k){var l=b[k];c.push("H"+(k+1));l.center.toArray(d,3*k);for(var n=k+1;n<b.length;++n){var m=l.crossing(b[n]);m.contact&&m.distance<a&&(g.push({helix1:k+1,helix2:n+1,angle:m.angle,distance:m.distance,overlap:m.maxOverlap}),m.p1.toArray(e,3*h),m.p2.toArray(f,3*h),h+=1)}}return{helixLabel:c,helixCenter:d,begin:e,end:f,info:g}}};
NGL.ElementColors={H:16777215,HE:14286847,LI:13402367,BE:12779264,B:16758197,C:9474192,N:3166456,O:16715021,F:9494608,NE:11789301,NA:11230450,MG:9109248,AL:12560038,SI:1578E4,P:16744448,S:16777008,CL:2093087,AR:8442339,K:9388244,CA:4062976,SC:15132390,TI:12567239,V:10921643,CR:9083335,MN:10255047,FE:14706227,CO:15765664,NI:5296208,CU:13140019,ZN:8224944,GA:12750735,GE:6721423,AS:12419299,SE:16752896,BR:10889513,KR:6076625,RB:7351984,SR:65280,Y:9764863,ZR:9756896,NB:7586505,MO:5551541,TC:3907230,RU:2396047,
RH:687500,PD:27013,AG:12632256,CD:16767375,IN:10909043,SN:6717568,SB:10380213,TE:13924864,I:9699476,XE:9699476,CS:5707663,BA:51456,LA:7394559,CE:16777159,PR:14286791,ND:13107143,PM:10747847,SM:9437127,EU:6422471,GD:4587463,TB:3211207,DY:2097095,HO:65436,ER:58997,TM:54354,YB:48952,LU:43812,HF:5096191,TA:5089023,W:2200790,RE:2522539,OS:2516630,IR:1528967,PT:13684960,AU:16765219,HG:12105936,TL:10900557,PB:5724513,BI:10375093,PO:11230208,AT:7688005,RN:4358806,FR:4325478,RA:32E3,AC:7384058,TH:47871,PA:41471,
U:36863,NP:33023,PU:27647,AM:5528818,CM:7888099,BK:9064419,CF:10565332,ES:11739092,FM:11739066,MD:11734438,NO:12389767,LR:13041766,RF:13369433,DB:13697103,SG:14221381,BH:14680120,HS:15073326,MT:15400998,DS:16777215,RG:16777215,CN:16777215,UUT:16777215,FL:16777215,UUP:16777215,LV:16777215,UUH:16777215,D:16777152,T:16777120,"":16777215};
NGL.ResidueColors={ALA:9240460,ARG:124,ASN:16743536,ASP:10485826,CYS:16777072,GLN:16731212,GLU:6684672,GLY:16777215,HIS:7368959,ILE:19456,LEU:4546117,LYS:4671416,MET:12099650,PHE:5459026,PRO:5395026,SER:16740418,THR:12078080,TRP:5195264,TYR:9203788,VAL:16747775,ASX:16711935,GLX:16711935,ASH:16711935,GLH:16711935,A:10526975,G:16740464,I:8454143,C:16747595,T:10551200,U:16744576,DA:10526975,DG:16740464,DI:8454143,DC:16747595,DT:10551200,DU:16744576,"":16711935};
NGL.StructureColors={alphaHelix:16711808,"3_10Helix":10485888,piHelix:6291584,betaStrand:16762880,betaTurn:6324479,coil:16777215,dna:11403518,rna:16580962,carbohydrate:10921722,"":8421504};NGL.HelixTypes={1:"h",2:"h",3:"i",4:"h",5:"g",6:"h",7:"h",8:"h",9:"h",10:"h","":"h"};
NGL.VdwRadii={H:1.1,HE:1.4,LI:1.81,BE:1.53,B:1.92,C:1.7,N:1.55,O:1.52,F:1.47,NE:1.54,NA:2.27,MG:1.73,AL:1.84,SI:2.1,P:1.8,S:1.8,CL:1.75,AR:1.88,K:2.75,CA:2.31,SC:2.3,TI:2.15,V:2.05,CR:2.05,MN:2.05,FE:2.05,CO:2,NI:2,CU:2,ZN:2.1,GA:1.87,GE:2.11,AS:1.85,SE:1.9,BR:1.83,KR:2.02,RB:3.03,SR:2.49,Y:2.4,ZR:2.3,NB:2.15,MO:2.1,TC:2.05,RU:2.05,RH:2,PD:2.05,AG:2.1,CD:2.2,IN:2.2,SN:1.93,SB:2.17,TE:2.06,I:1.98,XE:2.16,CS:3.43,BA:2.68,LA:2.5,CE:2.48,PR:2.47,ND:2.45,PM:2.43,SM:2.42,EU:2.4,GD:2.38,TB:2.37,DY:2.35,
HO:2.33,ER:2.32,TM:2.3,YB:2.28,LU:2.27,HF:2.25,TA:2.2,W:2.1,RE:2.05,OS:2,IR:2,PT:2.05,AU:2.1,HG:2.05,TL:1.96,PB:2.02,BI:2.07,PO:1.97,AT:2.02,RN:2.2,FR:3.48,RA:2.83,AC:2,TH:2.4,PA:2,U:2.3,NP:2,PU:2,AM:2,CM:2,BK:2,CF:2,ES:2,FM:2,MD:2,NO:2,LR:2,RF:2,DB:2,SG:2,BH:2,HS:2,MT:2,DS:2,RG:2,CN:2,UUT:2,FL:2,UUP:2,LV:2,UUH:2,"":2};
NGL.CovalentRadii={H:.31,HE:.28,LI:1.28,BE:.96,B:.84,C:.76,N:.71,O:.66,F:.57,NE:.58,NA:1.66,MG:1.41,AL:1.21,SI:1.11,P:1.07,S:1.05,CL:1.02,AR:1.06,K:2.03,CA:1.76,SC:1.7,TI:1.6,V:1.53,CR:1.39,MN:1.39,FE:1.32,CO:1.26,NI:1.24,CU:1.32,ZN:1.22,GA:1.22,GE:1.2,AS:1.19,SE:1.2,BR:1.2,KR:1.16,RB:2.2,SR:1.95,Y:1.9,ZR:1.75,NB:1.64,MO:1.54,TC:1.47,RU:1.46,RH:1.42,PD:1.39,AG:1.45,CD:1.44,IN:1.42,SN:1.39,SB:1.39,TE:1.38,I:1.39,XE:1.4,CS:2.44,BA:2.15,LA:2.07,CE:2.04,PR:2.03,ND:2.01,PM:1.99,SM:1.98,EU:1.98,GD:1.96,
TB:1.94,DY:1.92,HO:1.92,ER:1.89,TM:1.9,YB:1.87,LU:1.87,HF:1.75,TA:1.7,W:1.62,RE:1.51,OS:1.44,IR:1.41,PT:1.36,AU:1.36,HG:1.32,TL:1.45,PB:1.46,BI:1.48,PO:1.4,AT:1.5,RN:1.5,FR:2.6,RA:2.21,AC:2.15,TH:2.06,PA:2,U:1.96,NP:1.9,PU:1.87,AM:1.8,CM:1.69,BK:1.6,CF:1.6,ES:1.6,FM:1.6,MD:1.6,NO:1.6,LR:1.6,RF:1.6,DB:1.6,SG:1.6,BH:1.6,HS:1.6,MT:1.6,DS:1.6,RG:1.6,CN:1.6,UUT:1.6,FL:1.6,UUP:1.6,LV:1.6,UUH:1.6,"":1.6};
NGL.guessElement=function(){var a="HCONSP".split(""),b=["NA","CL"];return function(c){c=c.trim().toUpperCase();parseInt(c.charAt(0))&&(c=c.substr(1));var d=c.length;if(0===d)return"";if(1===d)return c;if(2===d){if(-1!==b.indexOf(c))return c;if(-1!==a.indexOf(c[0]))return c[0]}return 3===d&&-1!==a.indexOf(c[0])?c[0]:4===d&&"H"===c[0]?"H":""}}();NGL.UnknownType=0;NGL.CgType=1;NGL.ProteinType=2;NGL.ProteinBackboneType=3;NGL.NucleicType=4;NGL.NucleicBackboneType=5;NGL.WaterType=6;
NGL.AA1={HIS:"H",ARG:"R",LYS:"K",ILE:"I",PHE:"F",LEU:"L",TRP:"W",ALA:"A",MET:"M",PRO:"P",CYS:"C",ASN:"N",VAL:"V",GLY:"G",SER:"S",GLN:"Q",TYR:"Y",ASP:"D",GLU:"E",THR:"T",UNK:""};NGL.nextGlobalAtomindex=0;
NGL.ColorFactory=function(a,b){this.type=a;if(this.structure=b)this.atomindexScale=chroma.scale(["red","orange","yellow","green","blue"]).mode("lch").domain([0,this.structure.atomCount]),this.residueindexScale=chroma.scale(["red","orange","yellow","green","blue"]).mode("lch").domain([0,this.structure.residueCount]),this.chainindexScale=chroma.scale("Spectral").mode("lch").domain([0,this.structure.chainCount]),this.modelindexScale=chroma.scale(["red","orange","yellow","green","blue"]).mode("lch").domain([0,
this.structure.modelCount]);this.chainNames="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";this.chainnameScale=chroma.scale("Spectral").mode("lch").domain([0,26])};NGL.ColorFactory.types={"":"",element:"by element",resname:"by residue name",ss:"by secondary structure",atomindex:"by atom index",residueindex:"by residue index",chainindex:"by chain index",modelindex:"by model index",picking:"by picking id",random:"random",color:"color"};
NGL.ColorFactory.prototype={atomColor:function(a){var b=this.type,c=NGL.ElementColors,d=NGL.ResidueColors,e=NGL.StructureColors,f=NGL.ElementColors[""],g=NGL.ResidueColors[""],h=NGL.StructureColors[""],k=this.atomindexScale,l=this.residueindexScale,n=this.chainindexScale,m=this.modelindexScale;switch(b){case "picking":a=a.globalindex+1;break;case "element":a=c[a.element]||f;break;case "resname":a=d[a.resname]||g;break;case "atomindex":a=k(a.index)._rgb;a=a[0]<<16|a[1]<<8|a[2];break;case "residueindex":a=
l(a.residue.index)._rgb;a=a[0]<<16|a[1]<<8|a[2];break;case "chainindex":a=void 0===a.residue.chain.chainname?this.chainnameScale(10*this.chainNames.indexOf(a.chainname))._rgb:n(a.residue.chain.index)._rgb;a=a[0]<<16|a[1]<<8|a[2];break;case "modelindex":a=m(a.residue.chain.model.index)._rgb;a=a[0]<<16|a[1]<<8|a[2];break;case "random":a=16777215*Math.random();break;case "ss":a="h"===a.ss?e.alphaHelix:"g"===a.ss?e["3_10Helix"]:"i"===a.ss?e.piHelix:"s"===a.ss?e.betaStrand:a.residue.isNucleic()?e.dna:
a.residue.isProtein()||"c"===a.ss?e.coil:h;break;case void 0:a=16777215;break;default:a=b}return a},atomColorToArray:function(a,b,c){a=this.atomColor(a);void 0===b&&(b=[]);void 0===c&&(c=0);b[c+0]=(a>>16&255)/255;b[c+1]=(a>>8&255)/255;b[c+2]=(a&255)/255;return b}};NGL.RadiusFactory=function(a,b){this.type=a;this.scale=b||1;this.max=10};NGL.RadiusFactory.types={"":"",vdw:"by vdW radius",covalent:"by covalent radius",ss:"by secondary structure",bfactor:"by bfactor",size:"size"};
NGL.RadiusFactory.prototype={atomRadius:function(a){var b=this.type,c=this.scale,d=NGL.VdwRadii,e=NGL.CovalentRadii,f=NGL.VdwRadii[""],g=NGL.CovalentRadii[""],h=["C3'","C3*","C4'","C4*","P"];switch(b){case "vdw":a=d[a.element]||f;break;case "covalent":a=e[a.element]||g;break;case "bfactor":a=a.bfactor||1;break;case "ss":a="h"===a.ss?.25:"g"===a.ss?.25:"i"===a.ss?.25:"s"===a.ss?.25:-1!==h.indexOf(a.atomname)?.4:.1;break;default:a=b||1}return Math.min(a*c,this.max)}};
NGL.LabelFactory=function(a,b){this.type=a;this.text=b||{}};NGL.LabelFactory.types={"":"",atomname:"atom name",resname:"residue name",resno:"residue no",res:"residue name + no",text:"text"};
NGL.LabelFactory.prototype={atomLabel:function(a){switch(this.type){case "atomname":a=a.atomname;break;case "resname":a=a.resname;break;case "resno":a=""+a.resno;break;case "res":a=(NGL.AA1[a.resname.toUpperCase()]||"")+a.resno;break;case "text":a=this.text[a.globalindex];break;default:a=a.qualifiedName()}return void 0===a?"":a}};NGL.AtomSet=function(a,b){this.atoms=[];this.bonds=[];a&&this.fromStructure(a,b)};
NGL.AtomSet.prototype={constructor:NGL.AtomSet,apply:function(a){a.getBoundingBox=NGL.AtomSet.prototype.getBoundingBox;a.atomPosition=NGL.AtomSet.prototype.atomPosition;a.atomColor=NGL.AtomSet.prototype.atomColor;a.atomRadius=NGL.AtomSet.prototype.atomRadius;a.atomCenter=NGL.AtomSet.prototype.atomCenter;a.atomIndex=NGL.AtomSet.prototype.atomIndex},addAtom:function(a){this.atoms.push(a);this.atomCount=this.atoms.length},fromStructure:function(a,b){var c=this;this.structure=a;this.selection=b;this.selection.signals.stringChanged.add(function(a){c.applySelection()});
this.applySelection()},applySelection:function(){var a=this.atoms=[];this.structure.eachAtom(function(b){a.push(b)},this.selection);this.atomCount=this.atoms.length;this.center=this.atomCenter();this._atomPosition=void 0;var b=this.bonds=[];this.structure.bondSet.eachBond(function(a){b.push(a)},this.selection);this.bondCount=this.bonds.length;this._bondPositionTo=this._bondPositionFrom=void 0},getBoundingBox:function(a){var b=new THREE.Box3,c=new THREE.Vector3,d=0,e=this.atomCount;if(a)for(var f=
a.test,d=0;d<e;++d)a=this.atoms[d],f(a)&&(c.copy(a),b.expandByPoint(c));else for(d=0;d<e;++d)c.copy(this.atoms[d]),b.expandByPoint(c);return b},eachAtom:function(a,b){if(b){var c=b.test;this.atoms.forEach(function(b){c(b)&&a(b)})}else this.atoms.forEach(a)},atomPosition:function(a){var b,c,d=0,e=this.atomCount;if(a)b=[],this.eachAtom(function(a){b[d+0]=a.x;b[d+1]=a.y;b[d+2]=a.z;d+=3},a),b=new Float32Array(b);else{b=this._atomPosition?this._atomPosition:new Float32Array(3*this.atomCount);for(a=0;a<
e;++a)c=this.atoms[a],b[d+0]=c.x,b[d+1]=c.y,b[d+2]=c.z,d+=3;this._atomPosition=b}return b},atomColor:function(a,b){var c,d,e=new NGL.ColorFactory(b,this.structure);d=a?[]:new Float32Array(3*this.atomCount);var f=0;this.eachAtom(function(a){c=e.atomColor(a);d[f+0]=(c>>16&255)/255;d[f+1]=(c>>8&255)/255;d[f+2]=(c&255)/255;f+=3},a);a&&(d=new Float32Array(d));return d},atomRadius:function(a,b,c){var d,e,f=new NGL.RadiusFactory(b,c);e=a?[]:new Float32Array(this.atomCount);d=0;this.eachAtom(function(a){e[d]=
f.atomRadius(a);d+=1},a);a&&(e=new Float32Array(e));return e},atomIndex:function(a){var b=[];this.eachAtom(function(a){b.push(a.index)},a);return b},atomCenter:function(){var a=new THREE.Box3,b=new THREE.Vector3;return function(c){var d=0,e=this.atomCount;a.makeEmpty();if(c)for(var f=c.test,d=0;d<e;++d)c=this.atoms[d],f(c)&&(b.copy(c),a.expandByPoint(b));else for(d=0;d<e;++d)b.copy(this.atoms[d]),a.expandByPoint(b);return a.center()}}(),eachBond:function(a,b){if(b=b||this.selection){var c=b.test;
this.bonds.forEach(function(b){c(b.atom1)&&c(b.atom2)&&a(b)})}else this.bonds.forEach(function(b){a(b)})},bondPosition:function(a,b){var c,d,e,f=0,g=this.bondCount;if(a)d=[],this.eachBond(function(a){b?(d[f+0]=a.atom1.x,d[f+1]=a.atom1.y,d[f+2]=a.atom1.z):(d[f+0]=a.atom2.x,d[f+1]=a.atom2.y,d[f+2]=a.atom2.z);f+=3},a),d=new Float32Array(d);else{d=[];b?this._bondPositionFrom&&(d=this._bondPositionFrom):this._bondPositionTo&&(d=this._bondPositionTo);for(c=0;c<g;++c)e=this.bonds[c],b?(d[f+0]=e.atom1.x,
d[f+1]=e.atom1.y,d[f+2]=e.atom1.z):(d[f+0]=e.atom2.x,d[f+1]=e.atom2.y,d[f+2]=e.atom2.z),f+=3;b?this._bondPositionFrom||(this._bondPositionFrom=new Float32Array(d)):this._bondPositionTo||(this._bondPositionTo=new Float32Array(d))}return d},bondColor:function(a,b,c){var d=0,e=[],f,g=new NGL.ColorFactory(c,this.structure);this.eachBond(function(a){f=g.atomColor(b?a.atom1:a.atom2);e[d+0]=(f>>16&255)/255;e[d+1]=(f>>8&255)/255;e[d+2]=(f&255)/255;d+=3},a);return new Float32Array(e)},bondRadius:function(a,
b,c,d){var e=0,f=[],g=new NGL.RadiusFactory(c,d);this.eachBond(function(a){f[e]=g.atomRadius(b?a.atom1:a.atom2);e+=1},a);return new Float32Array(f)}};NGL.BondSet=function(){this.bonds=[];this.bondCount=0};
NGL.BondSet.prototype={constructor:NGL.BondSet,addBond:function(a,b,c){var d=new NGL.Bond(a,b);c||(a.bonds.push(d),b.bonds.push(d));this.bonds.push(d);this.bondCount+=1},addBondIfConnected:function(a,b,c){a.connectedTo(b)&&this.addBond(a,b,c)},eachBond:function(a,b){if(b){var c=b.test;this.bonds.forEach(function(b){c(b.atom1)&&c(b.atom2)&&a(b)})}else this.bonds.forEach(function(b){a(b)})},bondPosition:NGL.AtomSet.prototype.bondPosition,bondColor:NGL.AtomSet.prototype.bondColor,bondRadius:NGL.AtomSet.prototype.bondRadius};
NGL.Bond=function(a,b,c){a.index<b.index?(this.atom1=a,this.atom2=b):(this.atom1=b,this.atom2=a);this.bondOrder=1};NGL.Bond.prototype={atom1:void 0,atom2:void 0,bondOrder:void 0,qualifiedName:function(){return this.atom1.index+"="+this.atom2.index}};NGL.Matrix=function(a,b){return new jsfeat.matrix_t(a,b,jsfeat.F32_t|jsfeat.C1_t)};
NGL.Superposition=function(a,b){var c;"function"===typeof a.eachAtom?c=a.atomCount:a instanceof Float32Array&&(c=a.length/3);var d=new NGL.Matrix(3,c),e=new NGL.Matrix(3,c);this.coords1t=new NGL.Matrix(c,3);this.coords2t=new NGL.Matrix(c,3);this.A=new NGL.Matrix(3,3);this.W=new NGL.Matrix(1,3);this.U=new NGL.Matrix(3,3);this.V=new NGL.Matrix(3,3);this.VH=new NGL.Matrix(3,3);this.R=new NGL.Matrix(3,3);this.tmp=new NGL.Matrix(3,3);this.c=new NGL.Matrix(3,3);this.c.data.set([1,0,0,0,1,0,0,0,-1]);this.prepCoords(a,
d);this.prepCoords(b,e);this._superpose(d,e)};
NGL.Superposition.prototype={_superpose:function(a,b){this.mean1=jsfeat.matmath.mean_rows(a);this.mean2=jsfeat.matmath.mean_rows(b);jsfeat.matmath.sub_rows(a,this.mean1);jsfeat.matmath.sub_rows(b,this.mean2);jsfeat.matmath.transpose(this.coords1t,a);jsfeat.matmath.transpose(this.coords2t,b);jsfeat.matmath.multiply_ABt(this.A,this.coords2t,this.coords1t);jsfeat.linalg.svd_decompose(this.A,this.W,this.U,this.V);jsfeat.matmath.invert_3x3(this.V,this.VH);jsfeat.matmath.multiply_3x3(this.R,this.U,this.VH);
0>jsfeat.matmath.mat3x3_determinant(this.R)&&(console.log("R not a right handed system"),jsfeat.matmath.multiply_3x3(this.tmp,this.c,this.VH),jsfeat.matmath.multiply_3x3(this.R,this.U,this.tmp))},prepCoords:function(a,b){var c=0,d=b.data;"function"===typeof a.eachAtom?a.eachAtom(function(a){d[c+0]=a.x;d[c+1]=a.y;d[c+2]=a.z;c+=3}):a instanceof Float32Array?d.set(a):console.warn("prepCoords: input type unknown")},transform:function(a){var b;"function"===typeof a.eachAtom?b=a.atomCount:a instanceof Float32Array&&
(b=a.length/3);var c=new NGL.Matrix(3,b),d=new NGL.Matrix(b,3);this.prepCoords(a,c);jsfeat.matmath.sub_rows(c,this.mean1);jsfeat.matmath.multiply_ABt(d,this.R,c);jsfeat.matmath.transpose(c,d);jsfeat.matmath.add_rows(c,this.mean2);var e=0,f=c.data;"function"===typeof a.eachAtom?a.eachAtom(function(a){a.x=f[e+0];a.y=f[e+1];a.z=f[e+2];e+=3}):a instanceof Float32Array?a.set(f.subarray(0,3*b)):console.warn("transform: input type unknown")}};NGL.Structure=function(a,b){this.name=a;this.path=b;this.reset()};
NGL.Structure.prototype={constructor:NGL.Structure,reset:function(){this.modelCount=this.chainCount=this.residueCount=this.atomCount=0;this.atoms=[];this.models=[];this.bondSet=new NGL.BondSet},postProcess:function(a){this.autoBond();this._doAutoSS&&this.autoSS();this._doAutoChainName&&this.autoChainName();this.center=this.atomCenter();this.boundingBox=this.getBoundingBox()},nextAtomIndex:function(){return this.atomCount++},nextResidueIndex:function(){return this.residueCount++},nextChainIndex:function(){return this.chainCount++},
nextModelIndex:function(){return this.modelCount++},addModel:function(){var a=new NGL.Model(this);a.index=this.nextModelIndex();this.models.push(a);return a},eachAtom:function(a,b){if(b){var c=b.modelTest;this.models.forEach(function(d){c(d)&&d.eachAtom(a,b)})}else this.models.forEach(function(b){b.eachAtom(a)})},eachResidue:function(a,b){if(b){var c=b.modelTest;this.models.forEach(function(d){c(d)&&d.eachResidue(a,b)})}else this.models.forEach(function(b){b.eachResidue(a)})},eachResidueN:function(a,
b){this.models.forEach(function(c){c.eachResidueN(a,b)})},eachFiber:function(a,b,c){if(b){var d=b.modelTest;this.models.forEach(function(e){d(e)&&e.eachFiber(a,b,c)})}else this.models.forEach(function(b){b.eachFiber(a,void 0,c)})},eachChain:function(a,b){if(b){var c=b.modelTest;this.models.forEach(function(d){c(d)&&d.eachChain(a,b)})}else this.models.forEach(function(b){b.eachChain(a)})},eachModel:function(a,b){if(b){var c=b.modelTest;this.models.forEach(function(b){c(b)&&a(b)})}else this.models.forEach(a)},
getSequence:function(){var a=[];this.eachResidue(function(b){b.getAtomByName("CA")&&a.push(b.getResname1())});return a},autoBond:function(){console.time("NGL.Structure.autoBond");var a=this.bondSet,b,c,d,e,f;console.time("NGL.Structure.autoBond within");this.eachResidue(function(g){d=g.atomCount-1;for(b=0;b<d;b++)for(e=g.atoms[b],c=b+1;c<=d;c++)f=g.atoms[c],a.addBondIfConnected(e,f)});console.timeEnd("NGL.Structure.autoBond within");console.time("NGL.Structure.autoBond between");this.eachResidueN(2,
function(b,c){b.isProtein()&&c.isProtein()?a.addBondIfConnected(b.getAtomByName("C"),c.getAtomByName("N")):b.isNucleic()&&c.hasNucleicBackbone()?a.addBondIfConnected(b.getAtomByName(["O3'","O3*"]),c.getAtomByName("P")):b.isCg()&&c.isCg()&&a.addBondIfConnected(b.getAtomByName(["CA","BB"]),c.getAtomByName(["CA","BB"]))});console.timeEnd("NGL.Structure.autoBond between");console.timeEnd("NGL.Structure.autoBond")},autoSS:function(){var a=function(){var a,c=new THREE.Vector3,d=new THREE.Vector3;return function(e,
f,g,h){for(var k=Math.max(0,f-2);k<=f;++k)for(var l=2;5>l;++l)if(!(k+l>=e.residueCount)&&(c.copy(e.residues[k].getAtomByName("CA")),d.copy(e.residues[k+l].getAtomByName("CA")),a=c.distanceTo(d),Math.abs(a-g[l-2])>h))return!1;return!0}}();return function(){console.time("NGL.Structure.autoSS");this.eachFiber(function(b){if(b.isProtein()){var c,d=b.residueCount;for(c=0;c<d;++c)a(b,c,[5.45,5.18,6.37],2.1)?b.residues[c].ss="h":a(b,c,[6.1,10.4,13],1.42)?b.residues[c].ss="s":b.residues[c].ss="c"}else if(b.isCg()){d=
new NGL.Helixbundle(b);b=d.position;c=d.fiber.residues;var d=d.size,e=new THREE.Vector3,f=new THREE.Vector3,g,h,k,l;for(g=0;g<d-1;++g)k=c[g],l=c[g+1],e.fromArray(b.center,3*g),f.fromArray(b.center,3*g+3),h=e.distanceTo(f),2>h&&1<h&&20>b.bending[g]&&(k.ss="h",l.ss="h")}});console.timeEnd("NGL.Structure.autoSS")}}(),autoChainName:function(){return function(){console.time("NGL.Structure.autoChainName");var a,b;this.eachModel(function(c){a=0;c.eachFiber(function(c){b="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789"[a];
c.eachAtom(function(a){a.chainname=b});a+=1;62===a&&(console.warn("out of chain names"),a=0)})});console.timeEnd("NGL.Structure.autoChainName")}}(),updatePosition:function(a){var b=0;this.eachAtom(function(c){c.x=a[b+0];c.y=a[b+1];c.z=a[b+2];b+=3})},toPdb:function(){function a(a,c){return void 0!==a?a:c}return function(){var b=1,c=[];c.push(sprintf("TITEL %-74s\n",this.name));this.trajectory&&(c.push(sprintf("REMARK %-73s\n","Trajectory '"+this.trajectory.name+"'")),c.push(sprintf("REMARK %-73s\n",
"Frame "+this.trajectory.frame+"")));this.eachModel(function(d){c.push(sprintf("MODEL %-74d\n",b++));d.eachAtom(function(b){c.push(sprintf("ATOM  %5d %4s %3s %1s%4d    %8.3f%8.3f%8.3f%6.2f%6.2f      %4s%2s\n",b.serial,b.atomname,b.resname,a(b.chainname," "),b.resno,b.x,b.y,b.z,a(b.occurence,1),a(b.bfactor,0),a(b.segid,""),a(b.element,"")))});c.push(sprintf("%-80s\n","ENDMDL"))});c.push(sprintf("%-80s\n","END"));return c.join("")}}()};NGL.AtomSet.prototype.apply(NGL.Structure.prototype);
NGL.Model=function(a){this.structure=a;this.chains=[];this.chainCount=this.residueCount=this.atomCount=0};
NGL.Model.prototype={modelno:void 0,nextAtomIndex:function(){this.atomCount+=1;return this.structure.nextAtomIndex()},nextResidueIndex:function(){this.residueCount+=1;return this.structure.nextResidueIndex()},nextChainIndex:function(){this.chainCount+=1;return this.structure.nextChainIndex()},addChain:function(){var a=new NGL.Chain(this);a.index=this.nextChainIndex();this.chains.push(a);return a},eachAtom:function(a,b){if(b){var c=b.chainTest;this.chains.forEach(function(d){c(d)&&d.eachAtom(a,b)})}else this.chains.forEach(function(b){b.eachAtom(a)})},
eachResidue:function(a,b){var c,d,e,f,g,h=this.chainCount;if(b){var k=b.chainTest;for(c=0;c<h;++c)if(f=this.chains[c],k(f)){e=f.residueCount;var l=b.residueTest;for(d=0;d<e;++d)g=f.residues[d],l(g)&&a(g)}}else for(c=0;c<h;++c)for(f=this.chains[c],e=f.residueCount,d=0;d<e;++d)a(f.residues[d])},eachResidueN:function(a,b){this.chains.forEach(function(c){c.eachResidueN(a,b)})},eachFiber:function(a,b,c){if(b){var d=b.chainTest;this.chains.forEach(function(e){d(e)&&e.eachFiber(a,b,c)})}else this.chains.forEach(function(b){b.eachFiber(a,
void 0,c)})},eachChain:function(a,b){var c,d,e=this.chainCount;if(b){var f=b.chainTest;for(c=0;c<e;++c)d=this.chains[c],f(d)&&a(d)}else for(c=0;c<e;++c)a(this.chains[c])}};NGL.AtomSet.prototype.apply(NGL.Model.prototype);NGL.Chain=function(a){this.model=a;this.residues=[];this.residueCount=this.atomCount=0};
NGL.Chain.prototype={chainname:void 0,nextAtomIndex:function(){this.atomCount+=1;return this.model.nextAtomIndex()},nextResidueIndex:function(){this.residueCount+=1;return this.model.nextResidueIndex()},addResidue:function(){var a=new NGL.Residue(this);a.index=this.nextResidueIndex();this.residues.push(a);return a},eachAtom:function(a,b){var c,d,e,f,g,h=this.residueCount;if(b){var k=b.residueTest;for(c=0;c<h;++c)if(f=this.residues[c],k(f)){e=f.atomCount;var l=b.test;for(d=0;d<e;++d)g=f.atoms[d],l(g)&&
a(g)}}else for(c=0;c<h;++c)for(f=this.residues[c],e=f.atomCount,d=0;d<e;++d)a(f.atoms[d])},eachResidue:function(a,b){var c,d,e=this.residueCount;if(b){var f=b.residueTest;for(c=0;c<e;++c)d=this.residues[c],f(d)&&a(d)}else for(c=0;c<e;++c)a(this.residues[c])},eachResidueN:function(a,b){if(!(this.residues.length<a)){var c=this.residues,d=Array(a),e=c.length,f;for(f=0;f<a;f++)d[f]=c[f];b.apply(this,d);for(f=a;f<e;f++)d.shift(),d.push(c[f]),b.apply(this,d)}},getFiber:function(a,b,c){var d=this.residueCount,
e=this.residues.slice(a,b);if(c){c=this.residues[a-1];var f=this.residues[a],g=this.residues[b-1],h=this.residues[b];0!==a&&c.getType()===f.getType()&&c.connectedTo(f)?e.unshift(c):e.unshift(f);b!==d&&h.getType()===f.getType()&&g.connectedTo(h)?e.push(h):e.push(g)}return new NGL.Fiber(e,this.model.structure)},eachFiber:function(a,b,c){var d=this,e=0,f=1,g=this.residues,h=b?b.test:void 0,k,l;this.eachResidueN(2,function(b,g){if(b.hasProteinBackbone()&&g.hasProteinBackbone())k=b.getAtomByName("C"),
l=g.getAtomByName("N");else if(b.hasNucleicBackbone()&&g.hasNucleicBackbone())k=b.getAtomByName(["O3'","O3*"]),l=g.getAtomByName("P");else if(b.isCg()&&g.isCg())k=b.getAtomByName(["CA","BB"]),l=g.getAtomByName(["CA","BB"]);else{(b.hasProteinBackbone()&&!g.hasProteinBackbone()||b.isCg()&&!g.isCg()||b.hasNucleicBackbone()&&!g.hasNucleicBackbone())&&a(d.getFiber(e,f,c));e=f;++f;return}k&&l&&k.connectedTo(l)&&(!h||h(k)&&h(l))||(a(d.getFiber(e,f,c)),e=f);++f});(g[e].hasProteinBackbone()||g[e].isCg()||
g[e].hasNucleicBackbone())&&a(d.getFiber(e,f,c))}};NGL.AtomSet.prototype.apply(NGL.Chain.prototype);
NGL.Fiber=function(a,b){this.structure=b;this.residues=a;this.residueCount=a.length;this.isProtein()?(this.traceAtomname="CA",this.directionAtomname1="C",this.directionAtomname2=["O","OC1","O1"]):this.isNucleic()?-1!==["A","C","T","G","U"].indexOf(this.residues[0].resname)?(this.traceAtomname=["C4'","C4*"],this.directionAtomname1=["C1'","C1*"],this.directionAtomname2=["C3'","C3*"]):(this.traceAtomname=["C3'","C3*"],this.directionAtomname1=["C2'","C2*"],this.directionAtomname2=["O4'","O4*"]):this.isCg()?
this.directionAtomname2=this.directionAtomname1=this.traceAtomname=["CA","BB"]:console.error("NGL.fiber: could not determine molecule type")};
NGL.Fiber.prototype={eachAtom:NGL.Chain.prototype.eachAtom,eachResidue:NGL.Chain.prototype.eachResidue,eachResidueN:NGL.Chain.prototype.eachResidueN,isProtein:function(){void 0===this._protein&&(this._protein=this.residues[0].isProtein());return this._protein},isCg:function(){void 0===this._cg&&(this._cg=this.residues[0].isCg());return this._cg},isNucleic:function(){void 0===this._nucleic&&(this._nucleic=this.residues[0].isNucleic());return this._nucleic}};
NGL.Residue=function(a){this.chain=a;this.atoms=[];this.atomCount=0};
NGL.Residue.prototype={index:void 0,resno:void 0,resname:void 0,_ss:void 0,get ss(){return this._ss},set ss(a){this._ss=a;var b,c=this.atomCount,d=this.atoms;for(b=0;b<c;++b)d[b].ss=a},isProtein:function(){void 0===this._protein&&(this._protein=void 0!==this.getAtomByName("CA")&&void 0!==this.getAtomByName("C")&&void 0!==this.getAtomByName("N"));return this._protein},hasProteinBackbone:function(){void 0===this._proteinBackbone&&(this._proteinBackbone=this.isProtein()&&void 0!==this.getAtomByName(["O",
"OC1","O1"]));return this._proteinBackbone},isCg:function(){var a=Object.keys(NGL.AA1);return function(){void 0===this._cg&&(this._cg=!this.isProtein()&&this.getAtomByName(["CA","BB"])&&5>=this.atomCount&&-1!==a.indexOf(this.resname));return this._cg}}(),isNucleic:function(){var a="A C T G U DA DC DT DG DU".split(" ");return function(){void 0===this._nucleic&&(this._nucleic=(void 0!==this.getAtomByName(["C3'","C3*"])||-1!==a.indexOf(this.resname))&&void 0!==this.getAtomByName(["O3'","O3*"]));return this._nucleic}}(),
hasNucleicBackbone:function(){void 0===this._nucleicBackbone&&(this._nucleicBackbone=this.isNucleic()&&void 0!==this.getAtomByName(["P"])&&void 0!==this.getAtomByName(["C3'","C3*"]));return this._nucleicBackbone},isHetero:function(){void 0===this._hetero&&(this._hetero=this.atoms.length&&this.atoms[0].hetero);return this._hetero},isWater:function(){var a=["SOL","WAT","HOH","H2O","W"];return function(){void 0===this._water&&(this._water=-1!==a.indexOf(this.resname));return this._water}}(),getResname1:function(){return NGL.AA1[this.resname.toUpperCase()]||
""},getType:function(){void 0===this._type&&(this.isProtein()?this._type=NGL.ProteinType:this.hasNucleicBackbone()?this._type=NGL.NucleicBackboneType:this.isNucleic()?this._type=NGL.NucleicType:this.isCg()?this._type=NGL.CgType:this.isWater()?this._type=NGL.WaterType:this._type=NGL.UnknownType);return this._type},nextAtomIndex:function(){this.atomCount+=1;return this.chain.nextAtomIndex()},addAtom:function(a){a?(this.atomCount+=1,a.residue=this):(a=new NGL.Atom(this),a.index=this.nextAtomIndex());
this.atoms.push(a);return a},addProxyAtom:function(a){a=new NGL.ProxyAtom(a,this.nextAtomIndex());a.residue=this;this.atoms.push(a);return a},eachAtom:function(a,b){var c,d,e=this.atomCount;if(b){var f=b.test;for(c=0;c<e;++c)d=this.atoms[c],f(d)&&a(d)}else for(c=0;c<e;++c)a(this.atoms[c])},getAtomByName:function(a){var b,c,d=void 0,e=this.atomCount;if(Array.isArray(a))for(b=0;b<e;++b){if(c=this.atoms[b],-1!==a.indexOf(c.atomname)){d=c;break}}else for(b=0;b<e;++b)if(c=this.atoms[b],a===c.atomname){d=
c;break}return d},getBackboneAtomStart:function(){if(this.isProtein())return this.getAtomByName("C");if(this.hasNucleicBackbone())return this.getAtomByName(["O3'","O3*"]);if(this.isCg())return this.getAtomByName(["CA","BB"])},getBackboneAtomEnd:function(){if(this.isProtein())return this.getAtomByName("N");if(this.hasNucleicBackbone())return this.getAtomByName("P");if(this.isCg())return this.getAtomByName(["CA","BB"])},connectedTo:function(a){return this.getBackboneAtomStart().connectedTo(a.getBackboneAtomEnd())}};
NGL.AtomSet.prototype.apply(NGL.Residue.prototype);NGL.Atom=function(a,b){this.residue=a;void 0===b&&(b=NGL.nextGlobalAtomindex++);this.globalindex=b};
NGL.Atom.prototype={index:void 0,atomno:void 0,resname:void 0,x:void 0,y:void 0,z:void 0,element:void 0,chainname:void 0,resno:void 0,serial:void 0,ss:void 0,vdw:void 0,covalent:void 0,hetero:void 0,bfactor:void 0,bonds:void 0,altloc:void 0,atomname:void 0,connectedTo:function(a){if(this.hetero&&a.hetero&&this.residue.chain.model.structure.hasConnect)return!1;var b=this.x-a.x,c=this.y-a.y,d=this.z-a.z,b=b*b+c*c+d*d;if(this.residue.isCg()&&28>b)return!0;if(isNaN(b)||.5>b)return!1;a=this.covalent+a.covalent+
.3;return b<a*a},qualifiedName:function(){var a="";this.resname&&(a+="["+this.resname+"]");this.resno&&(a+=this.resno);this.chainname&&(a+=":"+this.chainname);this.atomname&&(a+="."+this.atomname);this.residue&&this.residue.chain&&this.residue.chain.model&&(a+="/"+this.residue.chain.model.index);return a},positionFromArray:function(a,b){void 0===b&&(b=0);this.x=a[b+0];this.y=a[b+1];this.z=a[b+2];return this},positionToArray:function(a,b){void 0===a&&(a=[]);void 0===b&&(b=0);a[b+0]=this.x;a[b+1]=this.y;
a[b+2]=this.z;return a}};NGL.AtomArray=function(a){this.useBuffer=!0;Number.isInteger(a)?this.init(a):this.fromObject(a)};
NGL.AtomArray.prototype={init:function(a){this.length=a;this.useBuffer?(this.makeOffsetAndSize(),this.buffer=new ArrayBuffer(this.byteLength),this.makeTypedArrays()):(this.atomno=new Int32Array(a),this.resname=new Uint8Array(5*a),this.x=new Float32Array(a),this.y=new Float32Array(a),this.z=new Float32Array(a),this.element=new Uint8Array(3*a),this.chainname=new Uint8Array(a),this.resno=new Int32Array(a),this.serial=new Int32Array(a),this.ss=new Uint8Array(a),this.vdw=new Float32Array(a),this.covalent=
new Float32Array(a),this.hetero=new Uint8Array(a),this.bfactor=new Float32Array(a),this.altloc=new Uint8Array(a),this.atomname=new Uint8Array(4*a));this.makeBonds();this.makeResidue()},getBufferList:function(){return this.useBuffer?[this.buffer]:[this.atomno.buffer,this.resname.buffer,this.x.buffer,this.y.buffer,this.z.buffer,this.element.buffer,this.chainname.buffer,this.resno.buffer,this.serial.buffer,this.ss.buffer,this.vdw.buffer,this.covalent.buffer,this.hetero.buffer,this.bfactor.buffer,this.altloc.buffer,
this.atomname.buffer]},makeOffsetAndSize:function(){var a=this.length;this.atomnoOffset=0;this.resnameOffset=this.atomnoSize=4*a;this.resnameSize=5*a;this.xOffset=this.resnameOffset+this.resnameSize+3&-4;this.xSize=4*a;this.yOffset=this.xOffset+this.xSize;this.ySize=4*a;this.zOffset=this.yOffset+this.ySize;this.zSize=4*a;this.elementOffset=this.zOffset+this.zSize;this.elementSize=3*a;this.chainnameOffset=this.elementOffset+this.elementSize;this.chainnameSize=a;this.resnoOffset=this.chainnameOffset+
this.chainnameSize+3&-4;this.resnoSize=4*a;this.serialOffset=this.resnoOffset+this.resnoSize;this.serialSize=4*a;this.ssOffset=this.serialOffset+this.serialSize;this.ssSize=a;this.vdwOffset=this.ssOffset+this.ssSize+3&-4;this.vdwSize=4*a;this.covalentOffset=this.vdwOffset+this.vdwSize;this.covalentSize=4*a;this.heteroOffset=this.covalentOffset+this.covalentSize;this.heteroSize=a;this.bfactorOffset=this.heteroOffset+this.heteroSize+3&-4;this.bfactorSize=4*a;this.altlocOffset=this.bfactorOffset+this.bfactorSize;
this.altlocSize=a;this.atomnameOffset=this.altlocOffset+this.altlocSize;this.atomnameSize=4*a;this.byteLength=this.atomnameOffset+this.atomnameSize},makeTypedArrays:function(){this.atomno=new Int32Array(this.buffer,this.atomnoOffset,this.atomnoSize/4);this.resname=new Uint8Array(this.buffer,this.resnameOffset,this.resnameSize);this.x=new Float32Array(this.buffer,this.xOffset,this.xSize/4);this.y=new Float32Array(this.buffer,this.yOffset,this.ySize/4);this.z=new Float32Array(this.buffer,this.zOffset,
this.zSize/4);this.element=new Uint8Array(this.buffer,this.elementOffset,this.elementSize);this.chainname=new Uint8Array(this.buffer,this.chainnameOffset,this.chainnameSize);this.resno=new Int32Array(this.buffer,this.resnoOffset,this.resnoSize/4);this.serial=new Int32Array(this.buffer,this.serialOffset,this.serialSize/4);this.ss=new Uint8Array(this.buffer,this.ssOffset,this.ssSize);this.vdw=new Float32Array(this.buffer,this.vdwOffset,this.vdwSize/4);this.covalent=new Float32Array(this.buffer,this.covalentOffset,
this.covalentSize/4);this.hetero=new Uint8Array(this.buffer,this.heteroOffset,this.heteroSize);this.bfactor=new Float32Array(this.buffer,this.bfactorOffset,this.bfactorSize/4);this.altloc=new Uint8Array(this.buffer,this.altlocOffset,this.altlocSize);this.atomname=new Uint8Array(this.buffer,this.atomnameOffset,this.atomnameSize)},makeResidue:function(){this.residue=Array(this.length)},makeBonds:function(){var a=this.length;this.bonds=Array(a);for(var b=0;b<a;++b)this.bonds[b]=[]},toObject:function(){return this.useBuffer?
{length:this.length,buffer:this.buffer,bonds:this.bonds,residue:this.residue}:{length:this.length,atomno:this.atomno,resname:this.resname,x:this.x,y:this.y,z:this.z,element:this.element,chainname:this.chainname,resno:this.resno,serial:this.serial,ss:this.ss,vdw:this.vdw,covalent:this.covalent,hetero:this.hetero,bfactor:this.bfactor,altloc:this.altloc,atomname:this.atomname,bonds:this.bonds,residue:this.residue}},fromObject:function(a){this.length=a.length;this.useBuffer?(this.makeOffsetAndSize(),
this.buffer=a.buffer,this.makeTypedArrays()):(this.atomno=a.atomno,this.resname=a.resname,this.x=a.x,this.y=a.y,this.z=a.z,this.element=a.element,this.chainname=a.chainname,this.resno=a.resno,this.serial=a.serial,this.ss=a.ss,this.vdw=a.vdw,this.covalent=a.covalent,this.hetero=a.hetero,this.bfactor=a.bfactor,this.altloc=a.altloc,this.atomname=a.atomname);a.bonds?this.bonds=a.bonds:this.makeBonds();a.residue?this.residue=a.residue:this.makeResidue()},setResname:function(a,b){var c=5*a;this.resname[c]=
b.charCodeAt(0);this.resname[c+1]=b.charCodeAt(1);this.resname[c+2]=b.charCodeAt(2);this.resname[c+3]=b.charCodeAt(3);this.resname[c+4]=b.charCodeAt(4)},getResname:function(a){for(var b="",c=5*a,d=0;5>d;++d)if(a=this.resname[c+d])b+=String.fromCharCode(a);else break;return b},setElement:function(a,b){var c=3*a;this.element[c]=b.charCodeAt(0);this.element[c+1]=b.charCodeAt(1);this.element[c+2]=b.charCodeAt(2)},getElement:function(a){for(var b="",c=3*a,d=0;3>d;++d)if(a=this.element[c+d])b+=String.fromCharCode(a);
else break;return b},setChainname:function(a,b){this.chainname[a]=b.charCodeAt(0)},getChainname:function(a){return(a=this.chainname[a])?String.fromCharCode(a):""},setSS:function(a,b){this.ss[a]=b.charCodeAt(0)},getSS:function(a){return(a=this.ss[a])?String.fromCharCode(a):""},setAltloc:function(a,b){this.altloc[a]=b.charCodeAt(0)},getAltloc:function(a){return(a=this.altloc[a])?String.fromCharCode(a):""},setAtomname:function(a,b){var c=4*a;this.atomname[c]=b.charCodeAt(0);this.atomname[c+1]=b.charCodeAt(1);
this.atomname[c+2]=b.charCodeAt(2);this.atomname[c+3]=b.charCodeAt(3)},getAtomname:function(a){for(var b="",c=4*a,d=0;4>d;++d)if(a=this.atomname[c+d])b+=String.fromCharCode(a);else break;return b}};NGL.ProxyAtom=function(a,b){this.atomArray=a;this.index=b;this.globalindex=NGL.nextGlobalAtomindex++};
NGL.ProxyAtom.prototype={get atomno(){return this.atomArray.atomno[this.index]},set atomno(a){this.atomArray.atomno[this.index]=a},get resname(){return this.atomArray.getResname(this.index)},set resname(a){this.atomArray.setResname(this.index,a)},get x(){return this.atomArray.x[this.index]},set x(a){this.atomArray.x[this.index]=a},get y(){return this.atomArray.y[this.index]},set y(a){this.atomArray.y[this.index]=a},get z(){return this.atomArray.z[this.index]},set z(a){this.atomArray.z[this.index]=
a},get element(){return this.atomArray.getElement(this.index)},set element(a){this.atomArray.setElement(this.index,a)},get chainname(){return this.atomArray.getChainname(this.index)},set chainname(a){this.atomArray.setChainname(this.index,a)},get resno(){return this.atomArray.resno[this.index]},set resno(a){this.atomArray.resno[this.index]=a},get serial(){return this.atomArray.serial[this.index]},set serial(a){this.atomArray.serial[this.index]=a},get ss(){return this.atomArray.getSS(this.index)},
set ss(a){this.atomArray.setSS(this.index,a)},get vdw(){return this.atomArray.vdw[this.index]},set vdw(a){this.atomArray.vdw[this.index]=a},get covalent(){return this.atomArray.covalent[this.index]},set covalent(a){this.atomArray.covalent[this.index]=a},get hetero(){return this.atomArray.hetero[this.index]},set hetero(a){this.atomArray.hetero[this.index]=a},get bfactor(){return this.atomArray.bfactor[this.index]},set bfactor(a){this.atomArray.bfactor[this.index]=a},get bonds(){return this.atomArray.bonds[this.index]},
set bonds(a){this.atomArray.bonds[this.index]=a},get altloc(){return this.atomArray.getAltloc(this.index)},set altloc(a){this.atomArray.setAltloc(this.index,a)},get atomname(){return this.atomArray.getAtomname(this.index)},set atomname(a){this.atomArray.setAtomname(this.index,a)},get residue(){return this.atomArray.residue[this.index]},set residue(a){this.atomArray.residue[this.index]=a},connectedTo:function(a){var b=this.atomArray,c=a.atomArray,d=this.index;a=a.index;if(b.hetero[d]&&c.hetero[a])return!1;
var e=b.x[d]-c.x[a],f=b.y[d]-c.y[a],g=b.z[d]-c.z[a],e=e*e+f*f+g*g;if(b.residue[d].isCg()&&28>e)return!0;if(isNaN(e)||.5>e)return!1;b=b.covalent[d]+c.covalent[a]+.3;return e<b*b},qualifiedName:function(){var a="";this.resname&&(a+="["+this.resname+"]");this.resno&&(a+=this.resno);this.chainname&&(a+=":"+this.chainname);this.atomname&&(a+="."+this.atomname);this.residue&&this.residue.chain&&this.residue.chain.model&&(a+="/"+this.residue.chain.model.index);return a},positionFromArray:function(a,b){void 0===
b&&(b=0);this.x=a[b+0];this.y=a[b+1];this.z=a[b+2];return this},positionToArray:function(a,b){void 0===a&&(a=[]);void 0===b&&(b=0);a[b+0]=this.x;a[b+1]=this.y;a[b+2]=this.z;return a}};NGL.StructureSubset=function(a,b){NGL.Structure.call(this,a.name+" [subset]");this.structure=a;this.selection=new NGL.Selection(b);this.atoms=[];this.bondSet=new NGL.BondSet;this._build()};NGL.StructureSubset.prototype=Object.create(NGL.Structure.prototype);
NGL.StructureSubset.prototype._build=function(){console.time("NGL.StructureSubset._build");var a=this.structure,b=this.selection,c=this.atoms,d=this,e,f,g,h,k={};a.eachModel(function(a){e=d.addModel();a.eachChain(function(a){f=e.addChain();f.chainname=a.chainname;a.eachResidue(function(a){g=f.addResidue();g.resno=a.resno;g.resname=a.resname;g.ss=a.ss;a.eachAtom(function(a){h=g.addAtom();h.atomno=a.atomno;h.resname=a.resname;h.x=a.x;h.y=a.y;h.z=a.z;h.element=a.element;h.chainname=a.chainname;h.resno=
a.resno;h.serial=a.serial;h.ss=a.ss;h.vdw=a.vdw;h.covalent=a.covalent;h.hetero=a.hetero;h.bfactor=a.bfactor;h.bonds=[];h.altloc=a.altloc;h.atomname=a.atomname;k[a.index]=h;c.push(h)},b);0===g.atoms.length&&(f.residues.pop(),--f.residueCount,--e.residueCount,--d.residueCount)},b);0===f.residues.length&&(e.chains.pop(),--e.chainCount,--d.chainCount)},b);0===e.chains.length&&(d.models.pop(),--d.modelCount)},b);a.bondSet.eachBond(function(a){d.bondSet.addBond(k[a.atom1.index],k[a.atom2.index])},b);d.center=
d.atomCenter();d.boundingBox=d.getBoundingBox();a.frames&&(d.frames=a.frames);a.boxes&&(d.boxes=a.boxes);console.timeEnd("NGL.StructureSubset._build")};NGL.Selection=function(a){this.signals={stringChanged:new signals.Signal};this.setString(a)};
NGL.Selection.prototype={constructor:NGL.Selection,setString:function(a,b){a=a||"";if(a!==this.string){try{this.parse(a)}catch(c){this.selection={error:c.message}}this.string=a;this.test=this.makeAtomTest();this.residueTest=this.makeResidueTest();this.chainTest=this.makeChainTest();this.modelTest=this.makeModelTest();b||this.signals.stringChanged.dispatch(a)}},parse:function(a){this.selection={operator:void 0,rules:[]};if(a){var b=this,c=this.selection,d=[],e,f;a=a.replace(/\(/g," ( ").replace(/\)/g,
" ) ").trim();"("===a.charAt(0)&&")"===a.substr(-1)&&(a=a.slice(1,-1).trim());a=a.split(/\s+/);var g=["*","","ALL"],h,k,l,n,m=function(a){e={operator:a,rules:[]};void 0===c?(c=e,b.selection=e):(c.rules.push(e),d.push(c),c=e)},q=function(a){f=c;c=d.pop();void 0===c&&(m(a),s(f))},s=function(a){c.rules.push(a)};for(l=0;l<a.length;++l)if(h=a[l],"("===h)n=!1,m();else if(")"===h)q(),c.negate&&q();else{if(0<n)if("NOT"===h.toUpperCase())n=1;else if(1===n)n=2;else if(2===n)n=!1,q();else throw Error("something went wrong with 'not'");
if("AND"===h.toUpperCase())"OR"===c.operator?(k=c.rules.pop(),m("AND"),s(k)):c.operator="AND";else if("OR"===h.toUpperCase())"AND"===c.operator?q("OR"):c.operator="OR";else if("NOT"===h.toUpperCase())n=1,m(),c.negate=!0;else if(k={},"HETERO"===h.toUpperCase())k.keyword="HETERO",s(k);else if("WATER"===h.toUpperCase())k.keyword="WATER",s(k);else if("PROTEIN"===h.toUpperCase())k.keyword="PROTEIN",s(k);else if("NUCLEIC"===h.toUpperCase())k.keyword="NUCLEIC",s(k);else if("POLYMER"===h.toUpperCase())k.keyword=
"POLYMER",s(k);else if("HYDROGEN"===h.toUpperCase())k.element="H",s(k);else if("HELIX"===h.toUpperCase())k.keyword="HELIX",s(k);else if("SHEET"===h.toUpperCase())k.keyword="SHEET",s(k);else if("TURN"===h.toUpperCase())k={operator:"OR",negate:!0,rules:[{keyword:"HELIX"},{keyword:"SHEET"}]},s(k);else if("BACKBONE"===h.toUpperCase())k.keyword="BACKBONE",s(k);else if("SIDECHAIN"===h.toUpperCase())k.keyword="SIDECHAIN",s(k);else if("SIDECHAINATTACHED"===h.toUpperCase())k={operator:"OR",rules:[{operator:"AND",
negate:!1,rules:[{resname:"PRO"},{atomname:"N"}]},{keyword:"SIDECHAIN"},{atomname:"CA"},{atomname:"BB"}]},s(k);else if(-1!==g.indexOf(h.toUpperCase()))k.keyword="ALL",s(k);else if("@"===h.charAt(0))k.globalindex=parseInt(h.substr(1)),s(k);else if("#"===h.charAt(0))k.element=h.substr(1).toUpperCase(),s(k);else if(1<=h.length&&4>=h.length&&":"!==h[0]&&"."!==h[0]&&"/"!==h[0]&&isNaN(parseInt(h)))k.resname=h.toUpperCase(),s(k);else{k={operator:"AND",rules:[]};h=h.split("/");if(1<h.length&&h[1]){if(isNaN(parseInt(h[1])))throw Error("model must be an integer");
k.rules.push({model:parseInt(h[1])})}h=h[0].split(".");if(1<h.length&&h[1]){if(4<h[1].length)throw Error("atomname must be one to four characters");k.rules.push({atomname:h[1].substring(0,4).toUpperCase()})}h=h[0].split(":");1<h.length&&h[1]&&k.rules.push({chainname:h[1]});if(h[0])if(h=h[0].split("-"),1===h.length){h=parseInt(h[0]);if(isNaN(h))throw Error("resi must be an integer");k.rules.push({resno:h})}else if(2===h.length)k.rules.push({resno:[parseInt(h[0]),parseInt(h[1])]});else throw Error("resi range must contain one '-'");
if(1===k.rules.length)s(k.rules[0]);else if(1<k.rules.length)s(k);else throw Error("empty selection chunk");}}void 0===this.selection.operator&&1===this.selection.rules.length&&this.selection.rules[0].hasOwnProperty("operator")&&(this.selection=this.selection.rules[0])}},_makeTest:function(a,b){void 0===b&&(b=this.selection);if(b.error)return function(){return!0};var c=b.rules.length;if(0===c)return function(){return!0};var d=b.negate?!1:!0,e=b.negate?!0:!1,f,g,h,k,l=[];for(f=0;f<c;++f)g=b.rules[f],
g.hasOwnProperty("operator")&&(l[f]=this._makeTest(a,g));return function(n){h="AND"===b.operator;for(f=0;f<c;++f){g=b.rules[f];if(g.hasOwnProperty("operator"))k=l[f](n);else{if(void 0!==g.keyword&&"ALL"===g.keyword)if(h)continue;else return d;k=a(n,g)}if(-1===k)return-1;if(!0===k){if(!h)return d}else if(h)return e}return h?d:e}},makeAtomTest:function(){var a="CA C N O O1 O2 OC1 OC2 H H1 H2 H3 HA".split(" "),b="P O3' O5' C5' C4' C3' OP1 OP2 O3* O5* C5* C4* C3*".split(" "),c=["CA","BB"],d=["h","g",
"i"];return this._makeTest(function(e,f){if(void 0!==f.keyword)return"HETERO"===f.keyword&&!0===e.hetero||"PROTEIN"===f.keyword&&(e.residue.isProtein()||e.residue.isCg())||"NUCLEIC"===f.keyword&&e.residue.isNucleic()||"POLYMER"===f.keyword&&(e.residue.isProtein()||e.residue.isNucleic()||e.residue.isCg())||"WATER"===f.keyword&&e.residue.isWater()||"HELIX"===f.keyword&&-1!==d.indexOf(e.ss)||"SHEET"===f.keyword&&"s"===e.ss||"BACKBONE"===f.keyword&&(e.residue.isProtein()&&-1!==a.indexOf(e.atomname)||
e.residue.isNucleic()&&-1!==b.indexOf(e.atomname)||e.residue.isCg()&&-1!==c.indexOf(e.atomname))||"SIDECHAIN"===f.keyword&&(e.residue.isProtein()&&-1===a.indexOf(e.atomname)||e.residue.isNucleic()&&-1===b.indexOf(e.atomname)||e.residue.isCg()&&-1===c.indexOf(e.atomname))?!0:!1;if(void 0!==f.globalindex&&f.globalindex!==e.globalindex||void 0!==f.resname&&f.resname!==e.resname||void 0!==f.chainname&&f.chainname!==e.chainname||void 0!==f.atomname&&f.atomname!==e.atomname||void 0!==f.model&&f.model!==
e.residue.chain.model.index)return!1;if(void 0!==f.resno)if(Array.isArray(f.resno)&&2===f.resno.length){if(f.resno[0]>e.resno||f.resno[1]<e.resno)return!1}else if(f.resno!==e.resno)return!1;return void 0!==f.element&&f.element!==e.element?!1:!0})},makeResidueTest:function(){return this._makeTest(function(a,b){if(void 0!==b.keyword&&("HETERO"===b.keyword&&a.isHetero()||"PROTEIN"===b.keyword&&(a.isProtein()||a.isCg())||"NUCLEIC"===b.keyword&&a.isNucleic()||"POLYMER"===b.keyword&&(a.isProtein()||a.isNucleic()||
a.isCg())||"WATER"===b.keyword&&a.isWater()))return!0;if(void 0===b.chainname&&void 0===b.model&&void 0===b.resname&&void 0===b.resno||void 0!==b.chainname&&void 0===a.chain.chainname||" "!==b.chainname&&" "===a.chain.chainname)return-1;if(void 0!==b.resname&&b.resname!==a.resname||void 0!==b.chainname&&b.chainname!==a.chain.chainname||void 0!==b.model&&b.model!==a.chain.model.index)return!1;if(void 0!==b.resno)if(Array.isArray(b.resno)&&2===b.resno.length){if(b.resno[0]>a.resno||b.resno[1]<a.resno)return!1}else if(b.resno!==
a.resno)return!1;return!0})},makeChainTest:function(){return this._makeTest(function(a,b){return void 0!==b.chainname&&void 0===a.chainname||void 0===b.chainname&&void 0===b.model||" "!==b.chainname&&" "===a.chainname?-1:void 0!==b.chainname&&b.chainname!==a.chainname||void 0!==b.model&&b.model!==a.model.index?!1:!0})},makeModelTest:function(){return this._makeTest(function(a,b){return void 0===b.model?-1:b.model!==a.index?!1:!0})}};
NGL.SubstitutionMatrices=function(){function a(a,c){var d,e=0,f={};c.forEach(function(c){d=0;var h={};c.forEach(function(c){h[a[d++]]=c});f[a[e++]]=h});return f}return{blosum62:a("ARNDCQEGHILKMFPSTWYVBZ?",[[4,-1,-2,-2,0,-1,-1,0,-2,-1,-1,-1,-1,-2,-1,1,0,-3,-2,0,-2,-1,0],[-1,5,0,-2,-3,1,0,-2,0,-3,-2,2,-1,-3,-2,-1,-1,-3,-2,-3,-1,0,-1],[-2,0,6,1,-3,0,0,0,1,-3,-3,0,-2,-3,-2,1,0,-4,-2,-3,3,0,-1],[-2,-2,1,6,-3,0,2,-1,-1,-3,-4,-1,-3,-3,-1,0,-1,-4,-3,-3,4,1,-1],[0,-3,-3,-3,9,-3,-4,-3,-3,-1,-1,-3,-1,-2,-3,
-1,-1,-2,-2,-1,-3,-3,-2],[-1,1,0,0,-3,5,2,-2,0,-3,-2,1,0,-3,-1,0,-1,-2,-1,-2,0,3,-1],[-1,0,0,2,-4,2,5,-2,0,-3,-3,1,-2,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-2,0,-1,-3,-2,-2,6,-2,-4,-4,-2,-3,-3,-2,0,-2,-2,-3,-3,-1,-2,-1],[-2,0,1,-1,-3,0,0,-2,8,-3,-3,-1,-2,-1,-2,-1,-2,-2,2,-3,0,0,-1],[-1,-3,-3,-3,-1,-3,-3,-4,-3,4,2,-3,1,0,-3,-2,-1,-3,-1,3,-3,-3,-1],[-1,-2,-3,-4,-1,-2,-3,-4,-3,2,4,-2,2,0,-3,-2,-1,-2,-1,1,-4,-3,-1],[-1,2,0,-1,-3,1,1,-2,-1,-3,-2,5,-1,-3,-1,0,-1,-3,-2,-2,0,1,-1],[-1,-1,-2,-3,-1,0,-2,-3,-2,1,2,
-1,5,0,-2,-1,-1,-1,-1,1,-3,-1,-1],[-2,-3,-3,-3,-2,-3,-3,-3,-1,0,0,-3,0,6,-4,-2,-2,1,3,-1,-3,-3,-1],[-1,-2,-2,-1,-3,-1,-1,-2,-2,-3,-3,-1,-2,-4,7,-1,-1,-4,-3,-2,-2,-1,-2],[1,-1,1,0,-1,0,0,0,-1,-2,-2,0,-1,-2,-1,4,1,-3,-2,-2,0,0,0],[0,-1,0,-1,-1,-1,-1,-2,-2,-1,-1,-1,-1,-2,-1,1,5,-2,-2,0,-1,-1,0],[-3,-3,-4,-4,-2,-2,-3,-2,-2,-3,-2,-3,-1,1,-4,-3,-2,11,2,-3,-4,-3,-2],[-2,-2,-2,-3,-2,-1,-2,-3,2,-1,-1,-2,-1,3,-3,-2,-2,2,7,-1,-3,-2,-1],[0,-3,-3,-3,-1,-2,-2,-3,-3,3,1,-2,1,-1,-2,-2,0,-3,-1,4,-3,-2,-1],[-2,-1,
3,4,-3,0,1,-1,0,-3,-4,0,-3,-3,-2,0,-1,-4,-3,-3,4,1,-1],[-1,0,0,1,-3,3,4,-2,0,-3,-3,1,-1,-3,-1,0,-1,-3,-2,-2,1,4,-1],[0,-1,-1,-1,-2,-1,-1,-1,-1,-1,-1,-1,-1,-1,-2,0,0,-2,-1,-1,-1,-1,-1]]),blosum62x:a("ACDEFGHIKLMNPQRSTVWY",[[4,0,-2,-1,-2,0,-2,-1,-1,-1,-1,-2,-1,-1,-1,1,0,0,-3,-2],[0,9,-3,-4,-2,-3,-3,-1,-3,-1,-1,-3,-3,-3,-3,-1,-1,-1,-2,-2],[-2,-3,6,2,-3,-1,-1,-3,-1,-4,-3,1,-1,0,-2,0,-1,-3,-4,-3],[-1,-4,2,5,-3,-2,0,-3,1,-3,-2,0,-1,2,0,0,-1,-2,-3,-2],[-2,-2,-3,-3,6,-3,-1,0,-3,0,0,-3,-4,-3,-3,-2,-2,-1,1,
3],[0,-3,-1,-2,-3,6,-2,-4,-2,-4,-3,0,-2,-2,-2,0,-2,-3,-2,-3],[-2,-3,-1,0,-1,-2,8,-3,-1,-3,-2,1,-2,0,0,-1,-2,-3,-2,2],[-1,-1,-3,-3,0,-4,-3,4,-3,2,1,-3,-3,-3,-3,-2,-1,3,-3,-1],[-1,-3,-1,1,-3,-2,-1,-3,5,-2,-1,0,-1,1,2,0,-1,-2,-3,-2],[-1,-1,-4,-3,0,-4,-3,2,-2,4,2,-3,-3,-2,-2,-2,-1,1,-2,-1],[-1,-1,-3,-2,0,-3,-2,1,-1,2,5,-2,-2,0,-1,-1,-1,1,-1,-1],[-2,-3,1,0,-3,0,1,-3,0,-3,-2,6,-2,0,0,1,0,-3,-4,-2],[-1,-3,-1,-1,-4,-2,-2,-3,-1,-3,-2,-2,7,-1,-2,-1,-1,-2,-4,-3],[-1,-3,0,2,-3,-2,0,-3,1,-2,0,0,-1,5,1,0,-1,-2,
-2,-1],[-1,-3,-2,0,-3,-2,0,-3,2,-2,-1,0,-2,1,5,-1,-1,-3,-3,-2],[1,-1,0,0,-2,0,-1,-2,0,-2,-1,1,-1,0,-1,4,1,-2,-3,-2],[0,-1,-1,-1,-2,-2,-2,-1,-1,-1,-1,0,-1,-1,-1,1,5,0,-2,-2],[0,-1,-3,-2,-1,-3,-3,3,-2,1,1,-3,-2,-2,-3,-2,0,4,-3,-1],[-3,-2,-4,-3,1,-2,-2,-3,-3,-2,-1,-4,-4,-2,-3,-3,-2,-3,11,2],[-2,-2,-3,-2,3,-3,2,-1,-2,-1,-1,-2,-3,-1,-2,-2,-2,-1,2,7]])}}();
NGL.Alignment=function(a,b,c,d,e){this.seq1=a;this.seq2=b;this.gapPenalty=c||-10;this.gapExtensionPenalty=d||-1;this.substMatrix=e||"blosum62",this.substMatrix=NGL.SubstitutionMatrices[this.substMatrix]};
NGL.Alignment.prototype={initMatrices:function(){this.n=this.seq1.length;this.m=this.seq2.length;this.score=void 0;this.ali="";this.S=[];this.V=[];this.H=[];for(var a=0;a<=this.n;a++){this.S[a]=[];this.V[a]=[];this.H[a]=[];for(var b=0;b<=this.m;b++)this.S[a][b]=0,this.V[a][b]=0,this.H[a][b]=0}for(a=0;a<=this.n;++a)this.S[a][0]=this.gap(0),this.H[a][0]=-Infinity;for(b=0;b<=this.m;++b)this.S[0][b]=this.gap(0),this.V[0][b]=-Infinity;this.S[0][0]=0},gap:function(a){return this.gapPenalty+a*this.gapExtensionPenalty},
makeScoreFn:function(){var a=this.seq1,b=this.seq2,c=this.substMatrix,d,e;if(c)return function(f,g){d=a[f];e=b[g];try{return c[d][e]}catch(h){return-4}};console.warn("NGL.Alignment: no subst matrix");return function(c,g){d=a[c];e=b[g];return d==e?5:-3}},calc:function(){console.time("NGL.Alignment.calc");this.initMatrices();var a=this.gap(0),b=this.makeScoreFn(),c=this.gapExtensionPenalty,d=this.V,e=this.H,f=this.S,g=this.n,h=this.m,k,l,n,m,q,s,p;for(s=1;s<=g;++s)for(l=f[s-1],k=d[s-1],n=d[s],m=e[s],
q=f[s],p=1;p<=h;++p)n[p]=Math.max(l[p]+a,k[p]+c),m[p]=Math.max(q[p-1]+a,m[p-1]+c),q[p]=Math.max(l[p-1]+b(s-1,p-1),n[p],m[p]);console.timeEnd("NGL.Alignment.calc")},trace:function(){this.ali2=this.ali1="";var a=this.makeScoreFn(),b=this.n,c=this.m,d="S";this.S[b][c]>=this.V[b][c]&&this.S[b][c]>=this.V[b][c]?(d="S",this.score=this.S[b][c]):this.V[b][c]>=this.H[b][c]?(d="V",this.score=this.V[b][c]):(d="H",this.score=this.H[b][c]);for(;0<b&&0<c;)"S"==d?this.S[b][c]==this.S[b-1][c-1]+a(b-1,c-1)?(this.ali1=
this.seq1[b-1]+this.ali1,this.ali2=this.seq2[c-1]+this.ali2,--b,--c,d="S"):this.S[b][c]==this.V[b][c]?d="V":this.S[b][c]==this.H[b][c]?d="H":(console.error("NGL.Alignment: S"),--b,--c):"V"==d?this.V[b][c]==this.V[b-1][c]+this.gapExtensionPenalty?(this.ali1=this.seq1[b-1]+this.ali1,this.ali2="-"+this.ali2,--b,d="V"):this.V[b][c]==this.S[b-1][c]+this.gap(0)?(this.ali1=this.seq1[b-1]+this.ali1,this.ali2="-"+this.ali2,--b,d="S"):(console.error("NGL.Alignment: V"),--b):"H"==d?this.H[b][c]==this.H[b][c-
1]+this.gapExtensionPenalty?(this.ali1="-"+this.ali1,this.ali2=this.seq2[c-1]+this.ali2,--c,d="H"):this.H[b][c]==this.S[b][c-1]+this.gap(0)?(this.ali1="-"+this.ali1,this.ali2=this.seq2[c-1]+this.ali2,--c,d="S"):(console.error("NGL.Alignment: H"),--c):console.error("NGL.Alignment: no matrix");for(;0<b;)this.ali1=this.seq1[b-1]+this.ali1,this.ali2="-"+this.ali2,--b;for(;0<c;)this.ali1="-"+this.ali1,this.ali2=this.seq2[c-1]+this.ali2,--c}};
NGL.superpose=function(a,b,c,d,e,f,g){d=d||"";e=e||"";f=f||"";g=g||"";var h,k;if(c){c=a;var l=b;d&&e&&(c=new NGL.StructureSubset(a,d),l=new NGL.StructureSubset(b,e));b=c.getSequence();d=l.getSequence();d=new NGL.Alignment(b.join(""),d.join(""));d.calc();d.trace();var n,m,q,s,p=0,r=0;b=d.ali1.length;var u=[],x=[];for(e=0;e<b;++e)q=d.ali1[e],s=d.ali2[e],m=n=0,"-"===q?x[r]=!1:(x[r]=!0,n=1),"-"===s?u[p]=!1:(u[p]=!0,m=1),p+=n,r+=m;h=new NGL.AtomSet;k=new NGL.AtomSet;p=0;c.eachResidue(function(a){a.getResname1()&&
a.getAtomByName("CA")&&(u[p]&&h.addAtom(a.getAtomByName("CA")),p+=1)});p=0;l.eachResidue(function(a){a.getResname1()&&a.getAtomByName("CA")&&(x[p]&&k.addAtom(a.getAtomByName("CA")),p+=1)})}else h=new NGL.AtomSet(a,new NGL.Selection(d+" and .CA")),k=new NGL.AtomSet(b,new NGL.Selection(e+" and .CA"));if(f&&g){c=new NGL.AtomSet;l=new NGL.AtomSet;f=new NGL.Selection(f);b=new NGL.Selection(g);g=f.test;f=b.test;b=h.atomCount;for(p=0;p<b;++p)d=h.atoms[p],e=k.atoms[p],g(d)&&f(e)&&(c.addAtom(d),l.addAtom(e));
h=c;k=l}g=new NGL.Superposition(h,k);f=new NGL.AtomSet(a,new NGL.Selection("*"));g.transform(f);a.center=a.atomCenter()};NGL.makeTrajectory=function(a,b,c){return!a&&b.frames?new NGL.StructureTrajectory(a,b,c):new NGL.RemoteTrajectory(a,b,c)};
NGL.Trajectory=function(a,b,c){var d=this,e=signals;this.signals={gotNumframes:new e.Signal,frameChanged:new e.Signal,selectionChanged:new e.Signal,playerChanged:new e.Signal};this.params={centerPbc:!0,removePbc:!0,superpose:!0};this.name=a.replace(/^.*[\\\/]/,"");this.trajPath=a;this.setStructure(b);this.numframes=void 0;this.getNumframes();this.selection=new NGL.Selection(c||"backbone and not hydrogen");this.selection.signals.stringChanged.add(function(a){d.makeIndices();d.resetCache()})};
NGL.Trajectory.prototype={constructor:NGL.Trajectory,setStructure:function(a){this.structure=a;this.atomCount=a.atomCount;if(a instanceof NGL.StructureSubset){this.atomIndices=[];a=a.structure.atomIndex(a.selection);var b,c,d=a[0],e=a[0],f=a.length;for(b=1;b<f;++b)c=a[b],e+1<c&&(this.atomIndices.push([d,e+1]),d=c),e=c;this.atomIndices.push([d,e+1])}else this.atomIndices=[[0,this.atomCount]];this.saveInitialStructure();this.backboneIndices=this.structure.atomIndex(new NGL.Selection("backbone and not hydrogen"));
this.makeIndices();this.frameCache=[];this.boxCache=[];this.pathCache=[];this.frameCacheSize=0;this.currentFrame=-1},saveInitialStructure:function(){var a=0,b=new Float32Array(3*this.atomCount);this.structure.eachAtom(function(c){b[a+0]=c.x;b[a+1]=c.y;b[a+2]=c.z;a+=3});this.initialStructure=b},setSelection:function(a){this.selection.setString(a);return this},makeIndices:function(){this.indices=this.structure.atomIndex(this.selection);var a,b,c=3*this.indices.length;this.coords1=new Float32Array(c);
this.coords2=new Float32Array(c);var d=this.initialStructure,e=this.coords2;for(a=0;a<c;a+=3)b=3*this.indices[a/3],e[a+0]=d[b+0],e[a+1]=d[b+1],e[a+2]=d[b+2]},getNumframes:function(){console.error("Trajectory.loadFrame not implemented")},resetCache:function(){this.frameCache=[];this.boxCache=[];this.pathCache=[];this.frameCacheSize=0;this.setFrame(this.currentFrame);return this},setParameters:function(a){var b=this.params,c=!1;a.centerPbc!==b.centerPbc&&(b.centerPbc=a.centerPbc,c=!0);a.removePbc!==
b.removePbc&&(b.removePbc=a.removePbc,c=!0);a.superpose!==b.superpose&&(b.superpose=a.superpose,c=!0);c&&this.resetCache()},setFrame:function(a,b){if(void 0===a)return this;this.inProgress=!0;a=parseInt(a);-1===a||this.frameCache[a]?this.updateStructure(a,b):this.loadFrame(a,b);return this},loadFrame:function(a,b){console.error("Trajectory.loadFrame not implemented")},updateStructure:function(a,b){-1===a?this.structure.updatePosition(this.initialStructure):this.structure.updatePosition(this.frameCache[a]);
this.structure.trajectory={name:this.trajPath,frame:a};"function"===typeof b&&b();this.currentFrame=a;this.inProgress=!1;this.signals.frameChanged.dispatch(a)},getCircularMean:function(a,b,c){return[NGL.Utils.circularMean(b,c[0],3,0,a),NGL.Utils.circularMean(b,c[1],3,1,a),NGL.Utils.circularMean(b,c[2],3,2,a)]},centerPbc:function(a,b,c){if(0!==c[0]&&0!==c[8]&&0!==c[4]){var d=a.length,e=c[0],f=c[1];c=c[2];var g=-b[0]+e+e/2,h=-b[1]+f+f/2,k=-b[2]+c+c/2;for(b=0;b<d;b+=3)a[b+0]=(a[b+0]+g)%e,a[b+1]=(a[b+
1]+h)%f,a[b+2]=(a[b+2]+k)%c}},removePbc:function(a,b){if(0!==b[0]&&0!==b[8]&&0!==b[4]){var c,d,e,f=a.length;for(c=3;c<f;c+=3)for(d=0;3>d;++d)if(e=a[c+d]-a[c-3+d],Math.abs(e)>.9*b[3*d+d])if(0<e)for(e=0;3>e;++e)a[c+e]-=b[3*d+e];else for(e=0;3>e;++e)a[c+e]+=b[3*d+e];return a}},superpose:function(a){var b,c,d=3*this.indices.length,e=this.coords1,f=this.coords2;for(b=0;b<d;b+=3)c=3*this.indices[b/3],e[b+0]=a[c+0],e[b+1]=a[c+1],e[b+2]=a[c+2];(new NGL.Superposition(e,f)).transform(a)},dispose:function(){this.frameCache=
[]},setPlayer:function(a){this.player=a;this.signals.playerChanged.dispatch(a)},getPath:function(a,b){console.error("Trajectory.getPath not implemented")},download:function(a){for(var b=this,c=this.numframes,d=Math.ceil(c/a),e=0,f=new Float32Array(d*(9+3*this.atomCount)),g=0;g<c;g+=a)this.loadFrame(g,function(){var a=g,c=e,l=c*(9+3*b.atomCount);f.set(b.boxCache[a],l);f.set(b.frameCache[a],l+9);c===d-1&&(a=new Blob([f],{type:"application/octet-binary"}),NGL.download(a,"traj.bbt"))}),e+=1}};
NGL.RemoteTrajectory=function(a,b,c){NGL.Trajectory.call(this,a,b,c)};NGL.RemoteTrajectory.prototype=Object.create(NGL.Trajectory.prototype);
NGL.RemoteTrajectory.prototype.loadFrame=function(a,b){var c=this,d=new XMLHttpRequest,e="../traj/frame/"+a+"/"+this.trajPath,f="atomIndices="+this.atomIndices.join(";");d.open("POST",e,!0);d.responseType="arraybuffer";d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.addEventListener("load",function(d){var f=this.response;if(f){d=new Float32Array(f,0,9);f=new Float32Array(f,36);if(0<c.backboneIndices.length&&c.params.centerPbc){var k=[d[0],d[4],d[8]],l=c.getCircularMean(c.backboneIndices,
f,k);c.centerPbc(f,l,k)}c.params.removePbc&&c.removePbc(f,d);0<c.indices.length&&c.params.superpose&&c.superpose(f);c.frameCache[a]||(c.frameCache[a]=f,c.boxCache[a]=d,c.frameCacheSize+=1);c.updateStructure(a,b)}else console.error("empty arrayBuffer for '"+e+"'")},!1);d.send(f)};NGL.RemoteTrajectory.prototype.getNumframes=function(){var a=this;(new THREE.XHRLoader).load("../traj/numframes/"+this.trajPath,function(b){b=parseInt(b);a.numframes=b;a.signals.gotNumframes.dispatch(b)})};
NGL.RemoteTrajectory.prototype.getPath=function(a,b){if(this.pathCache[a])b(this.pathCache[a]);else{console.time("loadPath");var c=this,d=new XMLHttpRequest,e="../traj/path/"+a+"/"+this.trajPath;d.open("POST",e,!0);d.responseType="arraybuffer";d.setRequestHeader("Content-type","application/x-www-form-urlencoded");d.addEventListener("load",function(d){console.timeEnd("loadPath");(d=this.response)?(d=new Float32Array(d),c.pathCache[a]=d,b(d)):console.error("empty arrayBuffer for '"+e+"'")},!1);d.send("")}};
NGL.StructureTrajectory=function(a,b,c){NGL.Trajectory.call(this,"",b,c)};NGL.StructureTrajectory.prototype=Object.create(NGL.Trajectory.prototype);
NGL.StructureTrajectory.prototype.loadFrame=function(a,b){var c=new Float32Array(this.structure.frames[a]),d=this.structure.boxes[a];if(d){if(0<this.backboneIndices.length&&this.params.centerPbc){var e=[d[0],d[4],d[8]],f=this.getCircularMean(this.backboneIndices,c,e);this.centerPbc(c,f,e)}this.params.removePbc&&this.removePbc(c,d)}0<this.indices.length&&this.params.superpose&&this.superpose(c);this.frameCache[a]||(this.frameCache[a]=c,this.boxCache[a]=d,this.frameCacheSize+=1);this.updateStructure(a,
b)};NGL.StructureTrajectory.prototype.getNumframes=function(){this.numframes=this.structure.frames.length;this.signals.gotNumframes.dispatch(this.numframes)};NGL.StructureTrajectory.prototype.getPath=function(a,b){var c,d,e,f=this.numframes,g=3*a,h=new Float32Array(3*f);for(c=0;c<f;++c)d=3*c,e=this.structure.frames[c],h[d+0]=e[g+0],h[d+1]=e[g+1],h[d+2]=e[g+2];b(h)};
NGL.TrajectoryPlayer=function(a,b,c,d,e){var f=signals;this.signals={startedRunning:new f.Signal,haltedRunning:new f.Signal};var g=this;a.signals.playerChanged.add(function(a){a!==g&&g.pause()});this.traj=a;this.step=b||Math.ceil((a.numframes+1)/100);this.timeout=c||50;this.start=d||0;this.end=e||a.numframes-1;this.end=Math.min(this.end,a.numframes-1);this.mode="loop";this.direction="forward";this._running=this._stopFlag=!1};
NGL.TrajectoryPlayer.prototype={_animate:function(){var a;this._running=!0;if(!this.traj.inProgress&&!this._stopFlag){a="forward"===this.direction?this.traj.currentFrame+this.step:this.traj.currentFrame-this.step;if(a>=this.end||a<this.start)"once"===this.mode?(this.pause(),a="forward"===this.direction?this.end:this.start):a="forward"===this.direction?this.start:this.end;this.traj.setFrame(a)}this._stopFlag?this._running=!1:setTimeout(this._animate.bind(this),this.timeout)},toggle:function(){this._running?
this.pause():this.play()},play:function(){if(!this._running){this.traj.player!==this&&this.traj.setPlayer(this);if("once"===this.mode){var a=this.traj.currentFrame;if(a>=this.end||a<=this.start)a="forward"===this.direction?this.start:this.end,this.traj.setFrame(a)}this._stopFlag=!1;this._animate();this.signals.startedRunning.dispatch()}},pause:function(){this._running&&(this._stopFlag=!0,this.signals.haltedRunning.dispatch())},stop:function(){this.traj.setFrame(this.start);this.pause()}};
NGL.Surface=function(a,b,c){this.name=b;this.path=c;this.object=a};NGL.Surface.prototype={};NGL.Script=function(a,b,c){var d=signals;this.signals={elementAdded:new d.Signal,nameChanged:new d.Signal};this.name=b;this.path=c;this.dir=c.substring(0,c.lastIndexOf("/")+1);try{this.fn=new Function("stage","panel","__name__","__path__","__dir__",Object.keys(NGL.makeScriptHelper()).join(","),a)}catch(e){console.error("NGL.Script compilation failed",e),this.fn=null}};
NGL.Script.prototype={call:function(a,b){function c(){"function"===typeof b&&b()}var d=this,e={add:function(a){d.signals.elementAdded.dispatch(arguments)},setName:function(a){d.signals.nameChanged.dispatch(a)}},f=new NGL.ScriptQueue(a,this.dir,b),g=NGL.makeScriptHelper(a,f,e);if(this.fn){var h=[a,e,this.name,this.path,this.dir];try{this.fn.apply(null,h.concat(Object.values(g)))}catch(k){console.error("NGL.Script.fn",k)}}else console.log("NGL.Script.call no function available");f.then(c,function(){e.add(new UI.Text("ERROR"));
c()})}};NGL.ScriptQueue=function(a,b,c){this.stage=a;this.dir=b||"";this.onFinish=c;this.promise=new Promise(function(a,b){a()})};
NGL.ScriptQueue.prototype={load:function(a,b,c,d){var e={};this.stage.loadFile(this.dir+a,function(a){a.requestGuiVisibility(!1);"function"===typeof c&&c(a);e.resolve?e.resolve():e.success=!0},b,function(a){e.reject?e.reject(a):e.error=a||"error"},d);var f=function(a,b){!0===e.success?a():void 0!==e.error?b(e.error):(e.resolve=a,e.reject=b)};this.promise=this.promise.then(function(){return new Promise(f)})},then:function(a,b){this.promise=this.promise.then(a,function(a){console.error("NGL.ScriptQueue.then",
a);"function"===typeof b&&b()})}};
NGL.makeScriptHelper=function(a,b,c){function d(b,c){a.eachComponent(function(a){(!b||b&&!b.repr&&NGL.ObjectMetadata.test(b,null,a))&&a.setVisibility(c);b&&b.repr&&a.eachRepresentation(function(d){NGL.ObjectMetadata.test(b,d,a)&&d.setVisibility(c)})},NGL.StructureComponent)}function e(a){d(a,!1)}function f(a){a=void 0===a?1:a;for(var b=0;b<a;++b)c.add(new UI.Break)}var g=NGL.unicodeHelper;return{load:function(){b.load.apply(b,arguments)},then:function(){b.then.apply(b,arguments)},structure:function(b){var c;
a.eachComponent(function(a){if(b===a.name||b===a.id)c=a},NGL.StructureComponent);return c},visibility:d,hide:e,show:function(a,b){b&&e();d(a,!0)},superpose:function(a,b,c,d,e,f,g){a.superpose(b,c,d,e,f,g)},uiText:function(a,b){var d=new UI.Text(g(a));c.add(d);b&&f(1);return d},uiHtml:function(a,b){var d=new UI.Html(g(a));c.add(d);b&&f(1);return d},uiBreak:f,uiButton:function(a,b){var d=(new UI.Button(g(a))).onClick(function(){b(d)});c.add(d);return d},uiToggleButton:function(a,b,d,e){var f=!0,q=(new UI.Button(g(b))).onClick(function(){f?
(f=!1,q.setLabel(g(a)),e()):(f=!0,q.setLabel(g(b)),d())});c.add(q);return q},uiVisibilityButton:function(b,e){function f(){var b=!1;a.eachComponent(function(a){(!e||e&&!e.repr&&NGL.ObjectMetadata.test(e,null,a))&&a.visible&&(b=!0);e&&e.repr&&a.eachRepresentation(function(c){NGL.ObjectMetadata.test(e,c,a)&&c.visible&&(b=!0)})},NGL.StructureComponent);return b}function n(a){return(f()?"hide ":"show ")+b}b||(b=e?"":"all");b=g(b);a.eachComponent(function(a){(!e||e&&!e.repr&&NGL.ObjectMetadata.test(e,
null,a))&&a.signals.visibilityChanged.add(function(a){m.setLabel(n())});a.eachRepresentation(function(b){NGL.ObjectMetadata.test(e,b,a)&&b.signals.visibilityChanged.add(function(a){m.setLabel(n())})})},NGL.StructureComponent);var m=(new UI.Button(n())).onClick(function(){d(e,!f())});c.add(m);return m},uiPlayButton:function(a,b,d,e,f,q){a=g(a);var s=new NGL.TrajectoryPlayer(b,d,e,f,q);s.mode="once";var p=(new UI.Button("play "+a)).onClick(function(){s.toggle()});s.signals.startedRunning.add(function(){p.setLabel("pause "+
a)});s.signals.haltedRunning.add(function(){p.setLabel("play "+a)});c.add(p);return p}}};"function"===typeof importScripts&&(importScripts("../three/three.js","../lib/ui/signals.min.js","core.js","structure.js"),onmessage=function(a){NGL.GroParser.parseAtoms(a.data,function(a){var c=a.toObject();c.bonds=null;c.residue=null;postMessage(c,a.getBufferList())})});
NGL.StructureParser=function(a,b,c){c=c||{};this.name=a;this.path=b;this.firstModelOnly=c.firstModelOnly||!1;this.asTrajectory=c.asTrajectory||!1;this.structure=new NGL.Structure(this.name,this.path)};NGL.StructureParser.prototype={parse:function(a,b){this._parse(a,function(a){a.postProcess();"function"===typeof b&&b(a)});return this.structure},_parse:function(a,b){console.warn("NGL.StructureParser._parse not implemented")}};NGL.PdbParser=function(a,b,c){NGL.StructureParser.call(this,a,b,c)};
NGL.PdbParser.prototype=Object.create(NGL.StructureParser.prototype);
NGL.PdbParser.prototype._parse=function(a,b){function c(){for(A=aa;A<Y;A++)if(v=u[A],B=v.substr(0,6),"ATOM  "===B||"HETATM"===B){var a=parseFloat(v.substr(30,8)),z=parseFloat(v.substr(38,8)),R=parseFloat(v.substr(46,8));if(h){var J=3*q;m[J+0]=a;m[J+1]=z;m[J+2]=R;q+=1;if(n)continue}D=v[16];if(" "===D||"A"===D)G=parseInt(v.substr(6,5)),O=v.substr(12,4).trim(),K=v.substr(76,2).trim(),C=v[21],F=parseInt(v.substr(22,5)),H=v.substr(17,4).trim(),L||(E.chainname=C,I[C]=E,N.resno=F,N.resname=H,V=C,W=F),V!==
C&&(I[C]?E=I[C]:(E=M.addChain(),E.chainname=C,I[C]=E)),W!==F&&(N=E.addResidue(),N.resno=F,N.resname=H),K||(K=x(O)),L=N.addAtom(),L.bonds=[],L.resname=H,L.x=a,L.y=z,L.z=R,L.element=K,L.hetero="H"===v[0]?!0:!1,L.chainname=C,L.resno=F,L.serial=G,L.atomname=O,L.ss="c",L.bfactor=parseFloat(v.substr(60,8)),L.altloc=D,L.vdw=y[K],L.covalent=t[K],U[G]=L,V=C,W=F,p.push(L)}else if("CONECT"===B){a=U[parseInt(v.substr(6,5))];z=[11,16,21,26];for(J=0;4>J;J++)R=U[parseInt(v.substr(z[J],5))],void 0!==R&&r.addBond(a,
R);f.hasConnect=!0}else if("HELIX "===B){var J=v[19],a=parseInt(v.substr(21,4)),z=v[31],R=parseInt(v.substr(33,4)),ea=parseInt(v.substr(39,1)),ea=w[ea]||w[""];P.push([J,a,z,R,ea])}else if("SHEET "===B)J=v[21],a=parseInt(v.substr(22,4)),z=v[32],R=parseInt(v.substr(33,4)),Q.push([J,a,z,R]);else if("REMARK"===B&&"350"===v.substr(7,3))"BIOMOLECULE:"===v.substr(11,12)?(J=v.substr(23).trim(),s[J]={matrixDict:{},chainList:[]},ba=s[J]):"BIOMT"===v.substr(13,5)?(J=parseInt(v[18])-1,a=v.substr(20,3).trim(),
0===J&&(ba.matrixDict[a]=new THREE.Matrix4),a=ba.matrixDict[a].elements,a[0+J]=parseFloat(v.substr(24,9)),a[4+J]=parseFloat(v.substr(34,9)),a[8+J]=parseFloat(v.substr(44,9)),a[12+J]=parseFloat(v.substr(54,14))):"APPLY THE FOLLOWING TO CHAINS:"!==v.substr(11,30)&&"                   AND CHAINS:"!==v.substr(11,30)||v.substr(41,30).split(",").forEach(function(a){ba.chainList.push(a.trim())});else if("HEADER"===B)v.substr(62,4);else if("TITLE "===B)S+=v.substr(10,70)+"\n";else if("MODEL "===B)h?(n?(m=
new Float32Array(3*p.length),k.push(m)):m=[],q=0):L&&(M=f.addModel(),E=M.addChain(),N=E.addResidue(),L=void 0,I={},U={});else if("ENDMDL"===B){if(g){Y=Z;break}h&&!n&&(k.push(new Float32Array(m)),n=!0)}else"CRYST1"===B&&(J=new Float32Array(9),J[0]=parseFloat(v.substr(6,9)),J[4]=parseFloat(v.substr(15,9)),J[8]=parseFloat(v.substr(24,9)),l.push(J));Y===Z?(console.timeEnd(e),h&&(f.frames=k,f.boxes=l),d(),b(f)):(aa+=1E4,Y=Math.min(Y+1E4,Z),setTimeout(c))}function d(){console.time("NGL.PdbParser parse ss");
for(z=0;z<Q.length;z++){var a=new NGL.Selection(Q[z][1]+"-"+Q[z][3]+":"+Q[z][0]);f.eachResidue(function(a){a.ss="s"},a)}for(z=0;z<P.length;z++){var a=new NGL.Selection(P[z][1]+"-"+P[z][3]+":"+P[z][0]),b=P[z][4];f.eachResidue(function(a){a.ss=b},a)}console.timeEnd("NGL.PdbParser parse ss");0===Q.length&&0===P.length&&(f._doAutoSS=!0);var c=!0;f.eachChain(function(a){a.chainname&&" "!==a.chainname&&(c=!1)});f._doAutoChainName=c}var e="NGL.PdbParser._parse "+this.name;console.time(e);var f=this.structure,
g=this.firstModelOnly,h=this.asTrajectory,k=[],l=[],n=!1,m,q;f.title="";f.id="";f.sheet=[];f.helix=[];f.biomolDict={};var s=f.biomolDict,p=f.atoms,r=f.bondSet,u=a.split("\n"),x=NGL.guessElement,t=NGL.CovalentRadii,y=NGL.VdwRadii,w=NGL.HelixTypes,A,z,v,B,D,G,C,F,H,O,K,M=f.addModel(),E=M.addChain(),N=E.addResidue(),I={},U={},S=f.title,Q=f.sheet,P=f.helix;f.hasConnect=!1;var L,V,W,ba,Z=u.length,aa=0,Y=Math.min(1E4,Z);setTimeout(c)};
NGL.GroParser=function(a,b,c){NGL.StructureParser.call(this,a,b,c);this.structure._doAutoSS=!0;this.structure._doAutoChainName=!0};NGL.GroParser.prototype=Object.create(NGL.StructureParser.prototype);
NGL.GroParser.prototype._build=function(){console.time("NGL.GroParser._build");var a=this.structure,b=a.atoms.length,c,d,e=a.addModel().addChain(),f=e.addResidue();f.resno=a.atoms[0].resno;f.resname=a.atoms[0].resname;var g=a.atoms[0].resno;for(c=0;c<b;++c)d=a.atoms[c],g!==d.resno&&(f=e.addResidue(),f.resno=d.resno,f.resname=d.resname),f.addAtom(d),g=d.resno;console.timeEnd("NGL.GroParser._build")};
NGL.GroParser.prototype._parse=function(a,b){console.time("NGL.GroParser._parse");var c=this.structure,d=this.firstModelOnly,e=this.asTrajectory,f=this,g=a.split("\n");c.title=g[0].trim();c.size=parseInt(g[1]);g=g[g.length-1].trim().split(/\s+/);c.box=[10*parseFloat(g[0]),10*parseFloat(g[1]),10*parseFloat(g[2])];g=NGL.GroParser.parseAtomsChunked;g(a,d,e,function(a,d,g){c.atomCount=a.length;e&&(c.frames=d,c.boxes=g);if(Array.isArray(a))c.atoms=a;else for(c.atomArray=a,g=c.atomCount,d=0;d<g;++d)c.atoms.push(new NGL.ProxyAtom(a,
d));console.timeEnd("NGL.GroParser._parse");f._build();b(c)})};
NGL.GroParser.parseAtoms=function(a,b,c,d){console.time("NGL.GroParser._parseAtoms");a=a.trim().split("\n");b=NGL.guessElement;c=NGL.CovalentRadii;var e=NGL.VdwRadii,f,g,h,k,l,n=new NGL.AtomArray(parseInt(a[1])),m=new NGL.ProxyAtom(n,0),q=a.length-1;for(f=2;f<q;++f)g=a[f],h=g.substr(10,5).trim(),l=g.substr(5,5).trim(),k=b(h),m.resname=l,m.x=10*parseFloat(g.substr(20,8)),m.y=10*parseFloat(g.substr(28,8)),m.z=10*parseFloat(g.substr(36,8)),m.element=k,m.resno=parseInt(g.substr(0,5)),m.serial=parseInt(g.substr(15,
5)),m.atomname=h,m.ss="c",m.vdw=e[k],m.covalent=c[k],m.index+=1;console.timeEnd("NGL.GroParser._parseAtoms");d(n)};
NGL.GroParser.parseAtomsChunked=function(a,b,c,d){var e;function f(){for(p=B;p<D;++p)if(r=g[p],0===p%w)c&&(l=new Float32Array(3*y),h.push(l),n=0);else if(1!==p%w)if(p%w===w-1){r.trim().split(/\s+/);var a=new Float32Array(9);a[0]=10*parseFloat(a[0]);a[4]=10*parseFloat(a[1]);a[8]=10*parseFloat(a[2]);k.push(a);if(b){D=v;break}}else{var a=10*parseFloat(r.substr(20,8)),C=10*parseFloat(r.substr(28,8)),F=10*parseFloat(r.substr(36,8));if(c){var H=3*n;l[H+0]=a;l[H+1]=C;l[H+2]=F;n+=1;if(p>w)continue}u=r.substr(10,
5).trim();t=r.substr(5,5).trim();x=m(u);e=new NGL.Atom;e.bonds=[];e.resname=t;e.x=a;e.y=C;e.z=F;e.element=x;e.resno=parseInt(r.substr(0,5));e.serial=parseInt(r.substr(15,5));e.atomname=u;e.ss="c";e.vdw=s[x];e.covalent=q[x];z.push(e);e.index=A;A+=1}D===v?(console.timeEnd("NGL.GroParser._parseAtomsChunked"),d(z,h,k)):(B+=1E4,D=Math.min(D+1E4,v),setTimeout(f))}console.time("NGL.GroParser._parseAtomsChunked");var g=a.trim().split("\n"),h=[],k=[],l,n,m=NGL.guessElement,q=NGL.CovalentRadii,s=NGL.VdwRadii,
p,r,u,x,t,y=parseInt(g[1]),w=y+3,A=0,z=[],v=g.length,B=0,D=Math.min(1E4,v);setTimeout(f)};NGL.GroParser.parseAtomsWorker=function(a,b,c,d){console.time("NGL.GroParser._parseAtomsWorker");var e=new Worker("../js/ngl/parser.js");e.onmessage=function(a){e.terminate();a=new NGL.AtomArray(a.data);console.timeEnd("NGL.GroParser._parseAtomsWorker");d(a)};e.onerror=function(a){console.error(a)};e.postMessage(a)};
NGL.CifParser=function(a,b,c){c=c||{};this.cAlphaOnly=c.cAlphaOnly||!1;NGL.StructureParser.call(this,a,b,c)};NGL.CifParser.prototype=Object.create(NGL.StructureParser.prototype);
NGL.CifParser.prototype._parse=function(a,b){function c(){for(r=R;r<J;r++)if((u=m[r].trim())&&"#"!==u[0])if("data_"===u.substring(0,5))u.substring(5);else if(";"===u[0])C?(G[K][M]=F,C=!1,F=null):(C=!0,F=u.substring(1));else if("loop_"===u)H=!0,O=[],I=[];else if("_"===u[0])if(H){var a=u.split("."),p=a[0].substring(1),a=a[1];G[p]||(G[p]={});G[p][a]?console.warn(p,a,"already exists"):(G[p][a]=[],O.push(G[p][a]),I.push(a));K=p;M=a;E=!0}else{var p=u.split(D),$=p[1],a=p[0].split("."),p=a[0].substring(1),
a=a[1];G[p]||(G[p]={});G[p][a]?console.warn(p,a,"already exists"):G[p][a]=$;K=p;M=a}else if(H)if("atom_site"===K){$=I.length;p=u.split(B);if(E){a="group_PDB id label_atom_id label_seq_id label_comp_id type_symbol label_asym_id Cartn_x Cartn_y Cartn_z B_iso_or_equiv label_alt_id".split(" ");N=[];for(var T=0;T<$;++T)-1!==a.indexOf(I[T])&&N.push(T);U=I.indexOf("label_atom_id");S=I.indexOf("label_alt_id");Q=I.indexOf("Cartn_x");P=I.indexOf("Cartn_y");L=I.indexOf("Cartn_z");V=I.indexOf("id");W=I.indexOf("type_symbol");
ba=I.indexOf("label_asym_id");Z=I.indexOf("label_seq_id");aa=I.indexOf("label_comp_id");Y=I.indexOf("group_PDB");ha=I.indexOf("B_iso_or_equiv");E=!1;y.resno=p[Z];y.resname=p[aa]}$=p[U];if(!h||"CA"===$)if(a=p[S],"."===a||"A"===a){var T=parseFloat(p[Q]),ia=parseFloat(p[P]),ja=parseFloat(p[L]),ka=parseInt(p[V]),fa=p[W],X=p[ba],ca=p[Z],ga=p[aa];A||(t.chainname=X,w[X]=t,y.resno=ca,y.resname=ga,z=X,v=ca);z!==X&&(w[X]?t=w[X]:(t=x.addChain(),t.chainname=X,w[X]=t));v!==ca&&(y=t.addResidue(),y.resno=ca,y.resname=
ga);A=y.addAtom();A.bonds=[];A.resname=ga;A.x=T;A.y=ia;A.z=ja;A.element=fa;A.hetero="H"===p[Y][0]?!0:!1;A.chainname=X;A.resno=ca;A.serial=ka;A.atomname=$;A.ss="c";A.bfactor=parseFloat(p[ha]);A.altloc=a;A.vdw=s[fa];A.covalent=q[fa];v=ca;n.push(A)}}else for(p=u.split(D),$=p.length,T=0;T<$;++T)O[T].push(p[T]);else C?F+=" "+u:"'"===u[0]&&"'"===u.substring(u.length-1)?G[K][M]=u.substring(1,u.length-2):console.log("???",u);else H=C=!1,I=N=E=M=K=O=null;J===da?(console.timeEnd(e),g&&(f.frames=k,f.boxes=l),
d(),b(f)):(console.log(R,da),R+=1E4,J=Math.min(J+1E4,da),setTimeout(c))}function d(){console.time("NGL.CifParser _postProcess");var a=G.struct_conf,b=a.id.length;if(a)for(var c=0;c<b;++c){var d=new NGL.Selection(a.beg_label_seq_id[c]+"-"+a.end_label_seq_id[c]+":"+a.beg_label_asym_id[c]),e=parseInt(a.pdbx_PDB_helix_class[c]),e=p[e]||p[""];f.eachResidue(function(a){a.ss=e},d)}var b=G.struct_sheet_range,g=b.id.length;if(b)for(c=0;c<g;++c)d=new NGL.Selection(b.beg_label_seq_id[c]+"-"+b.end_label_seq_id[c]+
":"+b.beg_label_asym_id[c]),f.eachResidue(function(a){a.ss="s"},d);a||b||(f._doAutoSS=!0);var h=!0;f.eachChain(function(a){a.chainname&&(h=!1)});f._doAutoChainName=h;console.timeEnd("NGL.CifParser _postProcess")}var e="NGL.CifParser._parse "+this.name;console.time(e);var f=this.structure,g=this.asTrajectory,h=this.cAlphaOnly,k=[],l=[];f.title="";f.id="";f.sheet=[];f.helix=[];f.biomolDict={};var n=f.atoms,m=a.split("\n");1E6<m.length&&(h=!0);var q=NGL.CovalentRadii,s=NGL.VdwRadii,p=NGL.HelixTypes,
r,u,x=f.addModel(),t=x.addChain(),y=t.addResidue(),w={};f.hasConnect=!1;var A,z,v,B=/\s+/,D=/\s+(?=(?:[^']*'[^']*')*[^']*$)/,G={},C=!1,F=null,H=!1,O=null,K=null,M=null,E=null,N=null,I=null,U,S,Q,P,L,V,W,ba,Z,aa,Y,ha,da=m.length,R=0,J=Math.min(1E4,da);setTimeout(c)};NGL.Uint8ToString=function(a){for(var b=[],c=0;c<a.length;c+=32768)b.push(String.fromCharCode.apply(null,a.subarray(c,c+32768)));return b.join("")};
NGL.decompress=function(a,b){var c,d=NGL.getFileInfo(b).ext;console.time("decompress "+d);a instanceof ArrayBuffer&&(a=new Uint8Array(a));if("gz"===d)c=pako.ungzip(a,{to:"string"});else if("zip"===d){c=new JSZip(a);var e=Object.keys(c.files)[0];c=c.files[e].asText()}else"lzma"===d?(c={data:[],offset:0,writeByte:function(a){this.data[this.offset++]=a}},LZMA.decompressFile({data:a,offset:0,readByte:function(){return this.data[this.offset++]}},c),c=new Uint8Array(c.data),c=NGL.Uint8ToString(c)):"bz2"===
d?(c=bzip2.array(a),c=bzip2.simple(c)):(console.warn("no decompression method available for '"+d+"'"),c=a);console.timeEnd("decompress "+d);return c};NGL.XHRLoader=function(a){this.cache=new THREE.Cache;this.manager=void 0!==a?a:THREE.DefaultLoadingManager};
NGL.XHRLoader.prototype={constructor:NGL.XHRLoader,load:function(a,b,c,d){var e=this,f=e.cache.get(a);if(void 0!==f)b&&b(f);else{var g=new XMLHttpRequest;g.open("GET",a,!0);g.addEventListener("load",function(c){200===g.status||304===g.status?(c=this.response,"arraybuffer"===e.responseType&&(c=NGL.decompress(c,a)),e.cache.add(a,c),b&&b(c)):d&&d(g.status);e.manager.itemEnd(a)},!1);void 0!==c&&g.addEventListener("progress",function(a){c(a)},!1);void 0!==d&&g.addEventListener("error",function(a){d(a)},
!1);void 0!==this.crossOrigin&&(g.crossOrigin=this.crossOrigin);void 0!==this.responseType&&(g.responseType=this.responseType);g.send(null);e.manager.itemStart(a)}},setResponseType:function(a){this.responseType=a},setCrossOrigin:function(a){this.crossOrigin=a}};NGL.FileLoader=function(a){this.cache=new THREE.Cache;this.manager=void 0!==a?a:THREE.DefaultLoadingManager};
NGL.FileLoader.prototype={constructor:NGL.FileLoader,load:function(a,b,c,d){var e=this,f=e.cache.get(a);void 0!==f?b(f):(f=new FileReader,f.onload=function(c){c=c.target.result;"arraybuffer"===e.responseType&&(c=NGL.decompress(c,a));b(c);e.manager.itemEnd(a)},void 0!==c&&(f.onprogress=function(a){c(a)}),void 0!==d&&(f.onerror=function(a){d(a)}),"arraybuffer"===this.responseType?(console.log("moin"),f.readAsArrayBuffer(a)):f.readAsText(a),e.manager.itemStart(a))},setResponseType:function(a){this.responseType=
a.toLowerCase()}};NGL.StructureLoader=function(a){this.cache=new THREE.Cache;this.manager=void 0!==a?a:THREE.DefaultLoadingManager};NGL.StructureLoader.prototype=Object.create(NGL.XHRLoader.prototype);NGL.StructureLoader.prototype.init=function(a,b,c,d,e,f){f=f||{};return(new {gro:NGL.GroParser,pdb:NGL.PdbParser,cif:NGL.CifParser}[d](b,c,f)).parse(a,e)};NGL.ObjLoader=function(a){this.manager=void 0!==a?a:THREE.DefaultLoadingManager};NGL.ObjLoader.prototype=Object.create(THREE.OBJLoader.prototype);
NGL.ObjLoader.prototype.init=function(a,b,c,d,e){"string"===typeof a&&(a=this.parse(a));a=new NGL.Surface(a,b,c);"function"===typeof e&&e(a);return a};NGL.PlyLoader=function(a){};NGL.PlyLoader.prototype=Object.create(THREE.PLYLoader.prototype);NGL.PlyLoader.prototype.init=function(a,b,c,d,e){"string"===typeof a&&(a=this.parse(a));a=new NGL.Surface(a,b,c);"function"===typeof e&&e(a);return a};NGL.ScriptLoader=function(a){this.cache=new THREE.Cache;this.manager=void 0!==a?a:THREE.DefaultLoadingManager};
NGL.ScriptLoader.prototype=Object.create(NGL.XHRLoader.prototype);NGL.ScriptLoader.prototype.init=function(a,b,c,d,e){a=new NGL.Script(a,b,c);"function"===typeof e&&e(a);return a};
NGL.autoLoad=function(){var a={gro:NGL.StructureLoader,pdb:NGL.StructureLoader,cif:NGL.StructureLoader,obj:NGL.ObjLoader,ply:NGL.PlyLoader,ngl:NGL.ScriptLoader};return function(b,c,d,e,f){function g(a){a?k=n.init(a,s,q,p,function(a){"function"===typeof c&&c(a)},f):h("empty response")}function h(a){"function"===typeof e?e(a):console.error(a)}var k,l,n,m=NGL.getFileInfo(b),q=m.path,s=m.name,p=m.ext,m=!1;4===s.length&&s==q&&s.toLowerCase()===p&&(p="pdb",b="http://www.rcsb.org/pdb/files/"+s+".pdb",l=
!0);"gz"===p?(m=NGL.getFileInfo(q.substr(0,q.length-3)),p=m.ext,m=!0):"zip"===p?(m=NGL.getFileInfo(q.substr(0,q.length-4)),p=m.ext,m=!0):"lzma"===p?(m=NGL.getFileInfo(q.substr(0,q.length-5)),p=m.ext,m=!0):"bz2"===p&&(m=NGL.getFileInfo(q.substr(0,q.length-4)),p=m.ext,m=!0);if(p in a)n=new a[p];else return h("NGL.autoLoading: ext '"+p+"' unknown"),null;b instanceof File?(s=b.name,l=new NGL.FileLoader,m&&l.setResponseType("arraybuffer"),l.load(b,g,d,h)):l?(m&&n.setResponseType("arraybuffer"),n.load(b,
g,d,h)):(m&&n.setResponseType("arraybuffer"),n.load("../data/"+b,g,d,h));return k}}();
NGL.Resources={"../fonts/Arial.fnt":"","../fonts/Arial.png":"image","../fonts/DejaVu.fnt":"","../fonts/DejaVu.png":"image","../fonts/LatoBlack.fnt":"","../fonts/LatoBlack.png":"image","../img/circle.png":"image","../img/spark1.png":"image","../shader/CylinderImpostor.vert":"","../shader/CylinderImpostor.frag":"","../shader/HyperballStickImpostor.vert":"","../shader/HyperballStickImpostor.frag":"","../shader/Line.vert":"","../shader/Line.frag":"","../shader/LineSprite.vert":"","../shader/LineSprite.frag":"",
"../shader/Mesh.vert":"","../shader/Mesh.frag":"","../shader/ParticleSprite.vert":"","../shader/ParticleSprite.frag":"","../shader/Quad.vert":"","../shader/Quad.frag":"","../shader/Ribbon.vert":"","../shader/Ribbon.frag":"","../shader/SDFFont.vert":"","../shader/SDFFont.frag":"","../shader/SphereHalo.vert":"","../shader/SphereHalo.frag":"","../shader/SphereImpostor.vert":"","../shader/SphereImpostor.frag":"","../shader/chunk/fog.glsl":"","../shader/chunk/fog_params.glsl":"","../shader/chunk/light.glsl":"",
"../shader/chunk/light_params.glsl":""};NGL.UniformsLib={fog:THREE.UniformsLib.fog,lights:THREE.UniformsUtils.merge([THREE.UniformsLib.lights,{ambient:{type:"c",value:new THREE.Color(16777215)},emissive:{type:"c",value:new THREE.Color(0)}}])};
NGL.Utils={lineLineIntersect:function(a,b,c,d){var e=NGL.EPS,f=new THREE.Vector3,g=new THREE.Vector3,h=new THREE.Vector3,k,l;f.x=a.x-c.x;f.y=a.y-c.y;f.z=a.z-c.z;g.x=d.x-c.x;g.y=d.y-c.y;g.z=d.z-c.z;if(Math.abs(g.x)<e&&Math.abs(g.y)<e&&Math.abs(g.z)<e)return null;h.x=b.x-a.x;h.y=b.y-a.y;h.z=b.z-a.z;if(Math.abs(h.x)<e&&Math.abs(h.y)<e&&Math.abs(h.z)<e)return null;b=f.x*g.x+f.y*g.y+f.z*g.z;d=g.x*h.x+g.y*h.y+g.z*h.z;k=f.x*h.x+f.y*h.y+f.z*h.z;f=g.x*g.x+g.y*g.y+g.z*g.z;l=(h.x*h.x+h.y*h.y+h.z*h.z)*f-d*d;
if(Math.abs(l)<e)return null;e=(b*d-k*f)/l;b=(b+d*e)/f;a=new THREE.Vector3(a.x+e*h.x,a.y+e*h.y,a.z+e*h.z);c=new THREE.Vector3(c.x+b*g.x,c.y+b*g.y,c.z+b*g.z);return[a,c]},circularMean:function(){var a=2*Math.PI;return function(b,c,d,e,f){d=d||1;e=e||0;var g=f?f.length:b.length,h,k,l=0,n=0;if(f)for(k=0;k<g;++k)h=(b[f[k]*d+e]+c)%c,h=h/c*a-Math.PI,l+=Math.cos(h),n+=Math.sin(h);else for(k=e;k<g;k+=d)h=(b[k]+c)%c,h=h/c*a-Math.PI,l+=Math.cos(h),n+=Math.sin(h);return(Math.atan2(n/g,l/g)+Math.PI)/a*c}}(),
calculateCenterArray:function(a,b,c,d){var e=a.length;c=c||new Float32Array(e);d=d||0;for(var f=0;f<e;f+=3)c[d+f+0]=(a[f+0]+b[f+0])/2,c[d+f+1]=(a[f+1]+b[f+1])/2,c[d+f+2]=(a[f+2]+b[f+2])/2;return c},calculateDirectionArray:function(a,b){for(var c=a.length,d=new Float32Array(c),e=0;e<c;e+=3)d[e+0]=b[e+0]-a[e+0],d[e+1]=b[e+1]-a[e+1],d[e+2]=b[e+2]-a[e+2];return d},positionFromGeometry:function(a){a=a.vertices;for(var b,c,d=a.length,e=new Float32Array(3*d),f=0;f<d;f++)b=3*f,c=a[f],e[b+0]=c.x,e[b+1]=c.y,
e[b+2]=c.z;return e},colorFromGeometry:function(a){for(var b=a.faces,c,d,e=b.length,f=new Float32Array(3*a.vertices.length),g=0;g<e;g++)c=b[g],d=c.color,a=3*c.a,f[a+0]=d.r,f[a+1]=d.g,f[a+2]=d.b,a=3*c.b,f[a+0]=d.r,f[a+1]=d.g,f[a+2]=d.b,a=3*c.c,f[a+0]=d.r,f[a+1]=d.g,f[a+2]=d.b;return f},indexFromGeometry:function(a){a=a.faces;for(var b,c,d=a.length,e=new Uint32Array(3*d),f=0;f<d;f++)b=3*f,c=a[f],e[b+0]=c.a,e[b+1]=c.b,e[b+2]=c.c;return e},normalFromGeometry:function(a){for(var b=a.faces,c,d,e,f,g=b.length,
h=new Float32Array(3*a.vertices.length),k=0;k<g;k++)a=b[k],c=a.vertexNormals,d=c[0],e=c[1],f=c[2],c=3*a.a,h[c+0]=d.x,h[c+1]=d.y,h[c+2]=d.z,c=3*a.b,h[c+0]=e.x,h[c+1]=e.y,h[c+2]=e.z,c=3*a.c,h[c+0]=f.x,h[c+1]=f.y,h[c+2]=f.z;return h},uniformArray:function(a,b){for(var c=new Float32Array(a),d=0;d<a;++d)c[d]=b;return c},uniformArray3:function(a,b,c,d){for(var e=new Float32Array(3*a),f,g=0;g<a;++g)f=3*g,e[f+0]=b,e[f+1]=c,e[f+2]=d;return e},randomColorArray:function(a){for(var b=new Float32Array(3*a),c,
d=0;d<a;++d)c=3*d,b[c+0]=Math.random(),b[c+1]=Math.random(),b[c+2]=Math.random();return b},replicateArray3Entries:function(a,b){var c=a.length/3,d=new Float32Array(c*b*3),e,f,g,h,k,l,n;for(e=0;e<c;++e)for(f=3*e,g=e*b*3,k=a[f+0],l=a[f+1],n=a[f+2],f=0;f<b;++f)h=g+3*f,d[h+0]=k,d[h+1]=l,d[h+2]=n;return d},calculateMeanArray:function(a,b){for(var c=a.length,d=new Float32Array(c),e=0;e<c;e++)d[e]=(a[e]+b[e])/2;return d},calculateMinArray:function(a,b){for(var c=a.length,d=new Float32Array(c),e=0;e<c;e++)d[e]=
Math.min(a[e],b[e]);return d},calculateMeanVector3:function(a){var b=a.length,c=a.length/3,d=0,e=0,f=0,g;for(g=0;g<b;g+=3)d+=a[g+0],e+=a[g+1],f+=a[g+2];return new THREE.Vector3(d/c,e/c,f/c)},isPointOnSegment:function(a,b,c){var d=b.distanceTo(c);return a.distanceTo(b)<=d&&a.distanceTo(c)<=d},pointVectorIntersection:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c,d,e){a.copy(e);b.subVectors(c,d);c=Math.cos(a.angleTo(b))*b.length();c=a.normalize().multiplyScalar(c);return(new THREE.Vector3).addVectors(c,
d)}}(),copyArray:function(a,b,c,d,e){var f;for(f=0;f<e;++f)b[d+f]=a[c+f]}};NGL.init=function(a){this.textures=[];NGL.initResources(a);return this};NGL.initResources=function(a){var b=new THREE.LoadingManager(function(){console.log("NGL initialized");void 0!==a&&a()}),c=new THREE.ImageLoader(b),d=new THREE.XHRLoader(b);Object.keys(NGL.Resources).forEach(function(a){"image"==NGL.Resources[a]?c.load(a,function(b){NGL.Resources[a]=b}):d.load(a,function(b){NGL.Resources[a]=b})})};
NGL.getShader=function(a){return NGL.Resources["../shader/"+a].replace(/^(?!\/\/)\s*#include\s+(\S+)/gmi,function(a,c){var d=NGL.Resources["../shader/chunk/"+c+".glsl"]||THREE.ShaderChunk[c];return d?d:""})};
NGL.trimCanvas=function(a,b,c,d,e){var f=a.height,g=a.width,h=a.getContext("2d").getImageData(0,0,g,f).data,k,l,n;n=!1;for(l=0;l<f;l++){for(k=0;k<g;k++){var m=4*(l*g+k);if(h[m]!==b||h[m+1]!==c||h[m+2]!==d||h[m+3]!==e){n=!0;break}}if(n)break}var q=l;n=!1;for(k=0;k<g;k++){for(l=0;l<f;l++)if(m=4*(l*g+k),h[m]!==b||h[m+1]!==c||h[m+2]!==d||h[m+3]!==e){n=!0;break}if(n)break}var s=k;n=!1;for(l=f-1;0<=l;l--){for(k=g-1;0<=k;k--)if(m=4*(l*g+k),h[m]!==b||h[m+1]!==c||h[m+2]!==d||h[m+3]!==e){n=!0;break}if(n)break}var p=
l;n=!1;for(k=g-1;0<=k;k--){for(l=f-1;0<=l;l--)if(m=4*(l*g+k),h[m]!==b||h[m+1]!==c||h[m+2]!==d||h[m+3]!==e){n=!0;break}if(n)break}b=k;c=document.createElement("canvas");c.style.display="hidden";document.body.appendChild(c);c.width=b-s;c.height=p-q;c.getContext("2d").drawImage(a,s,q,c.width,c.height,0,0,c.width,c.height);return c};
NGL.Viewer=function(a){a?(this.eid=a,this.container=document.getElementById(a),this.container===document?(this.width=window.innerWidth,this.height=window.innerHeight):(a=this.container.getBoundingClientRect(),this.width=a.width,this.height=a.height)):this.container=document.createElement("div");this.aspect=this.width/this.height;this.initParams();this.initCamera();this.initScene();this.initRenderer();this.initLights();this.initControls();window.addEventListener("resize",this.onWindowResize.bind(this),
!1);this.setBackground();this.setFog();this.boundingBox=new THREE.Box3};
NGL.Viewer.prototype={constructor:NGL.Viewer,initParams:function(){this.params={fogType:null,fogColor:0,fogNear:50,fogFar:100,fogDensity:2.5E-4,backgroundColor:0,cameraType:1,cameraFov:40,cameraZ:-80,clipNear:0,clipFar:100,clipDist:20,specular:328965}},initCamera:function(){var a=this.params,b=new THREE.Vector3(0,0,0);this.perspectiveCamera=new THREE.PerspectiveCamera(a.cameraFov,this.aspect,.1,1E4);this.perspectiveCamera.position.z=a.cameraZ;this.perspectiveCamera.lookAt(b);this.camera=this.perspectiveCamera;
this.camera.updateProjectionMatrix()},initRenderer:function(){this.renderer=new THREE.WebGLRenderer({preserveDrawingBuffer:!0,alpha:!0,antialias:!0,devicePixelRatio:window.devicePixelRatio});this.renderer.setSize(this.width,this.height);this.renderer.autoClear=!1;this.renderer.sortObjects=!0;var a=this.renderer.context.getExtension("EXT_frag_depth");a||console.info("EXT_frag_depth not available");NGL.extensionFragDepth=a;this.renderer.context.getExtension("OES_standard_derivatives")||console.error("OES_standard_derivatives not available");
this.renderer.context.getExtension("OES_element_index_uint")||(NGL.indexUint16=!0,console.info("OES_element_index_uint not available"));this.eid&&this.container.appendChild(this.renderer.domElement)},initScene:function(){this.scene||(this.scene=new THREE.Scene);this.rotationGroup=new THREE.Group;this.rotationGroup.name="rotationGroup";this.scene.add(this.rotationGroup);this.modelGroup=new THREE.Group;this.modelGroup.name="modelGroup";this.rotationGroup.add(this.modelGroup);this.pickingGroup=new THREE.Group;
this.pickingGroup.name="pickingGroup";this.rotationGroup.add(this.pickingGroup);this.backgroundGroup=new THREE.Group;this.backgroundGroup.name="backgroundGroup";this.rotationGroup.add(this.backgroundGroup);this.transparentGroup=new THREE.Group;this.transparentGroup.name="transparentGroup";this.rotationGroup.add(this.transparentGroup);this.surfaceGroup=new THREE.Group;this.surfaceGroup.name="surfaceGroup";this.rotationGroup.add(this.surfaceGroup);this.textGroup=new THREE.Group;this.textGroup.name=
"textGroup";this.rotationGroup.add(this.textGroup)},initLights:function(){var a=new THREE.DirectionalLight(16777215);a.position.copy((new THREE.Vector3(1,1,-2.5)).normalize());a.intensity=.5;var b=new THREE.AmbientLight(1052688),c=new THREE.HemisphereLight(16777215,.01);this.scene.add(a);this.scene.add(b);this.scene.add(c)},initControls:function(){this.controls=new THREE.TrackballControls(this.camera,this.renderer.domElement);this.controls.rotateSpeed=2;this.controls.zoomSpeed=1.2;this.controls.panSpeed=
.8;this.controls.staticMoving=!0;this.controls.keys=[65,83,68];this.controls.addEventListener("change",this.render.bind(this))},add:function(a,b,c){var d,e;d=new THREE.Group;a.pickable&&(e=new THREE.Group);b?b.forEach(function(b){this.addBuffer(a,d,e,c,b)},this):this.addBuffer(a,d,e,c);c?this.backgroundGroup.add(d):a instanceof NGL.TextBuffer?this.textGroup.add(d):a.transparent?a instanceof NGL.SurfaceBuffer?this.surfaceGroup.add(d):this.transparentGroup.add(d):this.modelGroup.add(d);a.pickable&&
this.pickingGroup.add(e);a.group=d;a.pickable&&(a.pickingGroup=e);this.rotationGroup.updateMatrixWorld();this.requestRender()},addBuffer:function(a,b,c,d,e){d=a.getMesh(d?"background":void 0);d.frustumCulled=!1;e&&(d.applyMatrix(e),d.userData.matrix=e);b.add(d);a.pickable&&(b=a.getMesh("picking"),b.frustumCulled=!1,e&&(b.applyMatrix(e),b.userData.matrix=e),c.add(b));this.updateBoundingBox(a.geometry,e)},remove:function(a){this.rotationGroup.children.forEach(function(b){b.remove(a.group)});a.pickable&&
this.pickingGroup.remove(a.pickingGroup);this.updateBoundingBox();this.requestRender()},updateBoundingBox:function(a,b){var c,d=this.boundingBox;this.boundingBoxMesh&&this.modelGroup.remove(this.boundingBoxMesh);a?(a.boundingBox||a.computeBoundingBox(),b?(c=a.boundingBox.clone(),c.applyMatrix4(b)):c=a.boundingBox,d.expandByPoint(c.min),d.expandByPoint(c.max)):(d.makeEmpty(),this.rotationGroup.traverse(function(a){void 0!==a.geometry&&(a.geometry.boundingBox||a.geometry.computeBoundingBox(),a.userData.matrix?
(c=a.geometry.boundingBox.clone(),c.applyMatrix4(a.userData.matrix)):c=a.geometry.boundingBox,d.expandByPoint(c.min),d.expandByPoint(c.max))}));this.controls.maxDistance=10*d.size().length();if(NGL.GET("debug")){var e=d.size(),f=new THREE.MeshBasicMaterial({color:16777215*Math.random(),wireframe:!0}),e=new THREE.BoxGeometry(e.x,e.y,e.z);this.boundingBoxMesh=new THREE.Mesh(e,f);d.center(this.boundingBoxMesh.position);this.modelGroup.add(this.boundingBoxMesh)}},fullscreen:function(){var a=this.container;
a.requestFullscreen?a.requestFullscreen():a.msRequestFullscreen?a.msRequestFullscreen():a.mozRequestFullScreen?a.mozRequestFullScreen():a.webkitRequestFullscreen&&a.webkitRequestFullscreen()},getImage:function(a,b){return this.renderer.domElement.toBlob(a,b)},setFog:function(a,b,c,d,e,f){f=this.params;null!==a&&(f.fogType=a);b&&(f.fogColor=b);c&&(f.fogNear=c);d&&(f.fogFar=d);e&&(f.fogDensity=e);this.requestRender()},setBackground:function(a){var b=this.params;a&&(b.backgroundColor=a);this.setFog(null,
b.backgroundColor);this.renderer.setClearColor(b.backgroundColor,1);this.requestRender()},setCamera:function(a,b,c,d){var e=this.params;null!==a&&(e.cameraType=a);b&&(e.cameraFov=b);c&&(e.cameraNear=c);d&&(e.cameraFar=d);this.camera=this.perspectiveCamera;this.perspectiveCamera.fov=e.cameraFov;this.perspectiveCamera.near=e.cameraNear;this.perspectiveCamera.far=e.cameraFar;this.controls.object=this.camera;this.camera.updateProjectionMatrix();this.requestRender()},setClip:function(a,b){var c=this.params;
a&&(c.clipNear=a);b&&(c.clipFar=b);this.requestRender()},onWindowResize:function(){this.renderer.devicePixelRatio=window.devicePixelRatio;if(this.container===document)this.width=window.innerWidth,this.height=window.innerHeight;else{var a=this.container.getBoundingClientRect();this.width=a.width;this.height=a.height}this.aspect=this.width/this.height;this.perspectiveCamera.aspect=this.aspect;this.camera.updateProjectionMatrix();this.renderer.setSize(this.width,this.height);this.controls.handleResize();
this.requestRender()},animate:function(){requestAnimationFrame(this.animate.bind(this));this.controls.update()},screenshot:function(a,b,c,d,e,f,g){function h(a){var d=b.split("/")[1];if(f){var h=new THREE.Color(k.params.backgroundColor);m=NGL.trimCanvas(m,255*h.r|0,255*h.g|0,255*h.b|0,e?0:255)}m.toBlob(function(b){NGL.download(b,"screenshot."+d);document.body.removeChild(m);"function"===typeof g&&g(a,a,!0)},b,c);k.requestRender()}var k=this;d&&(a*=2);var l,n=a*a;e&&this.renderer.setClearColor(this.params.backgroundColor,
0);var m=document.createElement("canvas");m.style.display="hidden";document.body.appendChild(m);d?(m.width=this.width*a/2,m.height=this.height*a/2):(m.width=this.width*a,m.height=this.height*a);var q=m.getContext("2d"),s=new THREE.Matrix4,p=new THREE.Matrix4,r=this.camera.near;l=Math.tan(THREE.Math.degToRad(.5*this.camera.fov))*r;var u=-l,x=Math.abs(this.camera.aspect*l-this.camera.aspect*u),t=Math.abs(l-u);for(l=0;l<=n;++l)setTimeout(function(b,c){return function(){if(b===c)h(c),e&&k.renderer.setClearColor(k.params.backgroundColor,
1);else{var f=k.camera.projectionMatrix;s.set(1,0,(b%a-.5*(a-1))*x/r,0,0,1,-(Math.floor(b/a)-.5*(a-1))*t/r,0,0,0,1,0,0,0,0,1);p.set(a,0,0,0,0,a,0,0,0,0,1,0,0,0,0,1);f.multiply(s).multiply(p);k.render(null,null,!0);var f=b%a*k.width,l=Math.floor(b/a)*k.height;d?q.drawImage(k.renderer.domElement,Math.round(f/2),Math.round(l/2),Math.round(k.width/2),Math.round(k.height/2)):q.drawImage(k.renderer.domElement,f,l);k.camera.updateProjectionMatrix();"function"===typeof g&&g(b+1,c,!1)}}}(l,n))},requestRender:function(){requestAnimationFrame(this.render.bind(this))},
render:function(a,b,c){if(this._rendering)console.warn("tried to call 'render' from within 'render'");else{this._rendering=!0;var d=.5*this.boundingBox.size().length(),e=this.camera.position.length(),f=-(50-this.params.clipFar)/50;a=e-(50-this.params.clipNear)/50*d;this.camera.near=Math.max(.1,this.params.clipDist);this.camera.far=Math.max(1,e+d*f);f=-(50-this.params.fogFar)/50;d=new THREE.Fog(this.params.fogColor,Math.max(.1,e-(50-this.params.fogNear)/50*d),Math.max(1,e+d*f));this.modelGroup.fog=
d;this.textGroup.fog=d;this.transparentGroup.fog=d;this.surfaceGroup.fog=d;NGL.GET("disableClipping")&&(this.camera.near=.1,this.camera.far=1E4,this.scene.fog=null);this.camera.updateMatrix();this.camera.updateMatrixWorld(!0);this.camera.matrixWorldInverse.getInverse(this.camera.matrixWorld);c||this.camera.updateProjectionMatrix();this.updateDynamicUniforms(this.scene,a);this.sortProjectedPosition(this.scene,this.camera);this.renderer.clear();b?this.renderer.render(this.pickingGroup,this.camera):
(this.renderer.render(this.backgroundGroup,this.camera),this.renderer.clearDepth(),this.renderer.render(this.modelGroup,this.camera),this.renderer.render(this.textGroup,this.camera),this.renderer.render(this.transparentGroup,this.camera),this.renderer.render(this.surfaceGroup,this.camera));this._rendering=!1}},updateDynamicUniforms:function(){var a,b=new THREE.Matrix4,c=new THREE.Color;return function(d,e){var f=this.camera;c.set(this.params.backgroundColor);d.traverse(function(d){d.material&&(a=
d.material.uniforms)&&(a.backgroundColor&&(a.backgroundColor.value=c),a.nearClip&&(a.nearClip.value=e),a.modelViewMatrixInverse&&(b.multiplyMatrices(f.matrixWorldInverse,d.matrixWorld),a.modelViewMatrixInverse.value.getInverse(b)),a.modelViewMatrixInverseTranspose&&(a.modelViewMatrixInverse?a.modelViewMatrixInverseTranspose.value.copy(a.modelViewMatrixInverse.value).transpose():(b.multiplyMatrices(f.matrixWorldInverse,d.matrixWorld),a.modelViewMatrixInverseTranspose.value.getInverse(b).transpose())),
a.projectionMatrixInverse&&a.projectionMatrixInverse.value.getInverse(f.projectionMatrix),a.projectionMatrixTranspose&&a.projectionMatrixTranspose.value.copy(f.projectionMatrix).transpose(),a.modelViewProjectionMatrix&&(b.multiplyMatrices(f.matrixWorldInverse,d.matrixWorld),a.modelViewProjectionMatrix.value.multiplyMatrices(f.projectionMatrix,b)),a.modelViewProjectionMatrixInverse&&(a.modelViewProjectionMatrix?a.modelViewProjectionMatrixInverse.value.copy(a.modelViewProjectionMatrix.value):(b.multiplyMatrices(f.matrixWorldInverse,
d.matrixWorld),a.modelViewProjectionMatrixInverse.value.multiplyMatrices(f.projectionMatrix,b)),a.modelViewProjectionMatrixInverse.value.getInverse(a.modelViewProjectionMatrixInverse.value)))})}}(),sortProjectedPosition:function(){var a=new THREE.Vector3,b=new THREE.Matrix4,c=new THREE.Matrix4,d,e,f,g,h;return function(k,l){k.traverseVisible(function(k){if(k instanceof THREE.PointCloud&&k.sortParticles){b.multiplyMatrices(l.matrixWorldInverse,k.matrixWorld);c.multiplyMatrices(l.projectionMatrix,b);
g=k.geometry.attributes;f=g.position.length/3;h=[];for(d=0;d<f;++d)a.fromArray(g.position.array,3*d),a.applyProjection(c),h[d]=[a.z,d];h.sort(function(a,b){return b[0]-a[0]});k.userData.sortData||(k.userData.sortData={});var m,q,s,p,r;for(r in g){k.userData.sortData[r]||(k.userData.sortData[r]=new Float32Array(g[r].itemSize*f));p=k.userData.sortData[r];k.userData.sortData[r]=g[r].array;for(d=0;d<f;++d)for(m=h[d][1],e=0;e<g[r].itemSize;++e)q=m*g[r].itemSize+e,s=d*g[r].itemSize+e,p[s]=g[r].array[q];
g[r].array=p;g[r].needsUpdate=!0}}})}}(),clear:function(){console.log("scene cleared");this.scene.remove(this.rotationGroup);this.initScene();this.renderer.clear()},centerView:function(){var a=new THREE.Vector3;return function(b,c){b=b||this.boundingBox.center();this.controls.object.position.sub(this.controls.target);this.controls.target.copy(this.controls.target0);a.copy(b).multiplyScalar(-1);c&&(!0===c&&(c=this.boundingBox.size().length()/2/Math.tan(Math.PI*this.camera.fov/360)),c=Math.max(c,1.2*
this.params.clipDist),this.camera.position.multiplyScalar(c/this.camera.position.length()));this.rotationGroup.position.copy(a);this.rotationGroup.updateMatrixWorld();this.requestRender()}}(),getOrientation:function(){return[this.camera.position.toArray(),this.camera.up.toArray(),this.rotationGroup.position.toArray()]},setOrientation:function(a){this.controls.object.position.sub(this.controls.target);this.controls.target.copy(this.controls.target0);this.camera.position.fromArray(a[0]);this.camera.up.fromArray(a[1]);
this.rotationGroup.position.fromArray(a[2]);this.rotationGroup.updateMatrixWorld();this.requestRender()}};
NGL.Buffer=function(a,b,c){this.pickable=!1;this.transparent=this.transparent||!1;this.side=void 0!==this.side?this.side:THREE.DoubleSide;this.opacity=void 0!==this.opacity?this.opacity:1;this.nearClip=void 0!==this.nearClip?this.nearClip:!0;this.attributes={};this.geometry=new THREE.BufferGeometry;this.addAttributes({position:{type:"v3",value:a},color:{type:"c",value:b}});c&&(this.addAttributes({pickingColor:{type:"c",value:c}}),this.pickable=!0);this.uniforms=THREE.UniformsUtils.merge([NGL.UniformsLib.fog,
NGL.UniformsLib.lights,{opacity:{type:"f",value:this.opacity},nearClip:{type:"f",value:0}}])};
NGL.Buffer.prototype={constructor:NGL.Buffer,finalize:function(){this.makeIndex();NGL.indexUint16&&(this.geometry.drawcalls=this.geometry.computeOffsets())},getMesh:function(a){var b=this.getMaterial(a);return"wireframe"===a||this.wireframe?new THREE.Line(this.geometry,b,THREE.LinePieces):new THREE.Mesh(this.geometry,b)},getMaterial:function(a){var b;b=THREE.UniformsUtils.clone(this.uniforms);"picking"===a?(b=new THREE.ShaderMaterial({uniforms:b,attributes:this.attributes,vertexShader:NGL.getShader(this.vertexShader),
fragmentShader:NGL.getShader(this.fragmentShader),depthTest:!0,transparent:!1,depthWrite:!0,lights:!0,fog:!1}),b.side=this.side,b.defines.PICKING=1):"wireframe"===a||this.wireframe?b=new THREE.LineBasicMaterial({uniforms:b,attributes:this.attributes,vertexColors:!0,fog:!0}):(b=new THREE.ShaderMaterial({uniforms:b,attributes:this.attributes,vertexShader:NGL.getShader(this.vertexShader),fragmentShader:NGL.getShader(this.fragmentShader),depthTest:!0,transparent:this.transparent,depthWrite:!0,lights:!0,
fog:!0}),b.side=this.side,"background"===a&&(b.defines.NOLIGHT=1));this.nearClip&&(b.defines.NEAR_CLIP=1);return b},addUniforms:function(a){this.uniforms=THREE.UniformsUtils.merge([this.uniforms,a])},addAttributes:function(a){var b={f:1,v2:2,v3:3,c:3};Object.keys(a).forEach(function(c){var d,e=a[c];this.attributes[c]={type:e.type,value:null};e.value?(this.attributeSize*b[e.type]!==e.value.length&&console.error("attribute value has wrong length",c),d=e.value):d=new Float32Array(this.attributeSize*
b[e.type]);this.geometry.addAttribute(c,new THREE.BufferAttribute(d,b[e.type]))},this)},setAttributes:function(a){var b=this.geometry.attributes;Object.keys(a).forEach(function(c){b[c].set(a[c]);b[c].needsUpdate=!0;this.attributes[c].needsUpdate=!0},this)},makeIndex:function(){this.index&&this.geometry.addAttribute("index",new THREE.BufferAttribute(this.index,1))},setVisibility:function(a){this.group.visible=a;this.pickable&&(this.pickingGroup.visible=a)},dispose:function(){this.group.traverse(function(a){a.material&&
a.material.dispose()});this.pickable&&this.pickingGroup.traverse(function(a){a.material&&a.material.dispose()});this.geometry.dispose()}};
NGL.MeshBuffer=function(a,b,c,d,e,f,g,h,k,l){this.wireframe=f||!1;this.transparent=void 0!==g?g:!1;this.side=void 0!==h?h:THREE.DoubleSide;this.opacity=void 0!==k?k:1;this.nearClip=void 0!==l?l:!0;this.attributeSize=this.size=a.length/3;this.vertexShader="Mesh.vert";this.fragmentShader="Mesh.frag";this.index=c;NGL.Buffer.call(this,a,b,e);this.addAttributes({normal:{type:"v3",value:d}});this.finalize()};NGL.MeshBuffer.prototype=Object.create(NGL.Buffer.prototype);
NGL.MappedBuffer=function(){this.attributeSize=this.mappedSize=this.size*this.mappingSize;NGL.Buffer.call(this);this.addAttributes({mapping:{type:this.mappingType,value:null}})};NGL.MappedBuffer.prototype=Object.create(NGL.Buffer.prototype);NGL.MappedBuffer.prototype.finalize=function(){this.makeMapping();NGL.Buffer.prototype.finalize.call(this)};
NGL.MappedBuffer.prototype.setAttributes=function(a){var b=this.geometry.attributes,c=this.size,d=this.mappingSize,e,f,g,h,k,l,n;Object.keys(a).forEach(function(m){f=a[m];e=b[m];g=e.itemSize;h=e.array;for(var q=0;q<c;++q){k=q*g;l=k*d;for(var s=0;s<d;++s){n=l+g*s;for(var p=0;p<g;++p)h[n+p]=f[k+p]}}e.needsUpdate=!0;this.attributes[m].needsUpdate=!0},this)};
NGL.MappedBuffer.prototype.makeMapping=function(){for(var a=this.size,b=this.mapping,c=this.mappingSize,d=this.mappingItemSize,e=this.geometry.attributes.mapping.array,f=0;f<a;f++)e.set(b,f*d*c)};
NGL.MappedBuffer.prototype.makeIndex=function(){var a=this.size,b=this.mappingSize,c=this.mappingIndices,d=this.mappingIndicesSize;this.geometry.addAttribute("index",new THREE.BufferAttribute(new Uint32Array(a*d),1));for(var e=this.geometry.attributes.index.array,f,g,h=0;h<a;h++){f=h*d;g=h*b;e.set(c,f);for(var k=0;k<d;++k)e[f+k]+=g}};
NGL.QuadBuffer=function(){this.mapping=new Float32Array([-1,1,-1,-1,1,1,1,-1]);this.mappingIndices=new Uint32Array([0,1,2,1,3,2]);this.mappingIndicesSize=6;this.mappingType="v2";this.mappingSize=4;this.mappingItemSize=2;NGL.MappedBuffer.call(this)};NGL.QuadBuffer.prototype=Object.create(NGL.MappedBuffer.prototype);
NGL.BoxBuffer=function(){this.mapping=new Float32Array([-1,-1,-1,1,-1,-1,1,-1,1,-1,-1,1,-1,1,-1,1,1,-1,1,1,1,-1,1,1]);this.mappingIndices=new Uint32Array([0,1,2,0,2,3,1,5,6,1,6,2,4,6,5,4,7,6,0,7,4,0,3,7,0,5,1,0,4,5,3,2,6,3,6,7]);this.mappingIndicesSize=36;this.mappingType="v3";this.mappingSize=8;this.mappingItemSize=3;NGL.MappedBuffer.call(this)};NGL.BoxBuffer.prototype=Object.create(NGL.MappedBuffer.prototype);
NGL.AlignedBoxBuffer=function(){this.mapping=new Float32Array([-1,1,-1,-1,-1,-1,1,1,-1,1,1,1,1,-1,-1,1,-1,1]);this.mappingIndices=new Uint32Array([0,1,2,1,4,2,2,4,3,4,5,3]);this.mappingIndicesSize=12;this.mappingType="v3";this.mappingSize=6;this.mappingItemSize=3;NGL.MappedBuffer.call(this)};NGL.AlignedBoxBuffer.prototype=Object.create(NGL.MappedBuffer.prototype);
NGL.SphereImpostorBuffer=function(a,b,c,d,e,f,g){this.transparent=void 0!==e?e:!1;this.side=void 0!==f?f:THREE.DoubleSide;this.opacity=void 0!==g?g:1;this.size=a.length/3;this.vertexShader="SphereImpostor.vert";this.fragmentShader="SphereImpostor.frag";NGL.QuadBuffer.call(this);this.addUniforms({projectionMatrixInverse:{type:"m4",value:new THREE.Matrix4}});this.addAttributes({radius:{type:"f",value:null}});this.setAttributes({position:a,color:b,radius:c});d&&(this.addAttributes({pickingColor:{type:"c",
value:null}}),this.setAttributes({pickingColor:d}),this.pickable=!0);this.finalize()};NGL.SphereImpostorBuffer.prototype=Object.create(NGL.QuadBuffer.prototype);
NGL.CylinderImpostorBuffer=function(a,b,c,d,e,f,g,h,k,l,n,m){f||(f=0);this.cap=void 0===g?!0:g;this.transparent=void 0!==l?l:!1;this.side=void 0!==n?n:THREE.DoubleSide;this.opacity=void 0!==m?m:1;this.size=a.length/3;this.vertexShader="CylinderImpostor.vert";this.fragmentShader="CylinderImpostor.frag";NGL.AlignedBoxBuffer.call(this);this.addUniforms({modelViewMatrixInverse:{type:"m4",value:new THREE.Matrix4},shift:{type:"f",value:f}});this.addAttributes({position1:{type:"v3",value:null},position2:{type:"v3",
value:null},color2:{type:"c",value:null},radius:{type:"f",value:null}});this.setAttributes({position:NGL.Utils.calculateCenterArray(a,b),position1:a,position2:b,color:c,color2:d,radius:e});h&&(this.addAttributes({pickingColor:{type:"c",value:null},pickingColor2:{type:"c",value:null}}),this.setAttributes({pickingColor:h,pickingColor2:k}),this.pickable=!0);this.finalize()};NGL.CylinderImpostorBuffer.prototype=Object.create(NGL.AlignedBoxBuffer.prototype);
NGL.CylinderImpostorBuffer.prototype.getMaterial=function(a){a=NGL.Buffer.prototype.getMaterial.call(this,a);this.cap&&(a.defines.CAP=1);return a};
NGL.HyperballStickImpostorBuffer=function(a,b,c,d,e,f,g,h,k,l,n,m){this.transparent=void 0!==l?l:!1;this.side=void 0!==n?n:THREE.DoubleSide;this.opacity=void 0!==m?m:1;this.size=a.length/3;this.vertexShader="HyperballStickImpostor.vert";this.fragmentShader="HyperballStickImpostor.frag";NGL.BoxBuffer.call(this);this.addUniforms({modelViewProjectionMatrix:{type:"m4",value:new THREE.Matrix4},modelViewProjectionMatrixInverse:{type:"m4",value:new THREE.Matrix4},modelViewMatrixInverseTranspose:{type:"m4",
value:new THREE.Matrix4},shrink:{type:"f",value:g}});this.addAttributes({color:{type:"c",value:null},color2:{type:"c",value:null},radius:{type:"f",value:null},radius2:{type:"f",value:null},position1:{type:"v3",value:null},position2:{type:"v3",value:null}});this.setAttributes({color:c,color2:d,radius:e,radius2:f,position1:a,position2:b,position:NGL.Utils.calculateCenterArray(a,b)});h&&(this.addAttributes({pickingColor:{type:"c",value:null},pickingColor2:{type:"c",value:null}}),this.setAttributes({pickingColor:h,
pickingColor2:k}),this.pickable=!0);this.finalize()};NGL.HyperballStickImpostorBuffer.prototype=Object.create(NGL.BoxBuffer.prototype);
NGL.GeometryBuffer=function(a,b,c,d,e,f){this.wireframe=!1;this.transparent=void 0!==d?d:!1;this.side=void 0!==e?e:THREE.DoubleSide;this.opacity=void 0!==f?f:1;d=this.geo;e=a.length/3;f=d.vertices.length;var g=d.faces.length;this.size=e*f;this.positionCount=e;this.geoPosition=NGL.Utils.positionFromGeometry(d);this.geoNormal=NGL.Utils.normalFromGeometry(d);this.geoIndex=NGL.Utils.indexFromGeometry(d);this.meshPosition=new Float32Array(3*this.size);this.meshNormal=new Float32Array(3*this.size);this.meshIndex=
new Uint32Array(e*g*3);this.meshColor=new Float32Array(3*this.size);this.meshPickingColor=new Float32Array(3*this.size);this.transformedGeoPosition=new Float32Array(3*f);this.transformedGeoNormal=new Float32Array(3*f);this.makeIndex();this.setAttributes({position:a,color:b,pickingColor:c});this.meshBuffer=new NGL.MeshBuffer(this.meshPosition,this.meshColor,this.meshIndex,this.meshNormal,this.meshPickingColor,this.wireframe,this.transparent,this.side,this.opacity);this.pickable=this.meshBuffer.pickable;
this.geometry=this.meshBuffer.geometry};
NGL.GeometryBuffer.prototype={applyPositionTransform:function(){},setAttributes:function(){var a=new THREE.Matrix4,b=new THREE.Matrix3;return function(c){var d,e,f;if(c.position){d=c.position;var g=this.geoPosition,h=this.meshPosition,k=this.transformedGeoPosition}if(c.color){e=c.color;var l=this.meshColor}if(c.pickingColor){f=c.pickingColor;var n=this.meshPickingColor}if(c=this.updateNormals&&d||!this.meshBuffer)var m=this.geoNormal,q=this.meshNormal,s=this.transformedGeoNormal;var p=this.positionCount,
r=this.geo.vertices.length,u,x,t,y,w;for(u=0;u<p;++u){t=u*r*3;w=3*u;d&&(k.set(g),a.makeTranslation(d[w+0],d[w+1],d[w+2]),this.applyPositionTransform(a,u,w),a.applyToVector3Array(k),h.set(k,t));c&&(s.set(m),b.getNormalMatrix(a),b.applyToVector3Array(s),q.set(s,t));if(e)for(x=0;x<r;++x)y=t+3*x,l[y+0]=e[w+0],l[y+1]=e[w+1],l[y+2]=e[w+2];if(f)for(x=0;x<r;++x)y=t+3*x,n[y+0]=f[w+0],n[y+1]=f[w+1],n[y+2]=f[w+2]}g={};d&&(g.position=h);c&&(g.normal=q);e&&(g.color=l);f&&(g.pickingColor=n);this.meshBuffer&&this.meshBuffer.setAttributes(g)}}(),
makeIndex:function(){var a=this.geoIndex,b=this.meshIndex,c=this.positionCount,d=this.geo.vertices.length,e,f,g,h=3*this.geo.faces.length;for(f=0;f<c;++f)for(e=f*h,g=e+h,b.set(a,e);e<g;++e)b[e]+=f*d},getMesh:function(a){return this.meshBuffer.getMesh(a)},setVisibility:NGL.Buffer.prototype.setVisibility,dispose:NGL.Buffer.prototype.dispose};
NGL.SphereGeometryBuffer=function(a,b,c,d,e,f,g,h){this.geo=new THREE.IcosahedronGeometry(1,void 0!==e?e:1);this.setPositionTransform(c);NGL.GeometryBuffer.call(this,a,b,d,f,g,h)};NGL.SphereGeometryBuffer.prototype=Object.create(NGL.GeometryBuffer.prototype);NGL.SphereGeometryBuffer.prototype.setPositionTransform=function(a){var b,c=new THREE.Vector3;this.applyPositionTransform=function(d,e){b=a[e];c.set(b,b,b);d.scale(c)}};
NGL.SphereGeometryBuffer.prototype.setAttributes=function(a){a.radius&&this.setPositionTransform(a.radius);NGL.GeometryBuffer.prototype.setAttributes.call(this,a)};
NGL.CylinderGeometryBuffer=function(a,b,c,d,e,f,g,h,k,l,n){h=h||10;this.updateNormals=!0;var m=(new THREE.Matrix4).makeRotationX(Math.PI/2);this.geo=new THREE.CylinderGeometry(1,1,1,h,1,!0);this.geo.applyMatrix(m);h=a.length;m=e.length;this._position=new Float32Array(2*h);this._color=new Float32Array(2*h);this._pickingColor=new Float32Array(2*h);this._from=new Float32Array(2*h);this._to=new Float32Array(2*h);this._radius=new Float32Array(2*m);this.__center=new Float32Array(h);this.setAttributes({position1:a,
position2:b,color:c,color2:d,radius:e,pickingColor:f,pickingColor2:g},!0);this.setPositionTransform(this._from,this._to,this._radius);NGL.GeometryBuffer.call(this,this._position,this._color,this._pickingColor,k,l,n)};NGL.CylinderGeometryBuffer.prototype=Object.create(NGL.GeometryBuffer.prototype);
NGL.CylinderGeometryBuffer.prototype.setPositionTransform=function(a,b,c){var d,e=new THREE.Vector3,f=new THREE.Vector3,g=new THREE.Vector3,h=new THREE.Vector3(0,1,0);this.applyPositionTransform=function(k,l,n){f.fromArray(a,n);g.fromArray(b,n);k.lookAt(f,g,h);d=c[l];e.set(d,d,f.distanceTo(g));k.scale(e)}};
NGL.CylinderGeometryBuffer.prototype.setAttributes=function(a,b){if(this.meshBuffer||b){var c=this._position.length/2,d=this._radius.length/2,e={};a.position1&&a.position2&&(NGL.Utils.calculateCenterArray(a.position1,a.position2,this.__center),NGL.Utils.calculateCenterArray(a.position1,this.__center,this._position),NGL.Utils.calculateCenterArray(this.__center,a.position2,this._position,c),this._from.set(a.position1),this._from.set(this.__center,c),this._to.set(this.__center),this._to.set(a.position2,
c),e.position=this._position);a.color&&a.color2&&(this._color.set(a.color),this._color.set(a.color2,c),e.color=this._color);a.pickingColor&&a.pickingColor2&&(this._pickingColor.set(a.pickingColor),this._pickingColor.set(a.pickingColor2,c),e.pickingColor=this._pickingColor);a.radius&&(this._radius.set(a.radius),this._radius.set(a.radius,d));(a.position1&&a.position2||a.radius)&&this.setPositionTransform(this._from,this._to,this._radius);this.meshBuffer&&NGL.GeometryBuffer.prototype.setAttributes.call(this,
e)}else NGL.GeometryBuffer.prototype.setAttributes.call(this,a)};NGL.PointBuffer=function(a,b,c,d,e,f,g){this.pointSize=c||!1;this.sizeAttenuation=void 0!==d?d:!1;this.sort=void 0!==e?e:!0;this.transparent=void 0!==f?f:!1;this.opacity=void 0!==g?g:1;this.attributeSize=this.size=a.length/3;this.tex=new THREE.Texture(NGL.Resources["../img/spark1.png"]);this.tex.needsUpdate=!0;this.sort||(this.tex.premultiplyAlpha=!0);NGL.Buffer.call(this,a,b)};NGL.PointBuffer.prototype=Object.create(NGL.Buffer.prototype);
NGL.PointBuffer.prototype.getMesh=function(a){a=new THREE.PointCloud(this.geometry,this.getMaterial(a));this.sort&&(a.sortParticles=!0);return a};
NGL.PointBuffer.prototype.getMaterial=function(a){return this.sort?new THREE.PointCloudMaterial({map:this.tex,blending:THREE.NormalBlending,depthTest:!0,transparent:!0,vertexColors:!0,size:this.pointSize,sizeAttenuation:this.sizeAttenuation,opacity:this.opacity,fog:!0}):new THREE.PointCloudMaterial({map:this.tex,depthTest:!1,transparent:!0,blending:THREE.CustomBlending,blendEquation:THREE.AddEquation,blendSrc:THREE.OneFactor,blendDst:THREE.OneMinusSrcAlphaFactor,vertexColors:!0,size:this.pointSize,
sizeAttenuation:this.sizeAttenuation,opacity:this.opacity,fog:!0})};
NGL.LineBuffer=function(a,b,c,d,e,f,g){this.lineWidth=e||1;this.transparent=void 0!==f?f:!1;this.opacity=void 0!==g?g:1;this.size=a.length/3;this.vertexShader="Line.vert";this.fragmentShader="Line.frag";e=4*this.size;this.attributes={position:{type:"v3",value:null},color:{type:"c",value:null}};this.geometry=new THREE.BufferGeometry;this.geometry.addAttribute("position",new THREE.BufferAttribute(new Float32Array(3*e),3));this.geometry.addAttribute("color",new THREE.BufferAttribute(new Float32Array(3*
e),3));this.setAttributes({from:a,to:b,color:c,color2:d});this.uniforms=THREE.UniformsUtils.merge([NGL.UniformsLib.fog,{opacity:{type:"f",value:this.opacity}}])};
NGL.LineBuffer.prototype={setAttributes:function(a){var b,c,d,e,f,g,h=this.geometry.attributes;a.from&&a.to&&(b=a.from,c=a.to,f=h.position.array,h.position.needsUpdate=!0,this.attributes.position.needsUpdate=!0);a.color&&a.color2&&(d=a.color,e=a.color2,g=h.color.array,h.color.needsUpdate=!0,this.attributes.color.needsUpdate=!0);a=this.size;for(var h=6*a,k,l,n,m,q,s,p,r,u=0;u<a;u++)l=3*u,k=6*u,b&&c&&(n=b[l+0],m=b[l+1],q=b[l+2],s=c[l+0],p=c[l+1],r=c[l+2],n=(n+s)/2,m=(m+p)/2,q=(q+r)/2,f[k+0]=b[l+0],
f[k+1]=b[l+1],f[k+2]=b[l+2],f[k+3]=n,f[k+4]=m,f[k+5]=q),d&&e&&(g[k+0]=d[l+0],g[k+1]=d[l+1],g[k+2]=d[l+2],g[k+3]=d[l+0],g[k+4]=d[l+1],g[k+5]=d[l+2]),k+=h,b&&c&&(f[k+0]=n,f[k+1]=m,f[k+2]=q,f[k+3]=c[l+0],f[k+4]=c[l+1],f[k+5]=c[l+2]),d&&e&&(g[k+0]=e[l+0],g[k+1]=e[l+1],g[k+2]=e[l+2],g[k+3]=e[l+0],g[k+4]=e[l+1],g[k+5]=e[l+2])},getMesh:function(a){return new THREE.Line(this.geometry,this.getMaterial(a),THREE.LinePieces)},getMaterial:function(a){a=THREE.UniformsUtils.clone(this.uniforms);return new THREE.ShaderMaterial({uniforms:a,
attributes:this.attributes,vertexShader:NGL.getShader(this.vertexShader),fragmentShader:NGL.getShader(this.fragmentShader),depthTest:!0,transparent:this.transparent,depthWrite:!0,lights:!1,fog:!0,linewidth:this.lineWidth})},setVisibility:NGL.Buffer.prototype.setVisibility,dispose:NGL.Buffer.prototype.dispose};
NGL.TraceBuffer=function(a,b,c,d,e){this.size=a.length/3;var f=this.size-1;this.from=new Float32Array(3*f);this.to=new Float32Array(3*f);this.lineColor=new Float32Array(3*f);this.lineColor2=new Float32Array(3*f);this.setAttributes({position:a,color:b});this.lineBuffer=new NGL.LineBuffer(this.from,this.to,this.lineColor,this.lineColor2,c,d,e);this.pickable=this.lineBuffer.pickable;this.geometry=this.lineBuffer.geometry};
NGL.TraceBuffer.prototype={setAttributes:function(a){var b,c,d,e,f,g;a.position&&(b=a.position,d=this.from,e=this.to);a.color&&(c=a.color,f=this.lineColor,g=this.lineColor2);a=this.size-1;for(var h=0,k;h<a;++h)k=3*h,b&&(d[k+0]=b[k+0],d[k+1]=b[k+1],d[k+2]=b[k+2],e[k+0]=b[k+3],e[k+1]=b[k+4],e[k+2]=b[k+5]),c&&(f[k+0]=c[k+0],f[k+1]=c[k+1],f[k+2]=c[k+2],g[k+0]=c[k+3],g[k+1]=c[k+4],g[k+2]=c[k+5]);a={};b&&(a.from=d,a.to=e);c&&(a.color=f,a.color2=g);this.lineBuffer&&this.lineBuffer.setAttributes(a)},getMesh:function(a){return this.lineBuffer.getMesh(a)},
setVisibility:NGL.Buffer.prototype.setVisibility,dispose:NGL.Buffer.prototype.dispose};NGL.ParticleSpriteBuffer=function(a,b,c){this.size=a.length/3;this.vertexShader="ParticleSprite.vert";this.fragmentShader="ParticleSprite.frag";NGL.QuadBuffer.call(this);this.addUniforms({projectionMatrixInverse:{type:"m4",value:new THREE.Matrix4}});this.addAttributes({radius:{type:"f",value:null}});this.setAttributes({position:a,color:b,radius:c});this.finalize();this.material.lights=!1};
NGL.ParticleSpriteBuffer.prototype=Object.create(NGL.QuadBuffer.prototype);
NGL.RibbonBuffer=function(a,b,c,d,e,f,g,h,k){this.vertexShader="Ribbon.vert";this.fragmentShader="Ribbon.frag";this.size=a.length/3-1;this.transparent=void 0!==g?g:!1;this.side=void 0!==h?h:THREE.DoubleSide;this.opacity=void 0!==k?k:1;g=4*this.size;this.attributes={inputDir:{type:"v3",value:null},inputSize:{type:"f",value:null},inputNormal:{type:"v3",value:null},inputColor:{type:"v3",value:null}};f&&(this.attributes.pickingColor={type:"v3",value:null});this.uniforms=THREE.UniformsUtils.merge([NGL.UniformsLib.fog,
NGL.UniformsLib.lights,{opacity:{type:"f",value:this.opacity},nearClip:{type:"f",value:0}}]);this.geometry=new THREE.BufferGeometry;this.geometry.addAttribute("position",new THREE.BufferAttribute(new Float32Array(3*g),3));this.geometry.addAttribute("inputDir",new THREE.BufferAttribute(new Float32Array(3*g),3));this.geometry.addAttribute("inputSize",new THREE.BufferAttribute(new Float32Array(g),1));this.geometry.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(3*g),3));this.geometry.addAttribute("inputColor",
new THREE.BufferAttribute(new Float32Array(3*g),3));f&&(this.geometry.addAttribute("pickingColor",new THREE.BufferAttribute(new Float32Array(3*g),3)),this.pickable=!0);this.setAttributes({position:a,normal:b,dir:c,color:d,size:e,pickingColor:f});NGL.Buffer.prototype.finalize.call(this)};
NGL.RibbonBuffer.prototype={setAttributes:function(a){var b=this.size,c=this.geometry.attributes,d,e,f,g,h,k,l,n,m,q,s,p;a.position&&(d=a.position,l=c.position.array,c.position.needsUpdate=!0);a.normal&&(e=a.normal,n=c.normal.array,c.normal.needsUpdate=!0);a.size&&(f=a.size,m=c.inputSize.array,c.inputSize.needsUpdate=!0);a.dir&&(g=a.dir,q=c.inputDir.array,c.inputDir.needsUpdate=!0);a.color&&(h=a.color,s=c.inputColor.array,c.inputColor.needsUpdate=!0);a.pickingColor&&(k=a.pickingColor,p=c.pickingColor.array,
c.pickingColor.needsUpdate=!0);var r,u,x,t,y=f?f[0]:null;for(a=0;a<b;++a){t=3*a;r=12*a;x=4*a;d&&(l[r+0]=d[t+0],l[r+1]=d[t+1],l[r+2]=d[t+2],l[r+3]=d[t+0],l[r+4]=d[t+1],l[r+5]=d[t+2],l[r+6]=d[t+3],l[r+7]=d[t+4],l[r+8]=d[t+5],l[r+9]=d[t+3],l[r+10]=d[t+4],l[r+11]=d[t+5]);e&&(n[r+0]=e[t+0],n[r+1]=e[t+1],n[r+2]=e[t+2],n[r+3]=e[t+0],n[r+4]=e[t+1],n[r+5]=e[t+2],n[r+6]=e[t+3],n[r+7]=e[t+4],n[r+8]=e[t+5],n[r+9]=e[t+3],n[r+10]=e[t+4],n[r+11]=e[t+5]);for(c=0;4>c;++c)u=r+3*c,h&&(s[u+0]=h[t+0],s[u+1]=h[t+1],s[u+
2]=h[t+2]),k&&(p[u+0]=k[t+0],p[u+1]=k[t+1],p[u+2]=k[t+2]);f&&(y!=f[a]?(m[x+0]=Math.abs(y),m[x+1]=Math.abs(y)):(m[x+0]=Math.abs(f[a]),m[x+1]=Math.abs(f[a])),m[x+2]=Math.abs(f[a]),m[x+3]=Math.abs(f[a]),y=f[a]);g&&(q[r+0]=g[t+0],q[r+1]=g[t+1],q[r+2]=g[t+2],q[r+3]=-g[t+0],q[r+4]=-g[t+1],q[r+5]=-g[t+2],q[r+6]=g[t+3],q[r+7]=g[t+4],q[r+8]=g[t+5],q[r+9]=-g[t+3],q[r+10]=-g[t+4],q[r+11]=-g[t+5])}},makeIndex:function(){var a=this.size,b=4*a,c=new Uint32Array([0,1,2,1,3,2]);this.geometry.addAttribute("index",
new THREE.BufferAttribute(new Uint32Array(3*b),1));var b=this.geometry.attributes.index.array,d,e,f,g;for(e=0;e<a;++e)for(f=6*e,g=4*e,b.set(c,f),d=0;6>d;++d)b[f+d]+=g},getMesh:NGL.Buffer.prototype.getMesh,getMaterial:NGL.Buffer.prototype.getMaterial,setVisibility:NGL.Buffer.prototype.setVisibility,dispose:NGL.Buffer.prototype.dispose};
NGL.TubeMeshBuffer=function(a,b,c,d,e,f,g,h,k,l,n,m,q,s,p,r){this.rx=k||1.5;this.ry=l||.5;this.wireframe=m||!1;this.transparent=void 0!==q?q:!1;this.side=void 0!==s?s:THREE.DoubleSide;this.opacity=void 0!==p?p:1;this.nearClip=void 0!==r?r:!0;this.radialSegments=g||4;this.capVertices=n?this.radialSegments:0;this.capTriangles=n?this.radialSegments-2:0;l=this.size=a.length/3;k=l-1;l=l*this.radialSegments*3+6*this.capVertices;this.meshPosition=new Float32Array(l);this.meshColor=new Float32Array(l);this.meshNormal=
new Float32Array(l);this.meshPickingColor=new Float32Array(l);this.meshIndex=new Uint32Array(2*k*g*3+6*this.capTriangles);this.makeIndex();this.setAttributes({position:a,normal:b,binormal:c,tangent:d,color:e,size:f,pickingColor:h});this.meshBuffer=new NGL.MeshBuffer(this.meshPosition,this.meshColor,this.meshIndex,this.meshNormal,this.meshPickingColor,this.wireframe,this.transparent,this.side,this.opacity,this.nearClip);this.pickable=this.meshBuffer.pickable;this.geometry=this.meshBuffer.geometry};
NGL.TubeMeshBuffer.prototype={setAttributes:function(){var a=new THREE.Vector3,b=new THREE.Vector3;return function(c){var d=this.rx,e=this.ry,f=this.size,g=f-1,h=this.radialSegments,k,l,n,m,q,s,p,r,u,x,t;c.position&&(k=c.position,l=c.normal,n=c.binormal,m=c.tangent,s=c.size,r=this.meshPosition,x=this.meshNormal);c.color&&(q=c.color,u=this.meshColor);c.pickingColor&&(p=c.pickingColor,t=this.meshPickingColor);var y,w,A,z,v,B,D,G,C,F,H,O,K,M,E,N,I,U,S=[],Q=[],P=[],L=[],V=[],W=[];if(k)for(c=0;c<h;++c)w=
c/h*2*Math.PI,S[c]=d*Math.cos(w),Q[c]=e*Math.sin(w),P[c]=d*Math.cos(w-.01),L[c]=e*Math.sin(w-.01),V[c]=d*Math.cos(w+.01),W[c]=e*Math.sin(w+.01);for(y=0;y<f;++y)for(d=3*y,e=d*h,k&&(a.set(m[d+0],m[d+1],m[d+2]),F=l[d+0],H=l[d+1],O=l[d+2],K=n[d+0],M=n[d+1],E=n[d+2],N=k[d+0],I=k[d+1],U=k[d+2],C=s[y]),c=0;c<h;++c)w=e+3*c,k&&(A=-C*S[c],z=C*Q[c],v=-C*P[c],B=C*L[c],D=-C*V[c],G=C*W[c],r[w+0]=N+A*F+z*K,r[w+1]=I+A*H+z*M,r[w+2]=U+A*O+z*E,b.set(D*F+G*K-(v*F+B*K),D*H+G*M-(v*H+B*M),D*O+G*E-(v*O+B*E)).cross(a),x[w+
0]=b.x,x[w+1]=b.y,x[w+2]=b.z),q&&(u[w+0]=q[d+0],u[w+1]=q[d+1],u[w+2]=q[d+2]),p&&(t[w+0]=p[d+0],t[w+1]=p[d+1],t[w+2]=p[d+2]);d=0;e=3*f*h;for(c=0;c<h;++c)w=d+3*c,l=e+3*c,k&&(r[l+0]=r[w+0],r[l+1]=r[w+1],r[l+2]=r[w+2],x[l+0]=m[d+0],x[l+1]=m[d+1],x[l+2]=m[d+2]),q&&(u[l+0]=u[w+0],u[l+1]=u[w+1],u[l+2]=u[w+2]),p&&(t[l+0]=t[w+0],t[l+1]=t[w+1],t[l+2]=t[w+2]);d=3*(f-1)*h;e=3*(f+1)*h;for(c=0;c<h;++c)w=d+3*c,l=e+3*c,k&&(r[l+0]=r[w+0],r[l+1]=r[w+1],r[l+2]=r[w+2],x[l+0]=m[3*g+0],x[l+1]=m[3*g+1],x[l+2]=m[3*g+2]),
q&&(u[l+0]=u[w+0],u[l+1]=u[w+1],u[l+2]=u[w+2]),p&&(t[l+0]=t[w+0],t[l+1]=t[w+1],t[l+2]=t[w+2]);f={};k&&(f.position=r,f.normal=x);q&&(f.color=u);p&&(f.pickingColor=t);this.meshBuffer&&this.meshBuffer.setAttributes(f)}}(),makeIndex:function(){var a=this.meshIndex,b=this.size,c=b-1,d=this.capTriangles,e=this.radialSegments,f=this.radialSegments+1,g,h,k,l,n,m;for(g=0;g<c;++g)for(h=g*e*6,k=g*e,l=(g+1)*e,m=0;m<e;++m)n=h+6*m,a[n]=k+m,a[n+1]=k+(m+1)%e,a[n+2]=l+m,a[n+3]=l+m,a[n+4]=k+(m+1)%e,a[n+5]=l+(m+1)%
e;g=[0];for(m=1;m<f/2;++m)g.push(m),e-m!==m&&g.push(e-m);n=c*e*6;h=b*e;for(m=0;m<g.length-2;++m)0===m%2?(a[n+3*m+0]=h+g[m+0],a[n+3*m+1]=h+g[m+1],a[n+3*m+2]=h+g[m+2]):(a[n+3*m+0]=h+g[m+2],a[n+3*m+1]=h+g[m+1],a[n+3*m+2]=h+g[m+0]);n=c*e*6+3*d;h=b*e+e;for(m=0;m<g.length-2;++m)0===m%2?(a[n+3*m+0]=h+g[m+0],a[n+3*m+1]=h+g[m+1],a[n+3*m+2]=h+g[m+2]):(a[n+3*m+0]=h+g[m+2],a[n+3*m+1]=h+g[m+1],a[n+3*m+2]=h+g[m+0])},getMesh:function(a){return this.meshBuffer.getMesh(a)},setVisibility:NGL.Buffer.prototype.setVisibility,
dispose:NGL.Buffer.prototype.dispose};NGL.SurfaceBuffer=function(){NGL.MeshBuffer.apply(this,arguments)};NGL.SurfaceBuffer.prototype=Object.create(NGL.MeshBuffer.prototype);NGL.SphereBuffer=function(a,b,c,d,e,f,g,h,k){return!NGL.extensionFragDepth||f?new NGL.SphereGeometryBuffer(a,b,c,d,e,g,h,k):new NGL.SphereImpostorBuffer(a,b,c,d,g,h,k)};
NGL.CylinderBuffer=function(a,b,c,d,e,f,g,h,k,l,n,m,q,s){return!NGL.extensionFragDepth||n?new NGL.CylinderGeometryBuffer(a,b,c,d,e,h,k,l,m,q,s):new NGL.CylinderImpostorBuffer(a,b,c,d,e,f,g,h,k,m,q,s)};NGL.HyperballStickBuffer=function(a,b,c,d,e,f,g,h,k,l,n,m,q,s){return!NGL.extensionFragDepth||n?new NGL.CylinderGeometryBuffer(a,b,c,d,NGL.Utils.calculateMinArray(e,f),h,k,l,m,q,s):new NGL.HyperballStickImpostorBuffer(a,b,c,d,e,f,g,h,k,m,q,s)};
NGL.getFont=function(a){var b={},c,d,e,f;NGL.Resources["../fonts/"+a+".fnt"].split("\n").forEach(function(a){if("char "===a.substr(0,5)){var h={};a.substr(5).split(/\s+/).forEach(function(a){a=a.split("=");h[a[0]]=parseInt(a[1])});a=h.x;var k=h.y,l=h.width,n=h.height;h.textureCoords=new Float32Array([a/d,1-k/e,a/d,1-(k+n)/e,(a+l)/d,1-k/e,(a+l)/d,1-(k+n)/e]);h.width2=10*l/d;h.height2=10*n/e;h.xadvance2=10*h.xadvance/d;h.xoffset2=10*h.xoffset/d;h.yoffset2=10*h.yoffset/e;h.lineHeight=10*f/e;b[h.id]=
h}else"common "===a.substr(0,7)&&(c=a.match(/scaleW=([0-9]+)/),null!==c&&(d=c[1]),c=a.match(/scaleH=([0-9]+)/),null!==c&&(e=c[1]),c=a.match(/base=([0-9]+)/),c=a.match(/lineHeight=([0-9]+)/),null!==c&&(f=c[1]))});return b};
NGL.TextBuffer=function(a,b,c,d,e,f,g){this.antialias=void 0!==f?f:!0;this.opacity=g||1;e=e||"Arial";this.font=NGL.getFont(e);this.tex=new THREE.Texture(NGL.Resources["../fonts/"+e+".png"]);this.tex.needsUpdate=!0;e=a.length/3;for(g=f=0;g<e;++g)f+=d[g].length;this.text=d;this.size=f;this.positionCount=e;this.vertexShader="SDFFont.vert";this.fragmentShader="SDFFont.frag";NGL.QuadBuffer.call(this);this.addUniforms({fontTexture:{type:"t",value:this.tex},backgroundColor:{type:"c",value:new THREE.Color("black")}});
this.addAttributes({inputTexCoord:{type:"v2",value:null},inputSize:{type:"f",value:null}});this.setAttributes({position:a,size:b,color:c});this.finalize()};NGL.TextBuffer.prototype=Object.create(NGL.QuadBuffer.prototype);NGL.TextBuffer.prototype.getMaterial=function(){var a=NGL.Buffer.prototype.getMaterial.call(this);this.antialias&&(a.transparent=!0,a.depthWrite=!0,a.blending=THREE.NormalBlending,a.defines.ANTIALIAS=1);a.lights=!1;a.uniforms.fontTexture.value=this.tex;a.needsUpdate=!0;return a};
NGL.TextBuffer.prototype.setAttributes=function(a){var b,c,d,e,f,g,h=this.text,k=this.geometry.attributes;a.position&&(b=a.position,e=k.position.array,k.position.needsUpdate=!0);a.size&&(c=a.size,f=k.inputSize.array,k.inputSize.needsUpdate=!0);a.color&&(d=a.color,g=k.color.array,k.color.needsUpdate=!0);for(var k=this.positionCount,l,n,m=0,q,s,p=0;p<k;p++)for(n=3*p,l=h[p],s=l.length,q=0;q<s;q++,m++)for(var r=0;4>r;r++)l=12*m+3*r,a.position&&(e[l+0]=b[n+0],e[l+1]=b[n+1],e[l+2]=b[n+2]),a.size&&(f[4*
m+r]=c[p]),d&&(g[l+0]=d[n+0],g[l+1]=d[n+1],g[l+2]=d[n+2])};
NGL.TextBuffer.prototype.makeMapping=function(){for(var a=this.font,b=this.text,c=this.geometry.attributes.inputTexCoord.array,d=this.geometry.attributes.mapping.array,e=this.positionCount,f,g,h=0,k,l,n,m,q=0;q<e;q++)for(k=b[q],l=0,m=k.length,n=0;n<m;n++,h++)f=a[k.charCodeAt(n)],g=8*h,d[g+0]=l+f.xoffset2,d[g+1]=f.lineHeight-f.yoffset2,d[g+2]=l+f.xoffset2,d[g+3]=f.lineHeight-f.yoffset2-f.height2,d[g+4]=l+f.xoffset2+f.width2,d[g+5]=f.lineHeight-f.yoffset2,d[g+6]=l+f.xoffset2+f.width2,d[g+7]=f.lineHeight-
f.yoffset2-f.height2,c.set(f.textureCoords,g),l+=f.xadvance2};NGL.BufferVectorHelper=function(a,b,c,d){d=d||1;var e=a.length/3,f=2*e;this.size=e;this.geometry=new THREE.BufferGeometry;this.geometry.addAttribute("position",new THREE.BufferAttribute(new Float32Array(3*f),3));this.color=c;this.scale=d;this.setAttributes({position:a,vector:b})};
NGL.BufferVectorHelper.prototype={setAttributes:function(a){var b=this.size,c=this.geometry.attributes,d,e;a.position&&(d=a.position,e=c.position.array,c.position.needsUpdate=!0);a.vector&&(this.vector=a.vector);var c=this.scale,f=this.vector,g;if(a.position)for(var h=0;h<b;h++)a=6*h,g=3*h,e[a+0]=d[g+0],e[a+1]=d[g+1],e[a+2]=d[g+2],e[a+3]=d[g+0]+f[g+0]*c,e[a+4]=d[g+1]+f[g+1]*c,e[a+5]=d[g+2]+f[g+2]*c},getMesh:function(){var a=new THREE.LineBasicMaterial({color:this.color,fog:!0});return new THREE.Line(this.geometry,
a,THREE.LinePieces)},setVisibility:NGL.Buffer.prototype.setVisibility,dispose:NGL.Buffer.prototype.dispose};
NGL.makeRepresentation=function(a,b,c,d){console.time("NGL.makeRepresentation "+a);var e;if(b instanceof NGL.Structure){if(e=NGL.representationTypes[a],!e){console.error("NGL.makeRepresentation: representation type "+a+" unknown");return}}else if(b instanceof NGL.Surface)e=NGL.SurfaceRepresentation;else if(b instanceof NGL.Trajectory)e=NGL.TrajectoryRepresentation;else{console.error("NGL.makeRepresentation: object "+b+" unknown");return}b=new e(b,c,d);console.timeEnd("NGL.makeRepresentation "+a);
return b};NGL.Representation=function(a,b,c){this.viewer=b;this.debugBufferList=[];this.init(c)};
NGL.Representation.prototype={type:"",parameters:{nearClip:{type:"boolean"}},init:function(a){a=a||{};this.nearClip=void 0!==a.nearClip?a.nearClip:!0;this.visible=void 0===a.visible?!0:a.visible;this.quality=a.quality},setColor:function(a){a&&a!==this.color&&(this.color=a,this.update({color:!0}));return this},create:function(){this.bufferList=[]},update:function(){this.rebuild()},rebuild:function(a){a&&this.init(a);this.dispose();this.create();this.manualAttach||this.attach()},attach:function(){this.setVisibility(this.visible)},
setVisibility:function(a){this.visible=a;this.bufferList.forEach(function(b){b.setVisibility(a)});this.debugBufferList.forEach(function(b){b.setVisibility(a)});this.viewer.requestRender();return this},setParameters:function(a,b,c){a&&void 0!==a.nearClip&&(this.nearClip=a.nearClip,c=!0);c?this.rebuild():b&&Object.keys(b).length&&this.update(b);return this},getParameters:function(){var a={color:this.color,radius:this.radius,scale:this.scale,visible:this.visible,sele:this.selection.string,disableImpostor:this.disableImpostor,
quality:this.quality};Object.keys(this.parameters).forEach(function(b){a[b]=this[b]},this);return a},dispose:function(){this.bufferList.forEach(function(a){this.viewer.remove(a);a.dispose()},this);this.bufferList=[];this.debugBufferList.forEach(function(a){this.viewer.remove(a);a.dispose()},this);this.debugBufferList=[]}};
NGL.StructureRepresentation=function(a,b,c){this.selection=new NGL.Selection(c.sele);this.setStructure(a);NGL.Representation.call(this,a,b,c);this.selection.signals.stringChanged.add(function(a){this.rebuild()},this);this.create();this.manualAttach||this.attach()};
NGL.StructureRepresentation.prototype=NGL.createObject(NGL.Representation.prototype,{type:"",parameters:Object.assign({radiusType:{type:"select",options:NGL.RadiusFactory.types},radius:{type:"number",precision:3,max:10,min:.001},scale:{type:"number",precision:3,max:10,min:.001},transparent:{type:"boolean"},side:{type:"select",options:NGL.SideTypes},opacity:{type:"number",precision:1,max:1,min:0}},NGL.Representation.prototype.parameters),defaultScale:{vdw:1,covalent:1,bfactor:.01,ss:1},defaultSize:1,
init:function(a){a=a||{};this.color=void 0===a.color?"element":a.color;this.radius=a.radius||"vdw";this.scale=a.scale||1;this.transparent=void 0!==a.transparent?a.transparent:!1;this.side=void 0!==a.side?a.side:THREE.DoubleSide;this.opacity=void 0!==a.opacity?a.opacity:1;this.setSelection(a.sele,!0);NGL.Representation.prototype.init.call(this,a)},setStructure:function(a){this.structure=a;this.atomSet=new NGL.AtomSet(this.structure,this.selection);return this},setSelection:function(a,b){this.selection.setString(a,
b);return this},setParameters:function(a,b,c){b=b||{};a&&void 0!==a.radiusType&&(this.radius="size"===a.radiusType?this.defaultSize:a.radiusType,b.radius=!0,!NGL.extensionFragDepth||this.disableImpostor)&&(c=!0);a&&void 0!==a.radius&&(this.radius=a.radius,b.radius=!0,!NGL.extensionFragDepth||this.disableImpostor)&&(c=!0);a&&void 0!==a.scale&&(this.scale=a.scale,b.scale=!0,!NGL.extensionFragDepth||this.disableImpostor)&&(c=!0);a&&void 0!==a.transparent&&(this.transparent=a.transparent,c=!0);a&&void 0!==
a.side&&(this.side=a.side,c=!0);a&&void 0!==a.opacity&&(this.opacity=a.opacity,c=!0);NGL.Representation.prototype.setParameters.call(this,a,b,c);return this},attach:function(){var a=this.viewer,b=this.structure,c;c=b.biomolDict&&b.biomolDict[1]?Object.values(b.biomolDict[1].matrixDict):[];this.bufferList.forEach(function(b){1<c.length?a.add(b,c):a.add(b)});this.debugBufferList.forEach(function(b){1<c.length?a.add(b,c):a.add(b)});this.setVisibility(this.visible)}});
NGL.SpacefillRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.SpacefillRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"spacefill",parameters:Object.assign({sphereDetail:{type:"integer",max:3,min:0}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};this.disableImpostor=a.disableImpostor||!1;this.sphereDetail="low"===a.quality?0:"medium"===a.quality?1:"high"===a.quality?2:a.sphereDetail||1;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:
1;this.sphereBuffer=new NGL.SphereBuffer(this.atomSet.atomPosition(),this.atomSet.atomColor(null,this.color),this.atomSet.atomRadius(null,this.radius,this.scale),this.atomSet.atomColor(null,"picking"),this.sphereDetail,this.disableImpostor,this.transparent,this.side,a);this.bufferList=[this.sphereBuffer]},update:function(a){a=a||{};var b={};a.position&&(b.position=this.atomSet.atomPosition());a.color&&(b.color=this.atomSet.atomColor(null,this.color));if(a.radius||a.scale)b.radius=this.atomSet.atomRadius(null,
this.radius,this.scale);this.sphereBuffer.setAttributes(b)},setParameters:function(a){var b=!1;a&&void 0!==a.sphereDetail&&(this.sphereDetail=a.sphereDetail,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,{},b);return this}});NGL.PointRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.PointRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"point",parameters:Object.assign({pointSize:{type:"integer",max:20,min:1},sizeAttenuation:{type:"boolean"},sort:{type:"boolean"},transparent:{type:"boolean"},opacity:{type:"number",precision:1,max:1,min:0}},NGL.Representation.prototype.parameters),init:function(a){a=a||{};this.pointSize=a.pointSize||1;this.sizeAttenuation=void 0!==a.sizeAttenuation?a.sizeAttenuation:!1;this.sort=a.sort||!0;a.transparent=
void 0!==a.transparent?a.transparent:!0;a.opacity=void 0!==a.opacity?a.opacity:.6;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1;this.pointBuffer=new NGL.PointBuffer(this.atomSet.atomPosition(),this.atomSet.atomColor(null,this.color),this.pointSize,this.sizeAttenuation,this.sort,this.transparent,a);this.bufferList=[this.pointBuffer]},update:function(a){a=a||{};var b={};a.position&&(b.position=this.atomSet.atomPosition());a.color&&(b.color=
this.atomSet.atomColor(null,this.color));this.pointBuffer.setAttributes(b)},setParameters:function(a){var b=!1;a&&void 0!==a.pointSize&&(this.pointSize=a.pointSize,b=!0);a&&void 0!==a.sizeAttenuation&&(this.sizeAttenuation=a.sizeAttenuation,b=!0);a&&void 0!==a.sort&&(this.sort=a.sort,b=!0);a&&void 0!==a.transparent&&(this.transparent=a.transparent,b=!0);a&&void 0!==a.opacity&&(this.opacity=a.opacity,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,{},b);return this}});
NGL.LabelRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.LabelRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"label",parameters:Object.assign({labelType:{type:"select",options:NGL.LabelFactory.types},font:{type:"select",options:{Arial:"Arial",DejaVu:"DejaVu",LatoBlack:"LatoBlack"}},antialias:{type:"boolean"}},NGL.StructureRepresentation.prototype.parameters,{side:null}),init:function(a){a=a||{};a.color=a.color||16777215;this.labelType=a.labelType||"res";this.labelText=a.labelText||{};this.font=a.font||"Arial";
this.antialias=void 0!==a.antialias?a.antialias:!0;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1,b=[],c=new NGL.LabelFactory(this.labelType,this.labelText);this.atomSet.eachAtom(function(a){b.push(c.atomLabel(a))});this.textBuffer=new NGL.TextBuffer(this.atomSet.atomPosition(),this.atomSet.atomRadius(null,this.radius,this.scale),this.atomSet.atomColor(null,this.color),b,this.font,this.antialias,a);this.bufferList=[this.textBuffer]},
update:function(a){a=a||{};var b={};a.position&&(b.position=this.atomSet.atomPosition());if(a.size||a.scale)b.size=this.atomSet.atomRadius(null,this.radius,this.scale);a.color&&(b.color=this.atomSet.atomColor(null,this.color));this.textBuffer.setAttributes(b)},setParameters:function(a){var b=!1;a&&a.labelType&&(this.labelType=a.labelType,b=!0);a&&void 0!==a.font&&(this.font=a.font,b=!0);a&&void 0!==a.antialias&&(this.antialias=a.antialias,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,
a,{},b);return this}});NGL.BallAndStickRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.BallAndStickRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"ball+stick",defaultSize:.15,parameters:Object.assign({aspectRatio:{type:"number",precision:1,max:10,min:1},sphereDetail:{type:"integer",max:3,min:0},radiusSegments:{type:"integer",max:25,min:5}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.radius=a.radius||this.defaultSize;this.disableImpostor=a.disableImpostor||!1;"low"===a.quality?(this.sphereDetail=0,this.radiusSegments=
5):"medium"===a.quality?(this.sphereDetail=1,this.radiusSegments=10):"high"===a.quality?(this.sphereDetail=2,this.radiusSegments=20):(this.sphereDetail=a.sphereDetail||1,this.radiusSegments=a.radiusSegments||10);this.aspectRatio=a.aspectRatio||2;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1;this.sphereBuffer=new NGL.SphereBuffer(this.atomSet.atomPosition(),this.atomSet.atomColor(null,this.color),this.atomSet.atomRadius(null,this.radius,
this.scale*this.aspectRatio),this.atomSet.atomColor(null,"picking"),this.sphereDetail,this.disableImpostor,this.transparent,this.side,a);this.__center=new Float32Array(3*this.atomSet.bondCount);this.cylinderBuffer=new NGL.CylinderBuffer(this.atomSet.bondPosition(null,0),this.atomSet.bondPosition(null,1),this.atomSet.bondColor(null,0,this.color),this.atomSet.bondColor(null,1,this.color),this.atomSet.bondRadius(null,null,this.radius,this.scale),null,!0,this.atomSet.bondColor(null,0,"picking"),this.atomSet.bondColor(null,
1,"picking"),this.radiusSegments,this.disableImpostor,this.transparent,this.side,a);this.bufferList=[this.sphereBuffer,this.cylinderBuffer]},update:function(a){a=a||{};var b={},c={};if(a.position){b.position=this.atomSet.atomPosition();var d=this.atomSet.bondPosition(null,0),e=this.atomSet.bondPosition(null,1);c.position=NGL.Utils.calculateCenterArray(d,e,this.__center);c.position1=d;c.position2=e}a.color&&(b.color=this.atomSet.atomColor(null,this.color),c.color=this.atomSet.bondColor(null,0,this.color),
c.color2=this.atomSet.bondColor(null,1,this.color));if(a.radius||a.scale)b.radius=this.atomSet.atomRadius(null,this.radius,this.scale*this.aspectRatio),c.radius=this.atomSet.bondRadius(null,null,this.radius,this.scale);this.sphereBuffer.setAttributes(b);this.cylinderBuffer.setAttributes(c)},setParameters:function(a){var b=!1,c={};a&&a.aspectRatio&&(this.aspectRatio=a.aspectRatio,c.radius=!0,c.scale=!0,!NGL.extensionFragDepth||this.disableImpostor)&&(b=!0);a&&void 0!==a.sphereDetail&&(this.sphereDetail=
a.sphereDetail,b=!0);a&&a.radiusSegments&&(this.radiusSegments=a.radiusSegments,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,c,b);return this}});NGL.LicoriceRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.LicoriceRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"licorice",defaultSize:.15,parameters:Object.assign({sphereDetail:{type:"integer",max:3,min:0},radiusSegments:{type:"integer",max:25,min:5}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.radius=a.radius||this.defaultSize;this.disableImpostor=a.disableImpostor||!1;"low"===a.quality?(this.sphereDetail=0,this.radiusSegments=5):"medium"===a.quality?(this.sphereDetail=1,this.radiusSegments=
10):"high"===a.quality?(this.sphereDetail=2,this.radiusSegments=20):(this.sphereDetail=a.sphereDetail||1,this.radiusSegments=a.radiusSegments||10);NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1;this.sphereBuffer=new NGL.SphereBuffer(this.atomSet.atomPosition(),this.atomSet.atomColor(null,this.color),this.atomSet.atomRadius(null,this.radius,this.scale),this.atomSet.atomColor(null,"picking"),this.sphereDetail,this.disableImpostor,this.transparent,
this.side,a);this.cylinderBuffer=new NGL.CylinderBuffer(this.atomSet.bondPosition(null,0),this.atomSet.bondPosition(null,1),this.atomSet.bondColor(null,0,this.color),this.atomSet.bondColor(null,1,this.color),this.atomSet.bondRadius(null,null,this.radius,this.scale),null,!0,this.atomSet.bondColor(null,0,"picking"),this.atomSet.bondColor(null,1,"picking"),this.radiusSegments,this.disableImpostor,this.transparent,this.side,a);this.bufferList=[this.sphereBuffer,this.cylinderBuffer]},update:function(a){this.aspectRatio=
1;NGL.BallAndStickRepresentation.prototype.update.call(this,a)},setParameters:function(a){var b=!1;a&&void 0!==a.sphereDetail&&(this.sphereDetail=a.sphereDetail,b=!0);a&&a.radiusSegments&&(this.radiusSegments=a.radiusSegments,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,{},b);return this}});NGL.LineRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.LineRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"line",parameters:Object.assign({lineWidth:{type:"integer",max:20,min:1},transparent:{type:"boolean"},opacity:{type:"number",precision:1,max:1,min:0}},NGL.Representation.prototype.parameters),init:function(a){a=a||{};this.lineWidth=a.lineWidth||1;this.transparent=void 0!==a.transparent?a.transparent:!1;this.opacity=void 0!==a.opacity?a.opacity:1;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=
this.transparent?this.opacity:1;this.lineBuffer=new NGL.LineBuffer(this.atomSet.bondPosition(null,0),this.atomSet.bondPosition(null,1),this.atomSet.bondColor(null,0,this.color),this.atomSet.bondColor(null,1,this.color),this.lineWidth,this.transparent,a);this.bufferList=[this.lineBuffer]},update:function(a){a=a||{};var b={};a.position&&(b.from=this.atomSet.bondPosition(null,0),b.to=this.atomSet.bondPosition(null,1));a.color&&(b.color=this.atomSet.bondColor(null,0,this.color),b.color2=this.atomSet.bondColor(null,
1,this.color));this.lineBuffer.setAttributes(b)},setParameters:function(a,b,c){b=b||{};a&&void 0!==a.lineWidth&&(this.lineWidth=a.lineWidth,c=!0);a&&void 0!==a.transparent&&(this.transparent=a.transparent,c=!0);a&&void 0!==a.opacity&&(this.opacity=a.opacity,c=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,b,c);return this}});NGL.HyperballRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c);this.defaultScale.vdw=.2};
NGL.HyperballRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"hyperball",parameters:Object.assign({shrink:{type:"number",precision:3,max:1,min:.001},sphereDetail:{type:"integer",max:3,min:0},radiusSegments:{type:"integer",max:25,min:5}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.scale=a.scale||.2;this.disableImpostor=a.disableImpostor||!1;"low"===a.quality?(this.sphereDetail=0,this.radiusSegments=5):"medium"===a.quality?(this.sphereDetail=
1,this.radiusSegments=10):"high"===a.quality?(this.sphereDetail=2,this.radiusSegments=20):(this.sphereDetail=a.sphereDetail||1,this.radiusSegments=a.radiusSegments||10);this.shrink=a.shrink||.12;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1;this.sphereBuffer=new NGL.SphereBuffer(this.atomSet.atomPosition(),this.atomSet.atomColor(null,this.color),this.atomSet.atomRadius(null,this.radius,this.scale),this.atomSet.atomColor(null,"picking"),
this.sphereDetail,this.disableImpostor,this.transparent,this.side,a);this.__center=new Float32Array(3*this.atomSet.bondCount);this.cylinderBuffer=new NGL.HyperballStickBuffer(this.atomSet.bondPosition(null,0),this.atomSet.bondPosition(null,1),this.atomSet.bondColor(null,0,this.color),this.atomSet.bondColor(null,1,this.color),this.atomSet.bondRadius(null,0,this.radius,this.scale),this.atomSet.bondRadius(null,1,this.radius,this.scale),this.shrink,this.atomSet.bondColor(null,0,"picking"),this.atomSet.bondColor(null,
1,"picking"),this.radiusSegments,this.disableImpostor,this.transparent,this.side,a);this.bufferList=[this.sphereBuffer,this.cylinderBuffer]},update:function(a){a=a||{};var b={},c={};if(a.position){b.position=this.atomSet.atomPosition();var d=this.atomSet.bondPosition(null,0),e=this.atomSet.bondPosition(null,1);c.position=NGL.Utils.calculateCenterArray(d,e,this.__center);c.position1=d;c.position2=e}a.color&&(b.color=this.atomSet.atomColor(null,this.color),c.color=this.atomSet.bondColor(null,0,this.color),
c.color2=this.atomSet.bondColor(null,1,this.color));if(a.radius||a.scale)b.radius=this.atomSet.atomRadius(null,this.radius,this.scale),c.radius=this.atomSet.bondRadius(null,0,this.radius,this.scale),c.radius2=this.atomSet.bondRadius(null,1,this.radius,this.scale);this.sphereBuffer.setAttributes(b);this.cylinderBuffer.setAttributes(c)},setParameters:function(a){var b=!1;a&&a.shrink&&(this.shrink=a.shrink,b=!0);a&&void 0!==a.sphereDetail&&(this.sphereDetail=a.sphereDetail,b=!0);a&&a.radiusSegments&&
(this.radiusSegments=a.radiusSegments,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,{},b);return this}});NGL.BackboneRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.BackboneRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"backbone",defaultSize:.25,parameters:Object.assign({aspectRatio:{type:"number",precision:1,max:10,min:1},sphereDetail:{type:"integer",max:3,min:0},radiusSegments:{type:"integer",max:25,min:5}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.radius=a.radius||this.defaultSize;this.disableImpostor=a.disableImpostor||!1;"low"===a.quality?(this.sphereDetail=0,this.radiusSegments=
5):"medium"===a.quality?(this.sphereDetail=1,this.radiusSegments=10):"high"===a.quality?(this.sphereDetail=2,this.radiusSegments=20):(this.sphereDetail=a.sphereDetail||1,this.radiusSegments=a.radiusSegments||10);this.aspectRatio=a.aspectRatio||1;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1,b,c,d,e,f=[],g=[],h=[],k=this.color,l=this.radius,n=this.scale,m=this.aspectRatio,q=this.sphereDetail,s=this.radiusSegments,p=this.selection.test,
r=this.disableImpostor,u=this.transparent,x=this.side;this.structure.eachFiber(function(t){if(!(2>t.residueCount)){b=new NGL.AtomSet;c=new NGL.BondSet;b.structure=t.structure;c.structure=t.structure;g.push(b);h.push(c);var y,w;t.eachResidueN(2,function(a,d){y=a.getAtomByName(t.traceAtomname);w=d.getAtomByName(t.traceAtomname);p(y)&&p(w)&&(b.addAtom(y),c.addBond(y,w,!0))});p(y)&&p(w)&&b.addAtom(w);d=new NGL.SphereBuffer(b.atomPosition(),b.atomColor(null,k),b.atomRadius(null,l,n*m),b.atomColor(null,
"picking"),q,r,u,x,a);e=new NGL.CylinderBuffer(c.bondPosition(null,0),c.bondPosition(null,1),c.bondColor(null,0,k),c.bondColor(null,1,k),c.bondRadius(null,0,l,n),null,!0,c.bondColor(null,0,"picking"),c.bondColor(null,1,"picking"),s,r,u,x,a);f.push(d);f.push(e)}});this.bufferList=f;this.atomSetList=g;this.bondSetList=h},update:function(a){a=a||{};var b,c,d,e,f,g,h,k=this.atomSetList.length;for(h=0;h<k;++h){b=this.atomSetList[h];c=this.bondSetList[h];d=this.bufferList[2*h];e=this.bufferList[2*h+1];
f={};g={};if(a.position){f.position=b.atomPosition();var l=c.bondPosition(null,0),n=c.bondPosition(null,1);g.position=NGL.Utils.calculateCenterArray(l,n);g.position1=l;g.position2=n}a.color&&(f.color=b.atomColor(null,this.color),g.color=c.bondColor(null,0,this.color),g.color2=c.bondColor(null,1,this.color));if(a.radius||a.scale)f.radius=b.atomRadius(null,this.radius,this.scale*this.aspectRatio),g.radius=c.bondRadius(null,0,this.radius,this.scale);d.setAttributes(f);e.setAttributes(g)}},setParameters:function(a){var b=
!1,c={};a&&a.aspectRatio&&(this.aspectRatio=a.aspectRatio,c.radius=!0,c.scale=!0,!NGL.extensionFragDepth||this.disableImpostor)&&(b=!0);a&&void 0!==a.sphereDetail&&(this.sphereDetail=a.sphereDetail,b=!0);a&&a.radiusSegments&&(this.radiusSegments=a.radiusSegments,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,c,b);return this}});NGL.BaseRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.BaseRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"base",defaultSize:.2,parameters:Object.assign({aspectRatio:{type:"number",precision:1,max:10,min:1},sphereDetail:{type:"integer",max:3,min:0},radiusSegments:{type:"integer",max:25,min:5}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.radius=a.radius||this.defaultSize;this.disableImpostor=a.disableImpostor||!1;"low"===a.quality?(this.sphereDetail=0,this.radiusSegments=5):"medium"===
a.quality?(this.sphereDetail=1,this.radiusSegments=10):"high"===a.quality?(this.sphereDetail=2,this.radiusSegments=20):(this.sphereDetail=a.sphereDetail||1,this.radiusSegments=a.radiusSegments||10);this.aspectRatio=a.aspectRatio||1;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1,b,c,d,e,f=[],g=[],h=[],k=this.color,l=this.radius,n=this.scale,m=this.aspectRatio,q=this.sphereDetail,s=this.radiusSegments,p=this.selection.test,r=this.disableImpostor,
u=this.transparent,x=this.side;this.structure.eachFiber(function(t){if(!(1>t.residueCount)&&t.isNucleic()){b=new NGL.AtomSet;c=new NGL.BondSet;b.structure=t.structure;c.structure=t.structure;g.push(b);h.push(c);var y,w,A=["A","G","DA","DG"];t.eachResidue(function(a){y=a.getAtomByName(t.traceAtomname);w=-1!==A.indexOf(a.resname)?a.getAtomByName("N1"):a.getAtomByName("N3");p(y)&&(b.addAtom(y),b.addAtom(w),c.addBond(y,w,!0))});d=new NGL.SphereBuffer(b.atomPosition(),b.atomColor(null,k),b.atomRadius(null,
l,n*m),b.atomColor(null,"picking"),q,r,u,x,a);e=new NGL.CylinderBuffer(c.bondPosition(null,0),c.bondPosition(null,1),c.bondColor(null,0,k),c.bondColor(null,1,k),c.bondRadius(null,0,l,n),null,!0,c.bondColor(null,0,"picking"),c.bondColor(null,1,"picking"),s,r,u,x,a);f.push(d);f.push(e)}});this.bufferList=f;this.atomSetList=g;this.bondSetList=h},update:function(a){a=a||{};var b,c,d,e,f,g,h,k=this.atomSetList.length;for(h=0;h<k;++h){b=this.atomSetList[h];c=this.bondSetList[h];d=this.bufferList[2*h];e=
this.bufferList[2*h+1];f={};g={};if(a.position){f.position=b.atomPosition();var l=c.bondPosition(null,0),n=c.bondPosition(null,1);g.position=NGL.Utils.calculateCenterArray(l,n);g.position1=l;g.position2=n}a.color&&(f.color=b.atomColor(null,this.color),g.color=c.bondColor(null,0,this.color),g.color2=c.bondColor(null,1,this.color));if(a.radius||a.scale)f.radius=b.atomRadius(null,this.radius,this.scale*this.aspectRatio),g.radius=c.bondRadius(null,0,this.radius,this.scale);d.setAttributes(f);e.setAttributes(g)}},
setParameters:function(a){var b=!1,c={};a&&a.aspectRatio&&(this.aspectRatio=a.aspectRatio,c.radius=!0,c.scale=!0,!NGL.extensionFragDepth||this.disableImpostor)&&(b=!0);a&&void 0!==a.sphereDetail&&(this.sphereDetail=a.sphereDetail,b=!0);a&&a.radiusSegments&&(this.radiusSegments=a.radiusSegments,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,c,b);return this}});NGL.TubeRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.TubeRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"tube",defaultSize:.25,parameters:Object.assign({subdiv:{type:"integer",max:50,min:1},radialSegments:{type:"integer",max:50,min:1},tension:{type:"number",precision:1,max:1,min:.1},capped:{type:"boolean"},wireframe:{type:"boolean"}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.color=a.color||"ss";a.radius=a.radius||this.defaultSize;"low"===a.quality?(this.subdiv=3,this.radialSegments=
5):"medium"===a.quality?(this.subdiv=6,this.radialSegments=10):"high"===a.quality?(this.subdiv=12,this.radialSegments=20):(this.subdiv=a.subdiv||6,this.radialSegments=a.radialSegments||10);this.tension=a.tension||NaN;this.capped=a.capped||!0;this.wireframe=a.wireframe||!1;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this;this.bufferList=[];this.fiberList=[];var b=this.transparent?this.opacity:1;this.structure.eachFiber(function(c){if(!(4>c.residueCount)){var d=
new NGL.Spline(c),e=d.getSubdividedPosition(a.subdiv,a.tension),f=d.getSubdividedOrientation(a.subdiv,a.tension),g=d.getSubdividedColor(a.subdiv,a.color),d=d.getSubdividedSize(a.subdiv,a.radius,a.scale);a.bufferList.push(new NGL.TubeMeshBuffer(e.position,f.normal,f.binormal,f.tangent,g.color,d.size,a.radialSegments,g.pickingColor,1,1,a.capped,a.wireframe,a.transparent,parseInt(a.side),b));a.fiberList.push(c)}},this.selection,!0)},update:function(a){a=a||{};for(var b=0,c=this.fiberList.length,b=0;b<
c;++b){var d=this.fiberList[b];if(4>d.residueCount)break;var e={},d=new NGL.Spline(d);if(a.position||a.radius||a.scale){var f=d.getSubdividedPosition(this.subdiv,this.tension),g=d.getSubdividedOrientation(this.subdiv,this.tension),h=d.getSubdividedSize(this.subdiv,this.radius,this.scale);e.position=f.position;e.normal=g.normal;e.binormal=g.binormal;e.tangent=g.tangent;e.size=h.size}a.color&&(d=d.getSubdividedColor(this.subdiv,this.color),e.color=d.color,e.pickingColor=d.pickingColor);this.bufferList[b].setAttributes(e)}},
setParameters:function(a){var b=!1,c={};a&&a.subdiv&&(this.subdiv=a.subdiv,b=!0);a&&a.radialSegments&&(this.radialSegments=a.radialSegments,b=!0);a&&a.tension&&(this.tension=a.tension,c.radius=!0);a&&void 0!==a.capped&&(this.capped=a.capped,b=!0);a&&void 0!==a.wireframe&&(this.wireframe=a.wireframe,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,c,b);return this}});NGL.CartoonRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.CartoonRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"cartoon",parameters:Object.assign({aspectRatio:{type:"number",precision:1,max:10,min:1},subdiv:{type:"integer",max:50,min:1},radialSegments:{type:"integer",max:50,min:1},tension:{type:"number",precision:1,max:1,min:.1},capped:{type:"boolean"},wireframe:{type:"boolean"}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.color=a.color||"ss";a.radius=a.radius||"ss";"low"===a.quality?
(this.subdiv=3,this.radialSegments=6):"medium"===a.quality?(this.subdiv=6,this.radialSegments=10):"high"===a.quality?(this.subdiv=12,this.radialSegments=20):(this.subdiv=a.subdiv||6,this.radialSegments=a.radialSegments||10);this.aspectRatio=a.aspectRatio||3;this.tension=a.tension||NaN;this.capped=a.capped||!0;this.wireframe=a.wireframe||!1;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this;this.bufferList=[];this.fiberList=[];var b=this.transparent?this.opacity:
1;NGL.GET("debug")&&(a.debugBufferList=[]);this.structure.eachFiber(function(c){if(!(4>c.residueCount)){var d=new NGL.Spline(c),e=d.getSubdividedPosition(a.subdiv,a.tension),f=d.getSubdividedOrientation(a.subdiv,a.tension),g=d.getSubdividedColor(a.subdiv,a.color),d=d.getSubdividedSize(a.subdiv,a.radius,a.scale),h=1*a.aspectRatio,k=1;c.isCg()&&(k=h);a.bufferList.push(new NGL.TubeMeshBuffer(e.position,f.normal,f.binormal,f.tangent,g.color,d.size,a.radialSegments,g.pickingColor,h,k,a.capped,a.wireframe,
a.transparent,parseInt(a.side),b,a.nearClip));NGL.GET("debug")&&(a.debugBufferList.push(new NGL.BufferVectorHelper(e.position,e.normal,"skyblue",1.5)),a.debugBufferList.push(new NGL.BufferVectorHelper(e.position,e.binormal,"lightgreen",1.5)),a.debugBufferList.push(new NGL.BufferVectorHelper(e.position,e.tangent,"orange",1.5)));a.fiberList.push(c)}},this.selection,!0)},update:function(a){a=a||{};for(var b=0,c=this.fiberList.length,b=0;b<c;++b){var d=this.fiberList[b];if(4>d.residueCount)break;var e=
{},d=new NGL.Spline(d);this.bufferList[b].rx=this.aspectRatio;if(a.position||a.radius||a.scale){var f=d.getSubdividedPosition(this.subdiv,this.tension),g=d.getSubdividedOrientation(this.subdiv,this.tension),h=d.getSubdividedSize(this.subdiv,this.radius,this.scale);e.position=f.position;e.normal=g.normal;e.binormal=g.binormal;e.tangent=g.tangent;e.size=h.size}a.color&&(d=d.getSubdividedColor(this.subdiv,this.color),e.color=d.color,e.pickingColor=d.pickingColor);this.bufferList[b].setAttributes(e);
NGL.GET("debug")&&(this.debugBufferList[3*b+0].setAttributes(e),this.debugBufferList[3*b+1].setAttributes(e),this.debugBufferList[3*b+2].setAttributes(e))}},setParameters:function(a){var b=!1,c={};a&&a.aspectRatio&&(this.aspectRatio=a.aspectRatio,c.radius=!0);a&&a.subdiv&&(this.subdiv=a.subdiv,b=!0);a&&a.radialSegments&&(this.radialSegments=a.radialSegments,b=!0);a&&a.tension&&(this.tension=a.tension,c.position=!0);a&&void 0!==a.capped&&(this.capped=a.capped,b=!0);a&&void 0!==a.wireframe&&(this.wireframe=
a.wireframe,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,c,b);return this}});NGL.RibbonRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c);this.defaultScale.ss*=3};
NGL.RibbonRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"ribbon",parameters:Object.assign({subdiv:{type:"integer",max:50,min:1},tension:{type:"number",precision:1,max:1,min:.1}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.color=a.color||"ss";a.radius=a.radius||"ss";a.scale=a.scale||3;this.subdiv="low"===a.quality?3:"medium"===a.quality?6:"high"===a.quality?12:a.subdiv||6;this.tension=a.tension||NaN;NGL.StructureRepresentation.prototype.init.call(this,
a)},create:function(){var a=this;this.bufferList=[];this.fiberList=[];var b=this.transparent?this.opacity:1;this.structure.eachFiber(function(c){if(!(4>c.residueCount)){var d=new NGL.Spline(c),e=d.getSubdividedPosition(a.subdiv,a.tension),f=d.getSubdividedOrientation(a.subdiv,a.tension),g=d.getSubdividedColor(a.subdiv,a.color),d=d.getSubdividedSize(a.subdiv,a.radius,a.scale);a.bufferList.push(new NGL.RibbonBuffer(e.position,f.binormal,f.normal,g.color,d.size,g.pickingColor,a.transparent,parseInt(a.side),
b));a.fiberList.push(c)}},this.selection,!0)},update:function(a){a=a||{};for(var b=0,c=this.fiberList.length,b=0;b<c;++b){var d=this.fiberList[b];if(4>d.residueCount)break;var e={},d=new NGL.Spline(d);if(a.position){var f=d.getSubdividedPosition(this.subdiv,this.tension),g=d.getSubdividedOrientation(this.subdiv,this.tension);e.position=f.position;e.normal=g.binormal;e.dir=g.normal}if(a.radius||a.scale)f=d.getSubdividedSize(this.subdiv,this.radius,this.scale),e.size=f.size;a.color&&(d=d.getSubdividedColor(this.subdiv,
this.color),e.color=d.color,e.pickingColor=d.pickingColor);this.bufferList[b].setAttributes(e)}},setParameters:function(a){var b=!1;a&&a.subdiv&&(this.subdiv=a.subdiv,b=!0);a&&a.tension&&(this.tension=a.tension,this.update({position:!0}));NGL.StructureRepresentation.prototype.setParameters.call(this,a,{},b);return this}});NGL.TraceRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.TraceRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"trace",parameters:Object.assign({subdiv:{type:"integer",max:50,min:1},tension:{type:"number",precision:1,max:1,min:.1},lineWidth:{type:"integer",max:20,min:1},transparent:{type:"boolean"},opacity:{type:"number",precision:1,max:1,min:0}},NGL.Representation.prototype.parameters),init:function(a){a=a||{};a.color=a.color||"ss";this.subdiv="low"===a.quality?3:"medium"===a.quality?6:"high"===a.quality?12:a.subdiv||
6;this.tension=a.tension||NaN;this.lineWidth=a.lineWidth||1;this.transparent=void 0!==a.transparent?a.transparent:!1;this.opacity=void 0!==a.opacity?a.opacity:1;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1,b=this;this.bufferList=[];this.fiberList=[];this.structure.eachFiber(function(c){if(!(4>c.residueCount)){var d=new NGL.Spline(c),e=d.getSubdividedPosition(b.subdiv,b.tension),d=d.getSubdividedColor(b.subdiv,b.color);b.bufferList.push(new NGL.TraceBuffer(e.position,
d.color,b.lineWidth,b.transparent,a));b.fiberList.push(c)}},this.selection,!0)},update:function(a){a=a||{};for(var b=0,c=this.fiberList.length,b=0;b<c;++b){var d=this.fiberList[b];if(4>d.residueCount)break;var e={},d=new NGL.Spline(d);if(a.position){var f=d.getSubdividedPosition(this.subdiv,this.tension);e.position=f.position}a.color&&(d=d.getSubdividedColor(this.subdiv,this.color),e.color=d.color);this.bufferList[b].setAttributes(e)}},setParameters:function(a){var b=!1,c={};a&&a.subdiv&&(this.subdiv=
a.subdiv,b=!0);a&&a.tension&&(this.tension=a.tension,c.position=!0);a&&void 0!==a.lineWidth&&(this.lineWidth=a.lineWidth,b=!0);a&&void 0!==a.transparent&&(this.transparent=a.transparent,b=!0);a&&void 0!==a.opacity&&(this.opacity=a.opacity,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,c,b);return this}});NGL.HelixorientRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.HelixorientRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"helixorient",parameters:Object.assign({},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.color=a.color||"ss";a.radius=a.radius||.15;a.scale=a.scale||1;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1,b=this;this.bufferList=[];this.fiberList=[];this.structure.eachFiber(function(c){if(!(4>c.residueCount||c.isNucleic())){var d=
new NGL.Helixorient(c),e=d.getPosition(),f=d.getColor(b.color),d=d.getSize(b.radius,b.scale);b.bufferList.push(new NGL.SphereBuffer(e.center,f.color,d.size,f.pickingColor,b.sphereDetail,b.disableImpostor,b.transparent,b.side,a));b.bufferList.push(new NGL.BufferVectorHelper(e.center,e.axis,"skyblue",1));b.bufferList.push(new NGL.BufferVectorHelper(e.center,e.resdir,"lightgreen",1));b.fiberList.push(c)}},this.selection)},update:function(a){a=a||{};for(var b,c=0,d=this.fiberList.length,c=0;c<d;++c){b=
3*c;var e=this.fiberList[c];if(4>e.residueCount)break;var f={},e=new NGL.Helixorient(e);a.position&&(e=e.getPosition(),f.position=e.center,this.bufferList[b+1].setAttributes({position:e.center,vector:e.axis}),this.bufferList[b+2].setAttributes({position:e.center,vector:e.redir}));this.bufferList[b].setAttributes(f)}},setParameters:function(a){NGL.StructureRepresentation.prototype.setParameters.call(this,a,{},!1);return this}});
NGL.RocketRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.RocketRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"rocket",parameters:Object.assign({localAngle:{type:"integer",max:180,min:0},centerDist:{type:"number",precision:1,max:10,min:0},ssBorder:{type:"boolean"},radiusSegments:{type:"integer",max:25,min:5}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.color=a.color||"ss";a.radius=a.radius||1.5;a.scale=a.scale||1;this.disableImpostor=a.disableImpostor||!1;this.radiusSegments="low"===
a.quality?5:"medium"===a.quality?10:"high"===a.quality?20:a.radiusSegments||10;this.localAngle=a.localAngle||30;this.centerDist=a.centerDist||2.5;this.ssBorder=void 0===a.ssBorder?!1:a.ssBorder;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this.transparent?this.opacity:1,b=this;this.bufferList=[];this.fiberList=[];this.centerList=[];this.structure.eachFiber(function(c){if(!(4>c.residueCount||c.isNucleic())){var d=(new NGL.Helixbundle(c)).getAxis(b.localAngle,b.centerDist,
b.ssBorder,b.color,b.radius,b.scale);b.bufferList.push(new NGL.CylinderBuffer(d.begin,d.end,d.color,d.color,d.size,null,!0,d.pickingColor,d.pickingColor,b.radiusSegments,b.disableImpostor,b.transparent,b.side,a));b.fiberList.push(c);b.centerList.push(new Float32Array(d.begin.length))}},this.selection)},update:function(a){this.rebuild()},setParameters:function(a){var b=!1;a&&void 0!==a.localAngle&&(this.localAngle=a.localAngle,b=!0);a&&void 0!==a.centerDist&&(this.centerDist=a.centerDist,b=!0);a&&
void 0!==a.ssBorder&&(this.ssBorder=a.ssBorder,b=!0);a&&a.radiusSegments&&(this.radiusSegments=a.radiusSegments,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,{},b);return this}});NGL.RopeRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.RopeRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"rope",parameters:Object.assign({subdiv:{type:"integer",max:50,min:1},radialSegments:{type:"integer",max:50,min:1},tension:{type:"number",precision:1,max:1,min:.1},capped:{type:"boolean"},wireframe:{type:"boolean"},smooth:{type:"integer",max:15,min:0}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||{};a.color=a.color||"ss";a.radius=a.radius||this.defaultSize;"low"===a.quality?(this.subdiv=
3,this.radialSegments=5):"medium"===a.quality?(this.subdiv=6,this.radialSegments=10):"high"===a.quality?(this.subdiv=12,this.radialSegments=20):(this.subdiv=a.subdiv||6,this.radialSegments=a.radialSegments||10);this.tension=a.tension||.5;this.capped=a.capped||!0;this.wireframe=a.wireframe||!1;this.smooth=void 0===a.smooth?2:a.smooth;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=this;this.bufferList=[];this.fiberList=[];var b=this.transparent?this.opacity:1;this.structure.eachFiber(function(c){if(!(4>
c.residueCount||c.isNucleic())){var d=new NGL.Helixorient(c),e=new NGL.Spline(d.getFiber(a.smooth,!0)),d=e.getSubdividedPosition(a.subdiv,a.tension),f=e.getSubdividedOrientation(a.subdiv,a.tension),g=e.getSubdividedColor(a.subdiv,a.color),e=e.getSubdividedSize(a.subdiv,a.radius,a.scale);a.bufferList.push(new NGL.TubeMeshBuffer(d.position,f.normal,f.binormal,f.tangent,g.color,e.size,a.radialSegments,g.pickingColor,1,1,a.capped,a.wireframe,a.transparent,parseInt(a.side),b));a.fiberList.push(c)}},this.selection)},
update:function(a){a=a||{};for(var b=0,c=this.fiberList.length,b=0;b<c;++b){var d=this.fiberList[b];if(4>d.residueCount)break;var e={},d=new NGL.Helixorient(d),d=new NGL.Spline(d.getFiber(this.smooth,!0));if(a.position||a.radius||a.scale){var f=d.getSubdividedPosition(this.subdiv,this.tension),g=d.getSubdividedOrientation(this.subdiv,this.tension),h=d.getSubdividedSize(this.subdiv,this.radius,this.scale);e.position=f.position;e.normal=g.normal;e.binormal=g.binormal;e.tangent=g.tangent;e.size=h.size}a.color&&
(d=d.getSubdividedColor(this.subdiv,this.color),e.color=d.color,e.pickingColor=d.pickingColor);this.bufferList[b].setAttributes(e)}},setParameters:function(a){var b=!1,c={};a&&a.subdiv&&(this.subdiv=a.subdiv,b=!0);a&&a.radialSegments&&(this.radialSegments=a.radialSegments,b=!0);a&&a.tension&&(this.tension=a.tension,c.radius=!0);a&&void 0!==a.capped&&(this.capped=a.capped,b=!0);a&&void 0!==a.wireframe&&(this.wireframe=a.wireframe,b=!0);a&&void 0!==a.smooth&&(this.smooth=a.smooth,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,
a,c,b);return this}});NGL.CrossingRepresentation=function(a,b,c){NGL.StructureRepresentation.call(this,a,b,c)};
NGL.CrossingRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"crossing",parameters:Object.assign({localAngle:{type:"integer",max:180,min:0},centerDist:{type:"number",precision:1,max:10,min:0},ssBorder:{type:"boolean"},radiusSegments:{type:"integer",max:25,min:5},helixDist:{type:"number",precision:1,max:30,min:0},displayLabel:{type:"boolean"},download:{type:"button",methodName:"download"}},NGL.StructureRepresentation.prototype.parameters),init:function(a){a=a||
{};a.color=a.color||"ss";a.radius=a.radius||.7;a.scale=a.scale||1;this.disableImpostor=a.disableImpostor||!1;this.radiusSegments="low"===a.quality?5:"medium"===a.quality?10:"high"===a.quality?20:a.radiusSegments||10;this.localAngle=a.localAngle||30;this.centerDist=a.centerDist||2.5;this.ssBorder=void 0===a.ssBorder?!1:a.ssBorder;this.helixDist=a.helixDist||12;this.displayLabel=void 0===a.displayLabel?!0:a.displayLabel;NGL.StructureRepresentation.prototype.init.call(this,a)},create:function(){var a=
this,b=this.transparent?this.opacity:1;this.bufferList=[];this.fiberList=[];this.centerList=[];this.helixList=[];this.structure.eachFiber(function(c){if(!(4>c.residueCount||c.isNucleic())){var d=(new NGL.Helixbundle(c)).getAxis(a.localAngle,a.centerDist,a.ssBorder,a.color,a.radius,a.scale);a.bufferList.push(new NGL.CylinderBuffer(d.begin,d.end,d.color,d.color,d.size,null,!0,d.pickingColor,d.pickingColor,a.radiusSegments,a.disableImpostor,a.transparent,a.side,b));a.fiberList.push(c);a.centerList.push(new Float32Array(d.begin.length));
for(c=0;c<d.residue.length;++c){var g=new NGL.Helix;g.fromHelixbundleAxis(d,c);a.helixList.push(g)}}},this.selection);var c=(new NGL.HelixCrossing(this.helixList)).getCrossing(this.helixDist);this.crossing=c;var d=c.end.length/3;this.bufferList.push(new NGL.CylinderBuffer(new Float32Array(c.begin),new Float32Array(c.end),NGL.Utils.uniformArray3(d,.2,.2,.9),NGL.Utils.uniformArray3(d,.2,.2,.9),NGL.Utils.uniformArray(d,.1),null,!0,NGL.Utils.uniformArray3(d,0,0,0),NGL.Utils.uniformArray3(d,0,0,0),this.radiusSegments,
this.disableImpostor,this.transparent,this.side,b));this.displayLabel&&(d=c.helixLabel.length,this.bufferList.push(new NGL.TextBuffer(c.helixCenter,NGL.Utils.uniformArray(d,2.5),NGL.Utils.uniformArray3(d,1,1,1),c.helixLabel)))},update:function(a){this.rebuild()},setParameters:function(a){var b=!1;a&&void 0!==a.localAngle&&(this.localAngle=a.localAngle,b=!0);a&&void 0!==a.centerDist&&(this.centerDist=a.centerDist,b=!0);a&&void 0!==a.helixDist&&(this.helixDist=a.helixDist,b=!0);a&&void 0!==a.ssBorder&&
(this.ssBorder=a.ssBorder,b=!0);a&&void 0!==a.displayLabel&&(this.displayLabel=a.displayLabel,b=!0);a&&a.radiusSegments&&(this.radiusSegments=a.radiusSegments,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,a,{},b);return this},download:function(){var a=JSON.stringify(this.crossing.info,null,"\t");NGL.download(new Blob([a],{type:"text/plain"}),"helixCrossing.json")}});
NGL.TrajectoryRepresentation=function(a,b,c){this.manualAttach=!0;this.trajectory=a;NGL.StructureRepresentation.call(this,a.structure,b,c)};
NGL.TrajectoryRepresentation.prototype=NGL.createObject(NGL.StructureRepresentation.prototype,{type:"",parameters:Object.assign({drawLine:{type:"boolean"},drawCylinder:{type:"boolean"},drawPoint:{type:"boolean"},drawSphere:{type:"boolean"},lineWidth:{type:"integer",max:20,min:1},pointSize:{type:"integer",max:20,min:1},sizeAttenuation:{type:"boolean"},sort:{type:"boolean"},transparent:{type:"boolean"},side:{type:"select",options:NGL.SideTypes},opacity:{type:"number",precision:1,max:1,min:0}},NGL.Representation.prototype.parameters),
init:function(a){a=a||{};a.color=a.color||14540253;this.drawLine=a.drawLine||!0;this.drawCylinder=a.drawCylinder||!1;this.drawPoint=a.drawPoint||!1;this.drawSphere=a.drawSphere||!1;this.lineWidth=a.lineWidth||1;this.pointSize=a.pointSize||1;this.sizeAttenuation=void 0!==a.sizeAttenuation?a.sizeAttenuation:!1;this.sort=a.sort||!0;a.transparent=void 0!==a.transparent?a.transparent:!0;a.side=void 0!==a.side?a.side:THREE.DoubleSide;a.opacity=void 0!==a.opacity?a.opacity:.6;NGL.StructureRepresentation.prototype.init.call(this,
a)},attach:function(){this.bufferList.forEach(function(a){this.viewer.add(a)},this);this.setVisibility(this.visible)},create:function(){this.bufferList=[];if(this.atomSet.atoms.length){var a=this,b=this.transparent?this.opacity:1;this.trajectory.getPath(this.atomSet.atoms[0].index,function(c){var d=c.length/3,e=new THREE.Color(a.color);if(a.drawSphere){var f=new NGL.SphereBuffer(c,NGL.Utils.uniformArray3(d,e.r,e.g,e.b),NGL.Utils.uniformArray(d,.2),NGL.Utils.uniformArray3(d,e.r,e.g,e.b),a.sphereDetail,
a.disableImpostor,a.transparent,a.side,b);a.bufferList.push(f)}a.drawCylinder&&(f=new NGL.CylinderBuffer(c.subarray(0,-3),c.subarray(3),NGL.Utils.uniformArray3(d-1,e.r,e.g,e.b),NGL.Utils.uniformArray3(d-1,e.r,e.g,e.b),NGL.Utils.uniformArray(d,.05),null,!0,NGL.Utils.uniformArray3(d-1,e.r,e.g,e.b),NGL.Utils.uniformArray3(d-1,e.r,e.g,e.b),a.radiusSegments,a.disableImpostor,a.transparent,a.side,b),a.bufferList.push(f));a.drawPoint&&(f=new NGL.PointBuffer(c,NGL.Utils.uniformArray3(d,e.r,e.g,e.b),a.pointSize,
a.sizeAttenuation,a.sort,a.transparent,b),a.bufferList.push(f));a.drawLine&&(c=new NGL.LineBuffer(c.subarray(0,-3),c.subarray(3),NGL.Utils.uniformArray3(d-1,e.r,e.g,e.b),NGL.Utils.uniformArray3(d-1,e.r,e.g,e.b),a.lineWidth,a.transparent,b),a.bufferList.push(c));a.attach()})}},setParameters:function(a){var b=!1;a&&void 0!==a.drawLine&&(this.drawLine=a.drawLine,b=!0);a&&void 0!==a.drawCylinder&&(this.drawCylinder=a.drawCylinder,b=!0);a&&void 0!==a.drawPoint&&(this.drawPoint=a.drawPoint,b=!0);a&&void 0!==
a.drawSphere&&(this.drawSphere=a.drawSphere,b=!0);a&&void 0!==a.lineWidth&&(this.lineWidth=a.lineWidth,b=!0);a&&void 0!==a.pointSize&&(this.pointSize=a.pointSize,b=!0);a&&void 0!==a.sizeAttenuation&&(this.sizeAttenuation=a.sizeAttenuation,b=!0);a&&void 0!==a.sort&&(this.sort=a.sort,b=!0);a&&void 0!==a.transparent&&(this.transparent=a.transparent,b=!0);a&&void 0!==a.side&&(this.side=a.side,b=!0);a&&void 0!==a.opacity&&(this.opacity=a.opacity,b=!0);NGL.StructureRepresentation.prototype.setParameters.call(this,
a,{},b);return this}});NGL.SurfaceRepresentation=function(a,b,c){NGL.Representation.call(this,a,b,c);this.surface=a;this.create();this.attach()};
NGL.SurfaceRepresentation.prototype=NGL.createObject(NGL.Representation.prototype,{type:"",parameters:Object.assign({wireframe:{type:"boolean"},background:{type:"boolean"},transparent:{type:"boolean"},side:{type:"select",options:NGL.SideTypes},opacity:{type:"number",precision:1,max:1,min:0}},NGL.Representation.prototype.parameters),init:function(a){a=a||{};this.color=a.color||14540253;this.background=a.background||!1;this.wireframe=a.wireframe||!1;this.transparent=void 0!==a.transparent?a.transparent:
!1;this.side=void 0!==a.side?a.side:THREE.DoubleSide;this.opacity=void 0!==a.opacity?a.opacity:1;NGL.Representation.prototype.init.call(this,a)},attach:function(){this.bufferList.forEach(function(a){this.viewer.add(a,void 0,this.background)},this);this.setVisibility(this.visible)},create:function(){var a,b=this.surface.object;b instanceof THREE.Geometry?(a=b,a.computeFaceNormals(!0),a.computeVertexNormals(!0)):a=b.children[0].geometry;a.computeBoundingSphere();this.center=(new THREE.Vector3).copy(a.boundingSphere.center);
var c,d;a instanceof THREE.BufferGeometry?(b=a.attributes.normal.array,0===b[0]&&0===b[1]&&0===b[2]&&a.computeVertexNormals(),b=a.attributes.position.array,d=null,a=a.attributes.normal.array):(console.log("TODO non BufferGeometry surface"),b=NGL.Utils.positionFromGeometry(a),d=NGL.Utils.indexFromGeometry(a),a=NGL.Utils.normalFromGeometry(a));var e=b.length/3;c=new THREE.Color(this.color);c=NGL.Utils.uniformArray3(e,c.r,c.g,c.b);var f=this.transparent?this.opacity:1;this.transparent&&parseInt(this.side)===
THREE.DoubleSide?(e=new NGL.SurfaceBuffer(b,c,d,a,void 0,this.wireframe,this.transparent,THREE.FrontSide,f,this.nearClip),b=new NGL.SurfaceBuffer(b,c,d,a,void 0,this.wireframe,this.transparent,THREE.BackSide,f,this.nearClip),this.bufferList=[e,b]):(this.surfaceBuffer=new NGL.SurfaceBuffer(b,c,d,a,void 0,this.wireframe,this.transparent,parseInt(this.side),f,this.nearClip),this.bufferList=[this.surfaceBuffer])},setParameters:function(a){var b=!1;a&&void 0!==a.wireframe&&(this.wireframe=a.wireframe,
b=!0);a&&void 0!==a.background&&(this.background=a.background,b=!0);a&&void 0!==a.transparent&&(this.transparent=a.transparent,b=!0);a&&void 0!==a.side&&(this.side=a.side,b=!0);a&&void 0!==a.opacity&&(this.opacity=a.opacity,b=!0);NGL.Representation.prototype.setParameters.call(this,a,{},b);return this}});NGL.representationTypes={};for(var key in NGL)NGL[key].prototype instanceof NGL.StructureRepresentation&&(NGL.representationTypes[NGL[key].prototype.type]=NGL[key]);
NGL.Stage=function(a){var b=signals;this.signals={themeChanged:new b.Signal,componentAdded:new b.Signal,componentRemoved:new b.Signal,atomPicked:new b.Signal,windowResize:new b.Signal};this.compList=[];this.preferences=new NGL.Preferences(this);this.viewer=new NGL.Viewer(a);this.preferences.setTheme();this.initFileDragDrop();this.viewer.animate();this.pickingControls=new NGL.PickingControls(this.viewer,this)};
NGL.Stage.prototype={defaultFileRepresentation:function(a){a instanceof NGL.StructureComponent?1E5<a.structure.atomCount||(a.addRepresentation("cartoon",{sele:"*"}),a.addRepresentation("licorice",{sele:"hetero"}),a.centerView(void 0,!0),a.structure.frames&&a.addTrajectory()):a instanceof NGL.SurfaceComponent?(a.addRepresentation(),a.centerView()):a instanceof NGL.ScriptComponent&&a.run()},initFileDragDrop:function(){this.viewer.container.addEventListener("dragover",function(a){a.stopPropagation();
a.preventDefault();a.dataTransfer.dropEffect="copy"},!1);this.viewer.container.addEventListener("drop",function(a){a.stopPropagation();a.preventDefault();a=a.dataTransfer.files;for(var b=a.length,c=0;c<b;++c)this.loadFile(a[c])}.bind(this),!1)},loadFile:function(a,b,c,d,e){var f,g=this,h;NGL.autoLoad(a,function(a){f&&g.removeComponent(f);if(a instanceof NGL.Structure)f=new NGL.StructureComponent(g,a,c);else if(a instanceof NGL.Surface)f=new NGL.SurfaceComponent(g,a,c);else if(a instanceof NGL.Script)f=
new NGL.ScriptComponent(g,a,c);else{console.warn("NGL.Stage.loadFile: object type unknown",a);return}g.addComponent(f);"function"===typeof b?b(f):g.defaultFileRepresentation(f)},void 0,function(a){h=a;f&&f.setStatus(a);"function"===typeof d&&d(a)},e);f||(f=new NGL.Component(this,c),f.name=(a instanceof File?a.name:a).replace(/^.*[\\\/]/,""),this.addComponent(f));h&&f.setStatus(h)},addComponent:function(a){a?(this.compList.push(a),this.signals.componentAdded.dispatch(a)):console.warn("NGL.Stage.addComponent: no component given")},
removeComponent:function(a){var b=this.compList.indexOf(a);-1!==b&&this.compList.splice(b,1);a.dispose();this.signals.componentRemoved.dispatch(a)},centerView:function(){this.viewer.centerView(void 0,!0)},setTheme:function(a){var b;"light"===a?(a="../css/light.css",b="white"):(a="../css/dark.css",b="black");document.getElementById("theme").href=a;this.viewer.setBackground(b)},eachComponent:function(a,b){this.compList.forEach(function(c,d){(!b||c instanceof b)&&a(c,d)})},eachRepresentation:function(a,
b){this.eachComponent(function(b){b.reprList.forEach(function(d){a(d,b)})},b)}};
NGL.PickingControls=function(a,b){var c=a.renderer.getContext(),d=new Uint8Array(4),e={position:new THREE.Vector2,down:new THREE.Vector2,moving:!1,distance:function(){return e.position.distanceTo(e.down)}};a.renderer.domElement.addEventListener("mousemove",function(a){e.moving=!0;e.position.x=a.layerX;e.position.y=a.layerY});a.renderer.domElement.addEventListener("mousedown",function(a){e.moving=!1;e.down.x=a.layerX;e.down.y=a.layerY});a.renderer.domElement.addEventListener("mouseup",function(f){if(!(3<
e.distance()||f.which===NGL.RightMouseButton)){a.render(null,!0);var g=a.renderer.domElement.getBoundingClientRect(),h=f.clientX-g.left,k=f.clientY-g.top;c.readPixels(h*window.devicePixelRatio,(g.height-k)*window.devicePixelRatio,1,1,c.RGBA,c.UNSIGNED_BYTE,d);var l=Array.apply([],d),n=d[0]<<16|d[1]<<8|d[2],m=void 0;b.eachComponent(function(a){a.structure.eachAtom(function(a){a.globalindex===n-1&&(m=a)})},NGL.StructureComponent);b.signals.atomPicked.dispatch(m);NGL.GET("debug")?(console.log("picked color",
[(l[0]/255).toPrecision(2),(l[1]/255).toPrecision(2),(l[2]/255).toPrecision(2),(l[3]/255).toPrecision(2)]),console.log("picked id",n),console.log("picked position",h,g.height-k),console.log("devicePixelRatio",window.devicePixelRatio)):a.requestRender();m&&f.which===NGL.MiddleMouseButton&&a.centerView(m)}})};
NGL.Preferences=function(a,b){this.id=b||"ngl-stage";this.stage=a;this.storage={impostor:!0,quality:"medium",theme:"dark"};if(void 0===window.localStorage[this.id])window.localStorage[this.id]=JSON.stringify(this.storage);else{var c=JSON.parse(window.localStorage[this.id]),d;for(d in c)this.storage[d]=c[d]}};
NGL.Preferences.prototype={setImpostor:function(a){void 0!==a?this.setKey("impostor",a):a=this.getKey("impostor");var b="spacefill ball+stick licorice hyperball backbone rocket crossing".split(" ");this.stage.eachRepresentation(function(c){if(-1!==b.indexOf(c.getType())){var d=c.getParameters();d.disableImpostor=!a;c.rebuild(d)}},NGL.StructureComponent)},setQuality:function(a){void 0!==a?this.setKey("quality",a):a=this.getKey("quality");var b=["tube","cartoon","ribbon","trace","rope"],c="spacefill ball+stick licorice hyperball backbone rocket crossing".split(" ");
this.stage.eachRepresentation(function(d){var e=d.getParameters();if(-1===b.indexOf(d.getType())){if(-1===c.indexOf(d.getType()))return;if(NGL.extensionFragDepth&&!e.disableImpostor){d.repr.quality=a;return}}e.quality=a;d.rebuild(e)},NGL.StructureComponent)},setTheme:function(a){void 0!==a?this.setKey("theme",a):a=this.getKey("theme");this.stage.setTheme(a)},getKey:function(a){return this.storage[a]},setKey:function(a,b){this.storage[a]=b;window.localStorage[this.id]=JSON.stringify(this.storage)},
clear:function(){delete window.localStorage[this.id]}};NGL.Component=function(a,b){b=b||{};void 0!==b.name&&(this.name=b.name);this.id=b.id;this.tags=b.tags||[];this.visible=void 0!==b.visible?b.visible:!0;this.signals=NGL.makeObjectSignals(this);this.stage=a;this.viewer=a.viewer;this.reprList=[]};
NGL.Component.prototype={type:"component",signals:{representationAdded:null,representationRemoved:null,visibilityChanged:null,requestGuiVisibility:null,statusChanged:null,disposed:null},addRepresentation:function(a){this.reprList.push(a);this.signals.representationAdded.dispatch(a);return this},removeRepresentation:function(a){var b=this.reprList.indexOf(a);-1!==b&&this.reprList.splice(b,1);this.signals.representationRemoved.dispatch(a)},updateRepresentations:function(a){this.reprList.forEach(function(b){b.update(a)});
this.stage.viewer.requestRender()},dispose:function(){this.reprList.slice().forEach(function(a){a.dispose()});delete this.reprList;this.signals.disposed.dispatch()},setVisibility:function(a){this.visible=a;this.eachRepresentation(function(a){a.updateVisibility()});this.signals.visibilityChanged.dispatch(a);return this},setStatus:function(a){this.status=a;this.signals.statusChanged.dispatch(a);return this},getCenter:function(){},requestGuiVisibility:function(a){this.signals.requestGuiVisibility.dispatch(a);
return this},eachRepresentation:function(a){this.reprList.forEach(a)}};NGL.ObjectMetadata.prototype.apply(NGL.Component.prototype);NGL.StructureComponent=function(a,b,c){c=c||{};this.structure=this.__structure=b;this.name=b.name;NGL.Component.call(this,a,c);this.trajList=[];this.initSelection(c.sele)};
NGL.StructureComponent.prototype=NGL.createObject(NGL.Component.prototype,{type:"structure",signals:Object.assign({trajectoryAdded:null,trajectoryRemoved:null},NGL.Component.prototype.signals),initSelection:function(a){this.selection=new NGL.Selection(a);this.selection.signals.stringChanged.add(function(a){this.applySelection();this.rebuildRepresentations(!0);this.rebuildTrajectories()},this);this.applySelection()},applySelection:function(){this.structure=this.selection.string?new NGL.StructureSubset(this.__structure,
this.selection.string):this.__structure},setSelection:function(a){this.selection.setString(a);return this},rebuildRepresentations:function(a){this.reprList.forEach(function(b){a&&b.setStructure(this.structure);b.rebuild(b.getParameters())},this)},rebuildTrajectories:function(){this.trajList.slice(0).forEach(function(a){a.trajectory.setStructure(this.structure)},this)},addRepresentation:function(a,b,c){var d=this.stage.preferences;b=b||{};b.quality=b.quality||d.getKey("quality");b.disableImpostor=
void 0!==b.disableImpostor?b.disableImpostor:!d.getKey("impostor");a=NGL.makeRepresentation(a,this.structure,this.viewer,b);b=new NGL.RepresentationComponent(this.stage,a,b,this);NGL.Component.prototype.addRepresentation.call(this,b);return c?b:this},addTrajectory:function(a,b,c){c={i:c};a=NGL.makeTrajectory(a,this.structure,b);a.signals.frameChanged.add(function(a){this.updateRepresentations({position:!0})},this);a=new NGL.TrajectoryComponent(this.stage,a,c,this);this.trajList.push(a);this.signals.trajectoryAdded.dispatch(a);
return a},removeTrajectory:function(a){var b=this.trajList.indexOf(a);-1!==b&&this.trajList.splice(b,1);a.dispose();this.signals.trajectoryRemoved.dispatch(a)},dispose:function(){this.trajList.slice().forEach(function(a){a.dispose()});this.trajList=[];NGL.Component.prototype.dispose.call(this)},centerView:function(a,b){var c;if(a){var d=new NGL.Selection(a);c=this.structure.atomCenter(d);b&&(b=this.structure.getBoundingBox(d).size().length())}else c=this.structure.center,b&&(b=this.structure.boundingBox.size().length());
this.viewer.centerView(c,b);return this},getCenter:function(){return this.structure.center},superpose:function(a,b,c,d,e,f){NGL.superpose(this.structure,a.structure,b,c,d,e,f);this.structure!==this.__structure&&NGL.superpose(this.__structure,a.structure,b,c,d,e,f);this.updateRepresentations({position:!0});return this},setVisibility:function(a){NGL.Component.prototype.setVisibility.call(this,a);this.trajList.forEach(function(b){b.setVisibility(a)});return this}});
NGL.SurfaceComponent=function(a,b,c){this.surface=b;this.name=b.name;NGL.Component.call(this,a,c)};NGL.SurfaceComponent.prototype=NGL.createObject(NGL.Component.prototype,{type:"surface",addRepresentation:function(a,b){var c=NGL.makeRepresentation(a,this.surface,this.viewer,b),c=new NGL.RepresentationComponent(this.stage,c,{},this);return NGL.Component.prototype.addRepresentation.call(this,c)},centerView:function(){this.viewer.centerView()}});
NGL.TrajectoryComponent=function(a,b,c,d){c=c||{};this.trajectory=b;this.name=b.name;this.parent=d;this.status="loaded";NGL.Component.call(this,a,c);b.signals.frameChanged.add(function(a){this.signals.frameChanged.dispatch(a)},this);b.signals.playerChanged.add(function(a){this.signals.playerChanged.dispatch(a)},this);b.signals.gotNumframes.add(function(a){this.signals.gotNumframes.dispatch(a)},this);void 0!==c.i&&this.setFrame(c.i)};
NGL.TrajectoryComponent.prototype=NGL.createObject(NGL.Component.prototype,{type:"trajectory",signals:Object.assign({frameChanged:null,playerChanged:null,gotNumframes:null,parametersChanged:null},NGL.Component.prototype.signals),addRepresentation:function(a,b){b=b||{};var c=NGL.makeRepresentation(a,this.trajectory,this.viewer,b),c=new NGL.RepresentationComponent(this.stage,c,{},this);return NGL.Component.prototype.addRepresentation.call(this,c)},setFrame:function(a){this.trajectory.setFrame(a)},setParameters:function(a){this.trajectory.setParameters(a);
this.signals.parametersChanged.dispatch(a);return this},dispose:function(){this.trajectory.dispose();NGL.Component.prototype.dispose.call(this)},getCenter:function(){}});NGL.ScriptComponent=function(a,b,c){this.script=b;this.name=b.name;this.status="loaded";NGL.Component.call(this,a,c);this.script.signals.nameChanged.add(function(a){this.setName(a)},this)};
NGL.ScriptComponent.prototype=NGL.createObject(NGL.Component.prototype,{type:"script",addRepresentation:function(a){},removeRepresentation:function(a){},run:function(){var a=this;this.setStatus("running");this.script.call(this.stage,function(){a.setStatus("finished")});this.setStatus("called")},dispose:function(){this.signals.disposed.dispatch()},setVisibility:function(a){},getCenter:function(){}});
NGL.RepresentationComponent=function(a,b,c,d){this.name=b.type;this.parent=d;NGL.Component.call(this,a,c);this.setRepresentation(b)};
NGL.RepresentationComponent.prototype=NGL.createObject(NGL.Component.prototype,{type:"representation",signals:Object.assign({visibilityChanged:null,colorChanged:null,parametersChanged:null},NGL.Component.prototype.signals),getType:function(){return this.repr.type},setRepresentation:function(a){this.repr&&this.repr.dispose();this.repr=a;this.name=a.type;this.updateVisibility()},addRepresentation:function(a){},removeRepresentation:function(a){},dispose:function(){this.parent&&this.parent.removeRepresentation(this);
this.repr.dispose();this.signals.disposed.dispatch()},setVisibility:function(a){this.visible=a;this.updateVisibility();this.signals.visibilityChanged.dispatch(this.visible);return this},updateVisibility:function(){this.parent?this.repr.setVisibility(this.parent.visible&&this.visible):this.repr.setVisibility(this.visible)},update:function(a){this.repr.update(a);return this},rebuild:function(a){this.repr.rebuild(a);return this},setStructure:function(a){this.repr.setStructure(a);return this},setParameters:function(a){this.repr.setParameters(a);
this.signals.parametersChanged.dispatch();return this},getParameters:function(){return this.repr.getParameters()},setColor:function(a){this.repr.setColor(a);this.signals.colorChanged.dispatch(this.repr.color);return this},getCenter:function(){}});
NGL.Examples={load:function(a,b){NGL.Examples.data[a](b)},add:function(a){Object.keys(a).forEach(function(b){NGL.Examples.data[b]=a[b]})},data:{trajectory:function(a){a.loadFile("__example__/md.gro",function(a){a.addRepresentation("line",{sele:"not hydrogen and sidechainAttached"});a.addRepresentation("cartoon",{sele:"protein"});a.centerView();a.addTrajectory("__example__/md.xtc")},{sele:"protein or na or cl"});a.loadFile("__example__/md.gro",function(a){a.addRepresentation("backbone",{sele:"protein",
color:"ss"})})},trr_trajectory:function(a){a.loadFile("__example__/md.gro",function(a){a.addRepresentation("line");a.addRepresentation("cartoon",{sele:"protein"});a.centerView();a.addTrajectory("__example__/md.trr")})},dcd_trajectory:function(a){a.loadFile("__example__/ala3.pdb",function(a){a.addRepresentation("licorice");a.addRepresentation("cartoon",{sele:"protein"});a.centerView();a.addTrajectory("__example__/ala3.dcd").setParameters({centerPbc:!1,removePbc:!1,superpose:!0})})},netcdf_trajectory:function(a){a.loadFile("__example__/DPDP.pdb",
function(a){a.addRepresentation("licorice");a.addRepresentation("cartoon",{sele:"protein"});a.centerView();a.addTrajectory("__example__/DPDP.nc").setParameters({centerPbc:!1,removePbc:!1,superpose:!0})})},anim_trajectory:function(a){a.loadFile("__example__/md.gro",function(a){a.addRepresentation("line",{sele:"not hydrogen and protein"});a.addRepresentation("cartoon",{sele:"protein"});a.centerView();var c=a.addTrajectory("__example__/md.xtc"),d=0,e=setInterval(function(){c.setFrame(d++%51);102<=d&&
clearInterval(e)},100)})},"3pqr":function(a){a.loadFile("__example__/3pqr.pdb",function(a){a.addRepresentation("cartoon",{sele:"1-320",wireframe:!1});a.addRepresentation("tube",{sele:"*",scale:.4});a.addRepresentation("rope",{sele:"*"},!0).setParameters({subdiv:2});a.addRepresentation("licorice",{sele:".C or .CA or .O"});a.centerView("320")})},"1blu":function(a){a.loadFile("__example__/1blu.pdb",function(a){a.addRepresentation("cartoon",{sele:"*"});a.addRepresentation("backbone",{sele:"*",scale:1,
aspectRatio:1.5,color:(new THREE.Color("lightgreen")).getHex()});a.addRepresentation("licorice",{sele:"*",scale:1});a.centerView()})},multi_model:function(a){a.loadFile("__example__/md_1u19_trj.gro",function(a){a.addRepresentation("cartoon",{sele:"*"});a.centerView();a.addTrajectory()},null,null,{asTrajectory:!0})},multi_struc:function(a){a.loadFile("__example__/1crn.pdb",function(a){a.addRepresentation("cartoon",{sele:"*"});a.addRepresentation("ball+stick",{sele:"hetero"});a.centerView()});a.loadFile("__example__/3pqr.pdb",
function(a){a.addRepresentation("cartoon",{sele:"*"});a.addRepresentation("ball+stick",{sele:"hetero"});a.centerView()})},superpose:function(a){a.loadFile("__example__/1u19.pdb",function(b){b.addRepresentation("cartoon",{sele:"1-320:A"});b.addRepresentation("ball+stick",{sele:"1-320:A"});a.loadFile("__example__/3dqb.pdb",function(a){a.addRepresentation("cartoon",{sele:"1-320:A"});a.addRepresentation("licorice",{sele:"1-320:A"});b.superpose(a,!1,"1-320:A");b.centerView(":A")},{sele:":A"})},{sele:":A"})},
alignment:function(a){a.loadFile("__example__/3dqb.pdb",function(b){b.addRepresentation("cartoon");b.addRepresentation("ball+stick",{sele:"hetero"});b.centerView();a.loadFile("__example__/3sn6.pdb",function(a){a.addRepresentation("cartoon");a.addRepresentation("ball+stick",{sele:"hetero"});NGL.superpose(b.structure,a.structure,!0);b.updateRepresentations();b.centerView()})})},alignment2:function(a){a.loadFile("__example__/1gzm.pdb",function(b){b.addRepresentation("cartoon");b.centerView();a.loadFile("__example__/1u19.pdb",
function(a){a.addRepresentation("cartoon");NGL.superpose(b.structure,a.structure,!0);b.updateRepresentations();b.centerView()})})},pbc:function(a){a.loadFile("__example__/pbc.gro",function(a){a.addRepresentation("cartoon",{sele:"backbone"});a.addRepresentation("spacefill",{sele:"backbone"});a.addRepresentation("line");a.centerView()})},xtc_parts:function(a){a.loadFile("__example__/md_1u19.gro",function(a){a.addRepresentation("cartoon");a.addRepresentation("line",{sele:"not hydrogen and sidechainAttached"});
a.centerView();a.addTrajectory("__example__/@md_1u19.xtc")})},impostor:function(a){a.loadFile("__example__/1crn.pdb",function(b){NGL.disableImpostor=!0;b.addRepresentation("ball+stick",{sele:"16"});a.centerView()})},cg:function(a){a.loadFile("__example__/BaceCg.pdb",function(a){a.addRepresentation("cartoon");a.addRepresentation("rope",{sele:"helix"});a.addRepresentation("ball+stick");a.centerView()})},ribosome:function(a){a.loadFile("__example__/4UPY.pdb",function(b){b.addRepresentation("cartoon",
{quality:"low"});b.addRepresentation("base");a.centerView()});a.loadFile("__example__/4UPX.pdb",function(b){b.addRepresentation("cartoon",{quality:"low"});b.addRepresentation("base");a.centerView()});a.loadFile("__example__/4UQ5.pdb",function(b){b.addRepresentation("cartoon",{quality:"low"});b.addRepresentation("base");a.centerView()});a.loadFile("__example__/4UPW.pdb",function(b){b.addRepresentation("cartoon",{quality:"low"});b.addRepresentation("base");a.centerView()})},ribosome2:function(a){a.loadFile("__example__/4UPY.pdb",
function(b){b.addRepresentation("line");a.centerView()});a.loadFile("__example__/4UPX.pdb",function(b){b.addRepresentation("line");a.centerView()});a.loadFile("__example__/4UQ5.pdb",function(b){b.addRepresentation("line");a.centerView()});a.loadFile("__example__/4UPW.pdb",function(b){b.addRepresentation("line");a.centerView()})},ribosome3:function(a){a.loadFile("__example__/4UPY.pdb",function(b){b.addRepresentation("trace");a.centerView()});a.loadFile("__example__/4UPX.pdb",function(b){b.addRepresentation("trace");
a.centerView()});a.loadFile("__example__/4UQ5.pdb",function(b){b.addRepresentation("trace");a.centerView()});a.loadFile("__example__/4UPW.pdb",function(b){b.addRepresentation("trace");a.centerView()})},selection:function(a){a.loadFile("__example__/1crn.pdb",function(a){a.addRepresentation("cartoon");a.addRepresentation("licorice",{sele:"not backbone or .CA or (PRO and .N)"});a.centerView()})},spline:function(a){a.loadFile("__example__/BaceCgProteinAtomistic.pdb",function(a){a.addRepresentation("cartoon",
{sele:"10-20"});a.addRepresentation("tube",{sele:"not 11-19",radius:.07,subdiv:25,radialSegments:25});a.addRepresentation("licorice",{sele:"sidechainAttached"});a.centerView()})},autoChainName:function(a){a.loadFile("__example__/Bace1Trimer-inDPPC.gro",function(a){a.addRepresentation("cartoon");a.addRepresentation("licorice",{sele:"DPPC"});a.centerView()},{sele:":A or :B or DPPC"})},script:function(a){a.loadFile("__example__/script.ngl")},bfactor:function(a){a.loadFile("__example__/1u19.pdb",function(a){a.addRepresentation("tube",
{sele:":A",visible:!1,bfactor:.005});a.addRepresentation("hyperball",{sele:":A",visible:!1,shrink:.3});a.addRepresentation("ball+stick",{sele:":A and sidechainAttached",visible:!0,aspectRatio:1.5});a.addRepresentation("cartoon",{sele:":A",visible:!0,scale:.3,aspectRatio:6});a.centerView(":A")})},"1d66":function(a){a.loadFile("__example__/1d66.pdb",function(a){a.addRepresentation("cartoon",{sele:"nucleic",wireframe:!1});a.addRepresentation("base",{sele:"*",color:"resname"});a.addRepresentation("licorice",
{sele:"nucleic",color:"element",visible:!1});a.centerView("nucleic")})},trajReprUpdate:function(a){a.loadFile("__example__/md_1u19.gro",function(b){var c=b.addRepresentation("spacefill",{sele:"1-30",color:52479,radius:2,scale:1});b.addRepresentation("ball+stick",{sele:"30-60"});b.addRepresentation("licorice",{sele:"60-90"});b.addRepresentation("hyperball",{sele:"90-120",color:"resname"});b.addRepresentation("line",{sele:"120-150"});b.addRepresentation("backbone",{sele:"150-180"});b.addRepresentation("tube",
{sele:"180-210"});b.addRepresentation("cartoon",{sele:"210-240"});b.addRepresentation("ribbon",{sele:"240-270"});b.addRepresentation("trace",{sele:"270-300"});b.centerView();b.addTrajectory("__example__/@md_1u19.xtc");(function(){var b=100,e=1;setInterval(function(){c.setScale(b/100);a.viewer.render();100===b?e=-1:10===b&&(e=1);b+=e},10)})},{sele:"not hydrogen"})},timing:function(a){console.time("test");a.loadFile("__example__/3l5q.pdb",function(a){a.addRepresentation("line",{color:"chainindex"});
a.addRepresentation("cartoon",{color:"chainindex"});a.centerView();console.timeEnd("test");console.time("render");a.viewer.render();console.timeEnd("render")})},capsid:function(a){console.time("test");a.loadFile("__example__/1RB8.pdb",function(b){b.addRepresentation("cartoon",{subdiv:3,radialSegments:6});b.addRepresentation("licorice");a.centerView()})},surface:function(a){a.loadFile("__example__/1crn.pdb",function(b){b.addRepresentation("cartoon");b.addRepresentation("ball+stick");a.viewer.setClip(42,
100);a.centerView()});a.loadFile("__example__/1crn.ply",function(a){a.addRepresentation(void 0,{transparent:!0,opacity:.3,side:THREE.DoubleSide})})},largeGro:function(a){console.time("test");a.loadFile("__example__/water.gro",function(b){b.addRepresentation("line",{color:"residueindex"});a.centerView();b.viewer.render();console.timeEnd("test")})},helixorient:function(a){a.loadFile("__example__/3dqb.pdb",function(a){a.addRepresentation("crossing",{ssBorder:!0,radius:.6});a.addRepresentation("rope",
{radius:.2});a.centerView()})},norovirus:function(a){a.loadFile("__example__/norovirus.ngl")},label:function(a){a.loadFile("__example__/1crn.pdb",function(b){b.addRepresentation("tube",{radius:"ss"});b.addRepresentation("ball+stick",{sele:"sidechainAttached"});b.addRepresentation("label",{sele:".CA",color:"element"});a.centerView()});a.loadFile("__example__/1crn.ply",function(a){a.addRepresentation(void 0,{transparent:!0,opacity:.3,side:THREE.FrontSide})})},cif:function(a){a.loadFile("__example__/3SN6.cif",
function(b){b.addRepresentation("cartoon",{radius:"ss"});a.centerView()})},"1crn":function(a){a.loadFile("__example__/1crn.pdb",function(b){b.addRepresentation("licorice");b.addRepresentation("point",{sele:"*",sizeAttenuation:!0,pointSize:12,sort:!0});a.centerView()})},decompress:function(a){a.loadFile("__example__/1CRN.cif.gz",function(b){b.addRepresentation("cartoon");a.centerView()});a.loadFile("__example__/1CRN.cif.zip",function(b){b.addRepresentation("licorice");a.centerView()});a.loadFile("__example__/1CRN.cif.lzma",
function(b){b.addRepresentation("rocket",{transparent:!0,opacity:.5});a.centerView()});a.loadFile("__example__/1CRN.cif.bz2",function(b){b.addRepresentation("rope",{scale:.3});a.centerView()})},hiv:function(a){a.loadFile("__example__/3j3y.cif.gz",function(a){a.addRepresentation("point",{color:"chainindex",pointSize:7,sizeAttenuation:!0});a.centerView()})}}};
